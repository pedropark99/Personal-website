<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>home |&gt; dplyr::glimpse()</title>
<link>https://pedro-faria.netlify.app/</link>
<atom:link href="https://pedro-faria.netlify.app/index.xml" rel="self" type="application/rss+xml"/>
<description>A blog about programming and data analysis, specially with R and Python</description>
<generator>quarto-1.5.57</generator>
<lastBuildDate>Sun, 16 Mar 2025 03:00:00 GMT</lastBuildDate>
<item>
  <title>Writing Spark DataFrames to Elasticsearch/Opensearch databases</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2025/2025-03-16-spark-elasticsearch/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Recently, I had to develop a simple connector (i.e.&nbsp;a Python function) that allows a user to upload/write data from a Spark DataFrame into both an Elasticsearch and an Opensearch database. If you are not familiar with Elasticsearch or Opensearch, they are both No-SQL databases. Which means that they are databases that store a collection of JSON documents, instead of storing a collection of tables as you would expect from a traditional SQL database like PostgreSQL.</p>
<p>Our data lake is processed by Apache Spark and Databricks, and some of the data that is being processed needs to be written into an Elasticsearch/Opensearch database, and it is best if we use the high scalability of Apache Spark to write this data. Thus, in this post, I want to describe how you can use the Spark to write data into these databases.</p>
<section id="why-this-post" class="level2">
<h2 class="anchored" data-anchor-id="why-this-post">Why this post?</h2>
<p>Just to be clear, I‚Äôm writing this post specially because the existing documentation about the connection between Spark and Elasticsearch/Opensearch is very, I mean, veeeery poor. Therefore, this post serves as an extra documentation, or, an extra resource that you can rely on when writing data from Spark into Elasticsearch/Opensearch.</p>
</section>
</section>
<section id="spark-native-data-sources" class="level1">
<h1>Spark native data sources</h1>
<p>If you want to write data from Spark fast and with high scalability, you want to use a Spark native data source to write your data. Maybe you don‚Äôt know what are Spark native data sources, so let‚Äôs discuss them now.</p>
<p>Spark data sources are described in details at the <a href="https://spark.apache.org/docs/3.5.3/sql-data-sources.html">Spark documentation</a>. Spark supports many different data sources out of the box. For example, it supports static files like CSV, JSON and Parquet files. But, you can also install Maven packages in your environment to use other data sources that were developed by the community.</p>
<p>For example, by installing the <code>spark-sql-kafka</code> Maven package<sup>1</sup>, a new Spark data source becomes available to you, which is the Kafka data source. With this data source, Spark supports streaming with Apache Kafka queues. Therefore, Spark supports multiple data sources out of the box, but you can add more data sources to the list by installing Maven packages that include new data sources to the Spark engine.</p>
<section id="selecting-a-data-source" class="level2">
<h2 class="anchored" data-anchor-id="selecting-a-data-source">Selecting a data source</h2>
<p>For example, if you are writing a Spark application through <code>pyspark</code>, you can choose the specific data source that you want to use in Spark by using the <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrameWriter.format.html#pyspark.sql.DataFrameWriter.format"><code>format()</code> method from a <code>DataFrameWriter</code> class</a>. In the example below, I‚Äôm using the JSON data source to write data from Spark into a JSON file.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spark.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-2">df.write.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'json'</span>)</span></code></pre></div>
</section>
<section id="elasticsearchopensearch-native-spark-data-sources" class="level2">
<h2 class="anchored" data-anchor-id="elasticsearchopensearch-native-spark-data-sources">Elasticsearch/Opensearch native Spark data sources</h2>
<p>Thankfully, both Elasticsearch and Opensearch have a free/open-source Spark native driver that we can use.</p>
<p>These drivers are both available as packages in the <a href="https://mvnrepository.com/">Maven repository</a>. If you want to write data to Elasticsearch, then, you are looking for the <code>elasticsearch-spark</code> package. But, if you want to write data to Opensearch instead, then, you are looking for the <code>opensearch-spark</code> package.</p>
<p>You can see more info about these packages in the links below:</p>
<ul>
<li><a href="https://mvnrepository.com/artifact/org.opensearch.client/opensearch-spark-30" class="uri">https://mvnrepository.com/artifact/org.opensearch.client/opensearch-spark-30</a>.</li>
<li><a href="https://mvnrepository.com/artifact/org.elasticsearch/elasticsearch-spark-30" class="uri">https://mvnrepository.com/artifact/org.elasticsearch/elasticsearch-spark-30</a>.</li>
</ul>
<p>Now, you need to use the specific version of these packages that match your specific environment. For my example, my environment is this:</p>
<ul>
<li>Databricks Runtime 15.4 LTS.</li>
<li>Apache Spark 3.5.0.</li>
<li>Scala 2.12.18.</li>
<li>Python 3.11.0.</li>
</ul>
<p>The version of Spark and Scala are the most important infos in this case. Since the version of Spark is 3.5.0, we want to use a version of these packages that are compatible with the 3.* versions of Spark, which are <code>opensearch-spark-30</code> and <code>elasticsearch-spark-30</code>.</p>
<p>And we also need to use a version of these packages that are compatible with the 2.12 version of Scala. This is why, I‚Äôve installed the <code>opensearch-spark-30_2.12</code> and <code>elasticsearch-spark-30_2.12</code> versions of these packages in my specific environment.</p>
<p>Your specific environment might have different versions, and, therefore, you might need to use a different version of these packages for your specific case. Just be aware of that.</p>
<p>In Databricks, you can install these Maven packages in your cluster to make these native Spark data sources available in your environment. If you don‚Äôt know how to do this, checkout the <a href="https://docs.databricks.com/aws/en/libraries/package-repositories#maven-or-spark-package">Databricks documentation</a> for this.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><a href="https://mvnrepository.com/artifact/org.apache.spark/spark-sql-kafka-0-10" class="uri">https://mvnrepository.com/artifact/org.apache.spark/spark-sql-kafka-0-10</a>‚Ü©Ô∏é</p></li>
</ol>
</section></div> ]]></description>
  <guid>https://pedro-faria.netlify.app/posts/2025/2025-03-16-spark-elasticsearch/en/</guid>
  <pubDate>Sun, 16 Mar 2025 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2025/2025-03-16-spark-elasticsearch/spark-elasticsearch-cover.webp" medium="image" type="image/webp"/>
</item>
<item>
  <title>Introduction to Zig: a project-based book</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/publications/book/zig-book/en/</link>
  <description><![CDATA[ 





<section id="about-the-book" class="level1">
<h1>About the book</h1>
<p>This is an open book that provides an introduction to the <a href="https://ziglang.org/">Zig programming language</a>, which is a new general-purpose, and low-level programming language for building robust and optimal software.</p>
<p><a href="https://www.amazon.com/dp/B0DJYMDRLP"> <button type="button" class="btn btn-primary">Buy the book!</button></a> <a href="https://pedropark99.github.io/zig-book/"> <button type="button" class="btn btn-primary">Read online</button></a> <a href="https://github.com/pedropark99/zig-book"> <button type="button" class="btn btn-primary">Official repository</button></a></p>
<p>This book is designed for both beginners and experienced developers. It explores the exciting world of Zig through small and simple projects (in a similar style to the famous ‚ÄúPython Crash Course‚Äù book from Eric Matthes). Some of these projects are: a Base64 encoder/decoder, a HTTP Server and an image filter.</p>
<p>As you work through the book, you will learn:</p>
<ul>
<li>The syntax of the language, and how it compares to C, C++ and Rust.</li>
<li>Data structures, memory allocators, filesystem and I/O.</li>
<li>Optionals as a new paradigm to handle nullability.</li>
<li>How to test and debug a Zig application.</li>
<li>Errors as values, and how to handle them.</li>
<li>How to build C and Zig code with the build system that is embedded into the language.</li>
<li>Zig interoperability with C.</li>
<li>Parallelism with threads and SIMD.</li>
<li>And more.</li>
</ul>
</section>
<section id="license" class="level1">
<h1>License</h1>
<p>This book is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0 Creative Commons Attribution 4.0 International Public License</a> , Copyright ¬© 2024 Pedro Duarte Faria.</p>
</section>
<section id="book-citation" class="level1">
<h1>Book citation</h1>
<p>You can use the following BibTex entry to cite this book:</p>
<pre><code>@book{pedro2024,
    author = {Pedro Duarte Faria},
    title = {Introduction to Zig},
    subtitle = {a project-based book},
    month = {October},
    edition = {1},
    year = {2024},
    address = {Belo Horizonte},
    url = {https://github.com/pedropark99/zig-book}
}</code></pre>
</section>
<section id="cover" class="level1">
<h1>Cover</h1>
<p><img src="https://pedro-faria.netlify.app/publications/book/zig-book/featured.png" class="img-fluid" style="width:100.0%"></p>


</section>

 ]]></description>
  <category>Zig</category>
  <category>Book</category>
  <category>Programming language</category>
  <guid>https://pedro-faria.netlify.app/publications/book/zig-book/en/</guid>
  <pubDate>Sat, 12 Oct 2024 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/publications/book/zig-book/featured.png" medium="image" type="image/png" height="207" width="144"/>
</item>
<item>
  <title>Introdu√ß√£o √† Linguagem R: seus fundamentos e sua pr√°tica</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/publications/book/introducao_linguagem_R/pt/</link>
  <description><![CDATA[ 





<section id="sobre-o-livro" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Sobre o livro</h1>
<p> <button type="button" class="btn btn-primary">Compre uma vers√£o do livro</button> <a href="https://pedropark99.github.io/Introducao_R/"> <button type="button" class="btn btn-primary">Leia online</button></a> <a href="./../exec_complete.pdf"> <button type="button" class="btn btn-primary">Exerc√≠cios de cada cap√≠tulo</button></a> <a href="./../respostas_complete.pdf"> <button type="button" class="btn btn-primary">Respostas dos exerc√≠cios</button></a></p>
<p>Este livro oferece uma descri√ß√£o profunda sobre os fundamentos da linguagem R, e como eles se aplicam no contexto da an√°lise de dados. Sua principal contribui√ß√£o para a literatura brasileira hoje, est√° no combate de dois problemas recorrentes nos materiais dispon√≠veis em portugu√™s sobre a linguagem: 1) a falta de profundidade de muitos materiais, que tentam abordar muitos assuntos em um espa√ßo muito curto; 2) a alta especializa√ß√£o de muitos materiais, que s√£o de dif√≠cil transposi√ß√£o para aplica√ß√µes gerais em an√°lises de dados.</p>
</section>
<section id="o-que-voc√™-aprende" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> O que voc√™ aprende ?</h1>
<p>Atrav√©s deste livro, voc√™ pode aprender sobre os fundamentos da linguagem R, e como eles se aplicam a √°rea de an√°lise de dados. Em mais detalhes:</p>
<ul>
<li><p><strong>Introduzindo a linguagem</strong>: aprenda sobre como definir e como trabalhar com objetos; conhe√ßa as estruturas e tipos de dados oferecidos pela linguagem; entenda como os processos de coer√ß√£o e os valores especiais da linguagem podem afetar os seus resultados.</p></li>
<li><p><strong>Importa√ß√£o e transforma√ß√£o</strong>: aprenda a importar, transformar e formatar suas tabelas atrav√©s dos pacotes <code>readr</code>, <code>readxl</code>, <code>haven</code>, <code>dplyr</code> e <code>tidyr</code>. Aplicando opera√ß√µes de ordena√ß√£o, filtro, sele√ß√£o e expans√£o, al√©m de opera√ß√µes de piv√¥ e <em>join</em>‚Äôs.</p></li>
<li><p><strong>Visualiza√ß√£o de dados</strong>: aprenda a utilizar o pacote <code>ggplot2</code> para produzir gr√°ficos elegantes e efetivos para apresentar os seus dados e as suas conclus√µes.</p></li>
<li><p><strong>Programando a sua an√°lise</strong>: aprenda a utilizar controles de fluxo, fun√ß√µes e <em>loops</em> para automatizar tarefas e solucionar os seus problemas de maneira simples e clara.</p></li>
<li><p><strong><em>Functional programming</em></strong>: aprenda a utilizar o pacote <code>purrr</code> para distribuir rapidamente os seus c√°lculos ao longo de m√∫ltiplos <em>inputs</em>.</p></li>
<li><p><strong><em>Debugging</em></strong> e <strong><em>environments</em></strong>: conhe√ßa as principais t√©cnicas de <em>debugging</em> existentes na linguagem R, e, aprenda como investigar erros em suas fun√ß√µes. Al√©m disso, entenda como a linguagem procura pelos seus objetos e, como voc√™ pode produzir resultados inesperados durante essa busca.</p></li>
</ul>
</section>
<section id="sec-versoes" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Compre uma vers√£o do livro</h1>
<p>Hoje, o livro est√° dispon√≠vel para compra em duas vers√µes: como ebook (Kindle), e como livro f√≠sico (Amazon, Estante Virtual e Clube dos Autores). Abaixo temos os links para todas essas vers√µes.</p>
<ul>
<li>Vers√£o ebook (<strong>Amazon</strong>): <a href="https://www.amazon.com.br/dp/B0D57F5Q1P" class="uri">https://www.amazon.com.br/dp/B0D57F5Q1P</a></li>
<li>Vers√£o f√≠sica (<strong>Amazon</strong>): <a href="https://www.amazon.com.br/dp/6500578724" class="uri">https://www.amazon.com.br/dp/6500578724</a></li>
<li>Vers√£o f√≠sica (<strong>Estante Virtual</strong>): <a href="https://www.estantevirtual.com.br/clube-de-autores/pedro-duarte-faria-introducao-a-linguagem-r-3850927716" class="uri">https://www.estantevirtual.com.br/clube-de-autores/pedro-duarte-faria-introducao-a-linguagem-r-3850927716</a></li>
<li>Vers√£o f√≠sica (<strong>Clube dos Autores</strong>): <a href="https://clubedeautores.com.br/livro/introducao-a-linguagem-r" class="uri">https://clubedeautores.com.br/livro/introducao-a-linguagem-r</a></li>
</ul>
<p>Caso voc√™ n√£o possa comprar uma vers√£o do livro, voc√™ ainda pode ler gratuitamente a obra completa atrav√©s de seu <a href="https://pedropark99.github.io/Introducao_R/">website</a>.</p>
</section>
<section id="formas-de-contribuir-para-o-livro" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Formas de contribuir para o livro</h1>
<p>Caso voc√™ queira contribuir monetariamente para o livro e para o autor, mas, n√£o queira/possa pagar o pre√ßo total da obra, voc√™ ainda pode mandar um <a href="https://pedro-faria.netlify.app/donate.html">PIX como uma doa√ß√£o</a>.</p>
<p>Al√©m disso, voc√™ tamb√©m pode contribuir com conte√∫do (imagens, cap√≠tulos, artes, etc.) diretamente para a obra, ao postar <em>pull requests</em> ou <em>issues</em> no <a href="https://github.com/pedropark99/Introducao_R">reposit√≥rio oficial do livro</a> no GitHub.</p>
</section>
<section id="citando-o-livro" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Citando o livro</h1>
<p>Arquivo BibTex:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>@book{pedro2024,
  title = {Introdu√ß√£o √† Linguagem R},
  subtitle = {seus fundamentos e sua pr√°tica},
  author = {Pedro Duarte Faria},
  year = {2024},
  edition = {5},
  address = {Belo Horizonte},
  month = {Junho},
  isbn = {978-65-01-03954-1},
  note = {https://pedro-faria.netlify.app/pt/publication/book/introducao_linguagem_r/}
}</code></pre>
</div>
</div>
</section>
<section id="capa-do-livro" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Capa do livro</h1>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/publications/book/introducao_linguagem_R/featured.jpg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>Book</category>
  <category>Brazil</category>
  <guid>https://pedro-faria.netlify.app/publications/book/introducao_linguagem_R/pt/</guid>
  <pubDate>Sat, 25 May 2024 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/publications/book/introducao_linguagem_R/featured.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Running an AI ChatBot locally</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2024/2024-03-13-llm-locally/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Despite the current success of AI assistants (such as ChatGPT), privacy and information security might represent barriers for very large adoption of the technology among some specific users and corporations. Because either they do not want to share the information, or they are legally bound to not share it with other companies, such as OpenAI, Meta and Microsoft.</p>
<p>In other words, to use an AI assistant, you might need to provide key-information in your prompt, but you might not want (or might not be authorized) to share this key-information with this AI service. So the privacy aspect involved in the use of AI assistants might become a ‚Äúdeal-breaker‚Äù for these users/corporations.</p>
<p>Banks for example, are usually very careful with sharing sensible user-information with anyone. As a consequence, for example, using OpenAI services might be a deal-breaker for this bank, because the bank cannot share user-information with OpenAI in any circumstance. The bank could be exposed to legal penalties otherwise.</p>
<p>In this situation, it might be a good idea for the bank, to host and run the AI assistant inside their own infrastructure, on a very restrict and secure place. So, in other words, this bank would host and run it‚Äôs own ChatGPT on their own servers.</p>
<p>This article explain how you can download and use LLMs (Large Language Models) locally on your own machine, with <a href="https://ollama.com/">Ollama</a>. By knowing how to run a LLM model locally in your own machine, you can apply this knowledge to run a LLM model anywhere you want, on your own servers and private services.</p>
</section>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>In essence, running a LLM model locally in your machine, consists of following these steps:</p>
<ul>
<li>Make sure to download the LLM model you want to use.</li>
<li>Make sure that the Ollama server is up and running.</li>
<li>Send your prompt to the local API, and get the response back.</li>
</ul>
</section>
<section id="introducing-ollama" class="level1">
<h1>Introducing Ollama</h1>
<p>Ollama is a command line util that helps you download, manage and use LLM models. It is almost like a package manager, but for LLM models.</p>
<p>The success of LLM models were so big that scientists, companies, and the general community developed and trained many different LLM models, and made them publicly available, either at <a href="https://github.com/">GitHub</a>, or at <a href="https://huggingface.co/">HuggingFace</a>.</p>
<p>So, in other words, the infrastructure and the technology behind AI services is very monopolized right now, with big corporations (OpenAI, Meta, Microsoft, etc.). But the LLM technology per se, is rather accesible and widespread.</p>
<p>Now, we can easily download and use these models through Ollama. The complete list of LLM models available is large, and you can see the full list at the <a href="https://ollama.com/library">Models page of Ollama‚Äôs website.</a></p>
<p>In order to use Ollama, you have to download and install it. By <a href="https://ollama.com/">visiting Ollama‚Äôs website</a> you will find instructions to install it in each OS.</p>
<p>After you download and install, you can start to use <code>ollama</code> in the command line of your OS. There are two main commands in <code>ollama</code>, which are:</p>
<ul>
<li><code>pull</code>: downloads a LLM model.</li>
<li><code>serve</code>: starts the LLM model as a HTTP server.</li>
<li><code>run</code>: run a LLM model with an input prompt.</li>
</ul>
<section id="download-a-model" class="level2">
<h2 class="anchored" data-anchor-id="download-a-model">Download a model</h2>
<p>First, we need to download the LLM model we want to use, so that is locally available to use in our machine. You do this by using the <code>pull</code> command.</p>
<p>For the examples in this article, I will be using the CodeLlama model, which is based on the Llama 2 model. More specifically, the version of the model with 7 billions of parameters. It is a LLM model refined and tuned for code related questions and assignments.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ollama</span> pull codellama:7b</span></code></pre></div>
</section>
<section id="llm-models-are-very-heavy-and-expensive-to-run" class="level2">
<h2 class="anchored" data-anchor-id="llm-models-are-very-heavy-and-expensive-to-run">LLM models are very heavy and expensive to run</h2>
<p>In general, LLM models are very heavy and expensive to run, and they do not scale particularly well. So to make services like ChatGPT, that serves millions of users everyday, the actual LLM model, or the actual ChatGPT that answers your questions, is running on a big data center, more specifically, on a very (I mean, VERY) expensive and powerful set of GPUs (with hundreds and hundreds of VRAM available to use).</p>
<p>All of this means that, not every machine is capable of running a LLM model. Specially if your machine does not have a good GPU card in it. So, if you want to run a LLM model on a ‚Äúweak machine‚Äù, always choose the smallest version possible of a LLM model.</p>
<p>A commom way to classifying LLM models is measuring them by their size. The size of a LLM model is normally measured by the number of parameters of the model, and they are normally in the level of billions of parameters. So a LLM model usually have 1, 7, 20, 50, 100 billions parameters.</p>
<p>In Ollama, you choose the version of the model with the number of the parameters you want, by writing a colon followed by the number of parameters you want. So the text <code>&lt;name of model&gt;:20b</code> represents the version of a model with 20 billion parameters.</p>
<p>In my example here, I am running on very standard laptop, literally nothing fancy. It has 12GB RAM, and a normal Intel i5 Core CPU. And it does not have any GPU card installed.</p>
<p>Because of that, I do not want to select a very large model. I want to choose the smallest model as possible, with the smallest number of parameters. That is why I choose specifically the version of CodeLlama with 7 billion parameters - <code>codellama:7b</code> (there are different versions of CodeLlama that go up to 70 billion parameters).</p>
<p>So, you should take the power of your machine in consideration when choosing your LLM model.</p>
</section>
<section id="prompt-your-llm-model" class="level2">
<h2 class="anchored" data-anchor-id="prompt-your-llm-model">Prompt your LLM model</h2>
<p>Let‚Äôs quickly use our LLM model. You can simply run the LLM model with an input prompt, by using the <code>run</code> command of <code>ollama</code>.</p>
<p>For example, I can ask CodeLlama to write me a Python function that outputs the fibonacci sequence, like this:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ollama</span> run codellama:7b <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Write me a Python function that outputs the fibonacci sequence"</span></span></code></pre></div>
<p>This is the output I get:</p>
<pre><code>[PYTHON]
def fibonacci(n):
    if n &lt;= 1:
        return n
    else:
        return fibonacci(n-1) + fibonacci(n-2)
[/PYTHON]
[TESTS]
# Test case 1:
assert fibonacci(0) == 0
# Test case 2:
assert fibonacci(1) == 1
# Test case 3:
assert fibonacci(2) == 1
# Test case 4:
assert fibonacci(3) == 2
# Test case 5:
assert fibonacci(4) == 3
# Test case 6:
assert fibonacci(5) == 5
# Test case 7:
assert fibonacci(6) == 8
# Test case 8:
assert fibonacci(7) == 13
# Test case 9:
assert fibonacci(8) == 21
# Test case 10:
assert fibonacci(9) == 34
[/TESTS]</code></pre>
</section>
<section id="start-your-llm-model-as-a-http-server" class="level2">
<h2 class="anchored" data-anchor-id="start-your-llm-model-as-a-http-server">Start your LLM model as a HTTP server</h2>
<p>In Ollama, you can use your LLM model as a HTTP server. You start the server, and send input prompts to it. This server will response you back, with the output of the LLM model.</p>
<p>Fist, you start the server with the <code>serve</code> command:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ollama</span> serve</span></code></pre></div>
<p>After that, the endpoint <code>'api/generate'</code> become available at port 11434 in localhost.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb5-2">url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'http://localhost:11434/api/generate'</span></span>
<span id="cb5-3">body <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'{"model": "codellama:7b", "prompt": "Write me a Python function that outputs the fibonacci sequence"}'</span></span>
<span id="cb5-4">r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.post(url, data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> body)</span>
<span id="cb5-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(r.content))</span></code></pre></div>
<pre><code>b'{"model":"codellama:7b","created_at":"2024-03-18T14:45:08.92502Z","response":"\\n","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:09.4067275Z","response":"[PY","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:09.6486965Z","response":"TH","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:09.8871347Z","response":"ON","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:10.1047816Z","response":"]","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:10.3401777Z","response":"\\n","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:10.5807352Z","response":"def","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:10.8011125Z","response":" fib","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:11.0347653Z","response":"on","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:11.2923311Z","response":"acci","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:11.5700897Z","response":"(","done":false}\n
{"model":"codellama:7b","created_at":"2024-03-18T14:45:11.8455609Z","response":"n","done":false}\n
... truncated output</code></pre>
<p>We can see above that we get a JSON-like type of response from the API, with the contents produced by the LLM model inside the element <code>"response"</code> in each JSON object.</p>
<p>We can parse this JSON response from the API, and collect all the <code>"response"</code> elements to form the full text produced by the LLM model.</p>
<p>Using the same URL and HTTP Request Body, I could parse the HTTP Response using something similar to this. You can see in the example below, that we get the exact same result as we got when we executed the LLM model through the <code>run</code> command of <code>ollama</code>:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json</span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> parse_response(resp: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb7-5">    resp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> resp.content.decode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span>)</span>
<span id="cb7-6">    resp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'\}\n\{'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'},</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">{'</span>, resp)</span>
<span id="cb7-7">    resp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>resp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">]'</span></span>
<span id="cb7-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> json.loads(resp)</span>
<span id="cb7-9"></span>
<span id="cb7-10">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.post(url, data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> body)</span>
<span id="cb7-11">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parse_response(response)</span>
<span id="cb7-12">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb7-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> token <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response:</span>
<span id="cb7-14">    tokens.append(token[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>])</span>
<span id="cb7-15"></span>
<span id="cb7-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(tokens))</span></code></pre></div>
<pre><code>[PYTHON]
def fibonacci(n):
    if n &lt;= 1:
        return n
    else:
        return fibonacci(n-1) + fibonacci(n-2)
[/PYTHON]
[TESTS]
# Test case 1:
assert fibonacci(0) == 0
# Test case 2:
assert fibonacci(1) == 1
# Test case 3:
assert fibonacci(2) == 1
# Test case 4:
assert fibonacci(3) == 2
# Test case 5:
assert fibonacci(4) == 3
# Test case 6:
assert fibonacci(5) == 5
# Test case 7:
assert fibonacci(6) == 8
# Test case 8:
assert fibonacci(7) == 13
# Test case 9:
assert fibonacci(8) == 21
# Test case 10:
assert fibonacci(9) == 34
[/TESTS]</code></pre>
</section>
</section>
<section id="going-further" class="level1">
<h1>Going further</h1>
<p>You can now start to develop this new knowledge you acquired in this article. Going further in your AI journey.</p>
<p>For example, you can:</p>
<ul>
<li>test different LLM models, by downloading new models with <code>ollama pull</code>.</li>
<li>deploy and run Ollama on a cloud environment with specialized infrastructure (like <a href="https://aws.amazon.com/ec2/instance-types/p4/?nc1=h_ls">P4 instances in Amazon EC2</a>).</li>
<li>use an AI app framework, such as LangChain, to build an AI app that uses Ollama.</li>
</ul>


</section>

 ]]></description>
  <guid>https://pedro-faria.netlify.app/posts/2024/2024-03-13-llm-locally/en/</guid>
  <pubDate>Sat, 16 Mar 2024 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2024/2024-03-13-llm-locally/chatgpt.webp" medium="image" type="image/webp"/>
</item>
<item>
  <title>Producing evenly-spaced and non-overlapping curves with Jobard-Lefer Algorithm in C</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>I‚Äôm currently writing a book about R and Graphics (stay tuned for more news about this book soon üòâ). During my research for this book, I had to study a relatively famous and established algorithm, called as the Jobard-Lefer algorithm. It is an algorithm for producing evenly spaced curves in a flow field (or a vector field). This algorithm is thoroughly described in a scientific paper <span class="citation" data-cites="jobard97">(Jobard and Lefer 1997)</span>.</p>
<p>In this article, I want to describe how you can implement this algorithm in C. These are the topics we are going to discuss:</p>
<ul>
<li>What are flow fields (or vector fields)?</li>
<li>How to draw curves in a flow field?</li>
<li>What the algorithm does?</li>
<li>How does it work?</li>
<li>How to implement it in C?</li>
</ul>
</section>
<section id="what-are-flow-fields-or-vector-fields" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> What are flow fields (or vector fields)?</h1>
<p>A flow field (which is also called a vector field in some ocasions) is essentially a field (or a two-dimensional grid) of angles. Figure&nbsp;1 shows an example of a flow field:</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-flow-field1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-flow-field1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/en/index_files/figure-html/fig-flow-field1-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-flow-field1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: An example of flow field
</figcaption>
</figure>
</div>
</div>
</div>
<p>In more details, a flow field is usually represented as a 2D (two-dimensional) grid, or a 2D matrix of angle values. So each element in this matrix is a real number, and this real number is interpretd as an angle value (in the radians scale). This 2D matrix of angle values is usually produced by a Perlin Noise algorithm <span class="citation" data-cites="perlin">(Wikipedia 2024a)</span>, or a similar algorithm, like the Simplex Noise algorithm <span class="citation" data-cites="simplex">(Wikipedia 2024b)</span>.</p>
<p>In other words, the numbers in the 2D matrix are normally random numbers. But you cannot use any random number generator to produce them. You must use a 2D (or two-dimensional) noise algorithm to produce these random numbers.</p>
<p>Just to give you a very brief example, you can build a flow field in C, by using the <a href="https://github.com/Auburn/FastNoiseLite"><code>FastNoiseLite</code> library</a>. In this library, you have multiple algorithms you can use for producing two-dimensional noise.</p>
<p>Despite the many options, I will use as an example in this article, the classic Perlin Noise algorithm for producing the flow field. You can see in the snippet below that I am building a flow field with 120 of width and height. In other words, we have a 120x120 grid of angle values.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;math.h&gt;</span></span>
<span id="cb1-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdlib.h&gt;</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define FNL_IMPL</span></span>
<span id="cb1-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">"FastNoiseLite.h"</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define FLOW_FIELD_WIDTH </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span></span>
<span id="cb1-8"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define FLOW_FIELD_HEIGHT </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span></span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-11">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> flow_field<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>FLOW_FIELD_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>FLOW_FIELD_HEIGHT<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb1-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Create and configure noise state</span></span>
<span id="cb1-13">    fnl_state noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fnlCreateState<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-14">    noise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-15">    noise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>noise_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FNL_NOISE_PERLIN<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-16">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> FLOW_FIELD_HEIGHT<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> FLOW_FIELD_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-19">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Scale each value to the radians scale by</span></span>
<span id="cb1-20">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// multiplying each value by 2PI.</span></span>
<span id="cb1-21">            flow_field<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fnlGetNoise2D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>noise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> M_PI<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-22">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="sec-draw-curve" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> How to draw curves in a flow field?</h1>
<p>Flow fields have multiple applications in computer graphics. For example, you can use them to draw interesting (or ‚Äúvery pleasing looking‚Äù) curves.</p>
<p>The basic idea is to draw a curve by walking across the flow field. First, we choose a point in the flow field as our starting point, and then, we start to walking by following the direction of the angles we encounter in the flow field. As we walk trough the flow field, we record the x and y coordinates of our positions. When we finish walking, we can draw a curve by ‚Äúconnecting the dots‚Äù, i.e.&nbsp;connecting the points (x and y coordinates) that we passed through.</p>
<p>So, in essence, the steps for drawing a curve in a flow field are:</p>
<ol type="1">
<li>Choose a starting point in the grid.</li>
<li>Look at the angle that is stored in the position of the grid that you are currently in.</li>
<li>Take a step in the direction of that angle.</li>
<li>Recalculate your current position in the grid, and record/store this position for later use.</li>
<li>Comeback to step 2.</li>
</ol>
<p>You can see in the bullet points above that, we begin a loop at step 5. We are repeatedly taking a step in the direction of an angle, recalculating our current position in the flow field, and taking another step in the direction of another angle. As long as we stay inside the boundaries of the flow field, we can repeat this pattern as much as we want to.</p>
<p>The Figure&nbsp;2 below shows the end result of this process. In this example, we begin in coordinate <img src="https://latex.codecogs.com/png.latex?(5,%2010)">, i.e.&nbsp;<img src="https://latex.codecogs.com/png.latex?x%20=%205"> and <img src="https://latex.codecogs.com/png.latex?y%20=%2010">, in the field, and take 45 sequential steps in the field by following the direction of the angles we encounter in the way. The curve painted in red shows the end result of this ‚Äúwalking process‚Äù.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-flow-field2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-flow-field2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/en/index_files/figure-html/fig-flow-field2-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-flow-field2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Drawing a curve in the flow field
</figcaption>
</figure>
</div>
</div>
</div>
<p>As you walk trough the flow field, the angle that you currently using might lead you to a position that is off the boundaries of the flow field. In that case, you should stop walking, before you go off the flow field. Because if you pass the boundaries of the flow field, then, the lookup process we perform to take an angle in the flow field, will fail.</p>
<p>Two important variables need to be defined to draw your curve:</p>
<ul>
<li>The number of steps you want to take.</li>
<li>The distance of each step (or ‚Äústep length‚Äù).</li>
</ul>
<p>First is the number of steps you want to take in your walk. You can definetly set this to infinity, so you walk indefinitely until you hit one of the boundaries of the flow field. But you normally do not want to walk indefinitely. Because this usually produces a very long curve that goes across the entire flow field.</p>
<p>Yes! You might want to draw a very long curve. As you probably notice, this is very subjective to each person and their objective. But for the most part, you usually do not have to set this number of steps too much high. Around 30-40 steps is a good range for those who doesn‚Äôt know what they want.</p>
<p>Therefore, the number of steps directly affects the length of the curve that you are drawing. If you take a high number for steps , the curve will be longer. In contrast, if you take just few steps, your curve will be shorter.</p>
<p>Second is the distance you will take in each step (let‚Äôs call it as the ‚Äústep length‚Äù). The step length affects how ‚Äúsharp‚Äù the curve looks. If you set the step length correctly, the curve will look nice, very ‚Äúcurvy‚Äù. In other words, the curve will look like an actual curve. But if you set the step length too high, then, the ‚Äúconnect the dots‚Äù effects will be much more appearant. In other words, your curve will not look like a curve, and more like an attempt to draw a polygon with very sharp edges.</p>
<p>But be careful to also not set the step length too low. If you set it very very low, then, you will end up affecting the length of the curve as well. Because the step length is soo low, that even if you set the number of steps very high, you still get a very short curve as a result. This is bad because you will be tempted to raise the number of steps even higher, and by setting the number of steps too high, you end up increasing the overhead and computing time of the algorithm.</p>
<p>I mean, increasing the number of steps from 10 to 1000 for drawing a single curve into the field is fine. But when you raise the number of steps to 1000 when you are drawing like 10000 curves into field, then you will notice the overhead very quickly. So, if you want your algorithm to perform well, and still get nice and visually attractive curves in the output, you usually want to set the step length to a number that is in the range from 0.1% to 1% of the flow field width.</p>
<p>In C, you can represent a curve with the struct <code>Curve</code> below. You can see below that I am dynamically allocating space to store the x and y coordinates that compose this curve.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define N_STEPS </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Curve <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">typedef</span> Curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-8"></span>
<span id="cb2-9">Curve curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-10">curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-11">curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N_STEPS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb2-12">curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N_STEPS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span></code></pre></div>
<p>Also, the C snippet below translates the steps I described above to draw a curve into the field. You can see in this code that our current position in the Cartesian plane is mapped to a specific position in the flow field, or, in other words, to a position in the 2D matrix of angles, by transforming our current x and y positions into integers.</p>
<p>So for example, if our current position in the Cartesian plane is <img src="https://latex.codecogs.com/png.latex?x%20=%2045.289"> and <img src="https://latex.codecogs.com/png.latex?y%20=%2021.556">, then, our current position in the flow field is <img src="https://latex.codecogs.com/png.latex?x%20=%2045"> and <img src="https://latex.codecogs.com/png.latex?y%20=%2021">. So, the current angle that we need to retrieve and use from the flow field, is the angle that is stored in the element <code>angles[45][21]</code> of the matrix.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define STEP_LENGTH </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> FLOW_FIELD_WIDTH</span></span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> off_boundaries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> limit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb3-5">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span></span>
<span id="cb3-6">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span></span>
<span id="cb3-7">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> limit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span></span>
<span id="cb3-8">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> limit</span>
<span id="cb3-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N_STEPS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-13">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ff_column_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> floor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-14">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ff_row_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> floor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-15"></span>
<span id="cb3-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>off_boundaries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ff_column_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ff_row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> FLOW_FIELD_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-18">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-19"></span>
<span id="cb3-20">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> flow_field<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>ff_row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>ff_column_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb3-21">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> STEP_LENGTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-22">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> STEP_LENGTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-23">  x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-24">  y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-25"></span>
<span id="cb3-26">  curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-27">  curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-28"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Furthermore, this C code uses a pair of equations from geometry (Equation&nbsp;1 and Equation&nbsp;2) to calculate the new x and y coordinates after I take the step by following the direction of the current angle. These equations are normally used to calculate the coordinates in the circumference of a circle centered at the origin point of the Cartesian plane, and they are exposed below.</p>
<p>Given that a circle that is centered at the origin point of the Cartesian plane, and that <img src="https://latex.codecogs.com/png.latex?r"> is the radius of the circle, and that <img src="https://latex.codecogs.com/png.latex?A"> is the angle, in radians, that identifies the position in the circumference that you are trying to calculate it‚Äôs coordinates, you can calculate the x (<img src="https://latex.codecogs.com/png.latex?x'">) and y (<img src="https://latex.codecogs.com/png.latex?y'">) coordinates of the corresponding position in the circumference by using the following pair of equations:</p>
<p><span id="eq-rotation1"><img src="https://latex.codecogs.com/png.latex?%0Ax'=r%5Ctimes%20%5Ccos(A)%0A%5Ctag%7B1%7D"></span></p>
<p><span id="eq-rotation2"><img src="https://latex.codecogs.com/png.latex?%0Ay'=r%5Ctimes%20%5Csin(A)%0A%5Ctag%7B2%7D"></span></p>
</section>
<section id="the-jobard-lefer-algorithm" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> The Jobard-Lefer algorithm</h1>
<p>When you start to draw multiple curves in the flow field, without caring where these curves are placed and where they go, eventually, you will end up with a very dense image, with many curves overlapping each other. Some people are intentionally trying to produce such dense images, because they want the interesting depth effect that these images normally have around the curves.</p>
<p>But sometimes, you are really trying to avoid that. Sometimes, you want to meet all of these criterias below at the same time:</p>
<ul>
<li>draw a high number of curves (i.e.&nbsp;a number that is high enough to ‚Äúfill‚Äù the image) in the field.</li>
<li>draw only non-overlapping curves.</li>
<li>draw curves that are ‚Äúevenly-spaced‚Äù between each other.</li>
</ul>
<p><span class="citation" data-cites="jobard97">Jobard and Lefer (1997)</span> proposes an algorithm that produces non-overlapping and evenly-spaced curves around a flow field. If you read the paper carefully, you might notice that you can divide this algorithm into two separate parts. Splitting this algorithm into two separate is very useful for the objective of this article. Because is easier to explain how each part works separately, than to trying to explain the entire algorithm at once.</p>
<p>These two parts are:</p>
<ul>
<li>An algorithm to draw non-overlapping curves.</li>
<li>An algorithm to select new start points for new curves.</li>
</ul>
<p>First, I will focus on the first part of the algorithm, and, after explaining how this first part works, it will be a little easier for you to understand how the second part works.</p>
</section>
<section id="drawing-non-overlapping-curves" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Drawing non-overlapping curves</h1>
<p>This first part of the algorithm is the part that makes sure that only non-overlapping curves are drawn to the field. The idea behind it, is that we are constantly checking the distances between our next position and the other curves around us. We want to always make sure that the current curve is far enough from the other curves, and, if not, stop drawing this curve.</p>
<p>This specific part of the algorithm works around a constant value, that represents the minimum distance allowed between two curves. <span class="citation" data-cites="jobard97">Jobard and Lefer (1997)</span> call this value as <img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D">, or, as the ‚Äúseparating distance‚Äù. The end result of the algorithm is that any point in any curve in the field is, at least, at a distance of <img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D"> units from any other point from another curve in the field.</p>
<p>If you use this part of the algorithm, you normally produce some very nice and ‚Äúpleasing to the eyes‚Äù type of images. At Figure&nbsp;3, I am showing the difference that this part of the algorithm makes to the image. In both subfigures, we used the same colors for each curve, the same starting points for each curve, the same step length, the same number of steps, same flow field, etc. Anymway, all the configs used in both images are literally the same. The only difference between these two images, is the use (or not) of this ‚Äúnon-overlaping‚Äù curve algorithm.</p>
<p>In the first image (without the Jobard-Lefer algorithm) I simply drawn the curves using the steps I described at Section&nbsp;3, without caring if the curves were overlapping (or, if they were too close to) each other. In contrast, in the second image, I used the first part of the Jobard-Lefer algorithm to draw the curves while checking if they were overlapping (or, if they were too close to) each other.</p>
<div id="fig-diff-algorithm" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-diff-algorithm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-diff-algorithm" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-diff-overlap" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-diff-overlap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/overlap.png" class="img-fluid figure-img" data-ref-parent="fig-diff-algorithm">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-diff-overlap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Without Jobard-Lefer algorithm
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-diff-algorithm" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-diff-non-overlap" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-diff-non-overlap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/non_overlap.png" class="img-fluid figure-img" data-ref-parent="fig-diff-algorithm">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-diff-non-overlap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) With Jobard-Lefer algorithm
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-diff-algorithm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Demonstrating the effect of the Jobard-Lefer algorithm on curves drawn in the field
</figcaption>
</figure>
</div>
<section id="how-this-part-of-the-algorithm-works" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="how-this-part-of-the-algorithm-works"><span class="header-section-number">5.1</span> How this part of the algorithm works?</h2>
<p>In essence, at each step we take while drawing our curve, we look at the curves that are around us, and we compare the distance between our next step and all of these neighboring curves. If this distance between is lower or equal to the separating value (<img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D">), then, we do not take the next step, and we stop drawing the current line.</p>
<p>Notice that we are still using the exact same steps I described at Section&nbsp;3 to draw the curves into the field. We are still start with a starting point, then, we start to take sequential steps by following the direction of the angles we encounter through the field.</p>
<p>However, the key difference here, is that we added a new step, or new check to these previous steps. Now, while we are walking through the field, we are constantly calculating distances, and checking these distances to make sure that we are not too close to a neighbour curve.</p>
<p>Figure&nbsp;4 demonstrates this process visually. And I know what you are thinking! ‚ÄúThese curves in Figure&nbsp;4 doesn‚Äôt look like curves!‚Äù. Just remember the steps I described at Section&nbsp;3. We are essentially drawing curves by connecting the positions where we walked through. Is like I applied a very big zoom over the image while the algorithm is actively drawing the curves.</p>
<p>So, at a very low scale, the curves we are drawing are not really curves at all. But at a normal scale, when we zoom out of the image, and look to the image with our own human eyes, the steps are so small, so small, that we cannot perceive the connected dots. The curve effectivelly looks very much like a nice and fluid curve.</p>
<p>In the example of Figure&nbsp;4, we have one already existing curve (in blue), and we are currently drawing a second curve into the field. At each step, we calculate the coordinates of the next step we need to make, them, we compare the distance between the position of this next step, and the points from other curves that are close by. If this distance between this next step and any point from the surrounding curves is lower or equal than <img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D">, we ‚Äúcancel‚Äù the next step, and we stop drawing the current curve.</p>
<div id="fig-even-algo" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-even-algo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/distance.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-even-algo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: The steps to check if the current curve is too close to a neighbour
</figcaption>
</figure>
</div>
<p>To calculate the distance between two points in the Cartesian plane, we use another equation from geometry, which is commonly know as the ‚Äúdistance formula‚Äù:</p>
<p><span id="eq-distance"><img src="https://latex.codecogs.com/png.latex?%0Ad%20=%20%5Csqrt%7B%5B(x_2%20-%20x_1)%5E2%20+%20(y_2%20-%20y_1)%5E2%5D%7D%0A%5Ctag%7B3%7D"></span></p>
<p>The function <code>distance()</code> below translates this Equation&nbsp;3 into a C function.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> distance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> s2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="the-density-grid" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="the-density-grid"><span class="header-section-number">5.2</span> The density grid</h2>
<p>I think this specific section of the paper is a little confusing. But if I did understand the authors correctly, then, at each step we take in the field, the Jobard-Lefer algorithm takes the coordinate of out next step, and calculates the distance between this point and <strong>all of the points that are near by and that belongs to others (already existing) curves</strong>.</p>
<p>To find the points that are near by, the algorithm uses a second Cartesian grid that is superposed over the Cartesian plane that our flow field lives. In other words, it uses a second Cartesian plane that uses a different scale, accordingly to the ‚Äúseparating distance‚Äù (<img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D">). <span class="citation" data-cites="jobard97">Jobard and Lefer (1997)</span> call this second Cartesian grid as the ‚Äúdensity grid‚Äù.</p>
<p>So every coordinate in the Cartesian plane can be mapped to a specific position in the density grid. You do that by scaling the x and y coordinates in the Cartesian to fit the scale used in the density grid. As an example, let‚Äôs consider a Cartesian plane that is 100x100.</p>
<p>For example, if you have an x and y coordinates in the flow field, and you want to calculate the corresponding position in the density grid for this specific coordinate, you can use the functions <code>get_density_col()</code> and <code>get_density_row()</code> exposed below:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> get_density_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> get_density_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>At Figure&nbsp;5, we are using as an example, a Cartesian plane with dimensions 100x100. With <img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D%20=%202">, the corresponding density grid becomes a Cartesian grid with dimensions 50x50. You can see at Figure&nbsp;5 (b) that, the density grid is a grid of <img src="https://latex.codecogs.com/png.latex?50%20%5Ctimes%2050%20=%202500"> cells. Each cell have width and height equal to <img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D">. In <span class="citation" data-cites="jobard97">Jobard and Lefer (1997)</span> paper, these cells are called ‚Äúdensity cells‚Äù.</p>
<p>The functions <code>get_density_col()</code> and <code>get_density_row()</code> always return an integer value as output. Because they calculate the coordinates of the density cell in which the original coordinate in the Cartesian plane is mapped to.</p>
<p>So a single cell in the density grid can contain multiple points from the Cartesian plane where the flow field lives. Or, on the other side, you can say that multiple points in the Cartesian plane can be mapped to the same cell in the density grid.</p>
<p>In the example of Figure&nbsp;5, the coordinate <img src="https://latex.codecogs.com/png.latex?x%20=%2042.312"> and <img src="https://latex.codecogs.com/png.latex?y%20=%2072.112"> is mapped to the cell at position <img src="https://latex.codecogs.com/png.latex?x%20=%2022"> and <img src="https://latex.codecogs.com/png.latex?y%20=%2037"> in the density grid.</p>
<div id="fig-cartesian-grid" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cartesian-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cartesian-grid" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-cartesian1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-cartesian1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/cartesian_plane.png" class="img-fluid figure-img" data-ref-parent="fig-cartesian-grid">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-cartesian1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 100x100 Cartesian plane
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cartesian-grid" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-density1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-density1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/density_grid.png" class="img-fluid figure-img" data-ref-parent="fig-cartesian-grid">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-density1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) The equivalent density grid with dsep = 2
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cartesian-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: The relationship between the Cartesian plane and the density grid.
</figcaption>
</figure>
</div>
<p>Each cell in the density grid should store a collection of pointers. Each pointer points to a specific point in the flow field that belongs to a curve drawn in the field, and that is mapped to that specific cell.</p>
<p>As an example, let‚Äôs suppose we are using a 100x100 flow field, and that we already drawn two curves in the field, curve A and curve B. Because we configured the number of steps to 30, each curve have approximatelly 30 different points.</p>
<p>But let‚Äôs focus our example on 4 specific points. One specific point (of these 4) belongs to curve B. While the remaining 3 points (of the 4) belongs to curve A. Let‚Äôs suppose these points are the following x and y coordinates:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?x%20=%2021.2,%20y%20=%2055.5"> (Curve A);</li>
<li><img src="https://latex.codecogs.com/png.latex?x%20=%2020.2,%20y%20=%2054.5"> (Curve A);</li>
<li><img src="https://latex.codecogs.com/png.latex?x%20=%2019.8,%20y%20=%2053.1"> (Curve A);</li>
<li><img src="https://latex.codecogs.com/png.latex?x%20=%2021.9,%20y%20=%2052.9"> (Curve B);</li>
</ul>
<p>If we set <img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D"> to 15, then, all of these 4 points will be mapped into the same density cell at position <img src="https://latex.codecogs.com/png.latex?x%20=%202"> and <img src="https://latex.codecogs.com/png.latex?y%20=%204"> of the density grid. Figure&nbsp;6 presents this idea visually.</p>
<div id="fig-density-cell" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-density-cell-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/density_cell.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-density-cell-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: An example of density cell
</figcaption>
</figure>
</div>
<p>As a consequence, the density cell at position <img src="https://latex.codecogs.com/png.latex?x%20=%202"> and <img src="https://latex.codecogs.com/png.latex?y%20=%204"> of the density grid, should store 4 pointers. Each pointer will point to one of these 4 coordinates that we described above. Because each of these coordinates in the flow field were mapped to this particular density cell.</p>
<p>A density grid can be represented in C as a two dimensional array, where each element of this array is a density cell object. The struct <code>DensityCell</code> below represents a density cell.</p>
<p>Notice that, I am dynamically allocating memory on the heap, with <code>malloc()</code>, for reserving space to store the values for each (x and y) coordinates that will be mapped to this density cell. Since this is a dynamically allocated memory, we need to remember to free this memory later, when we are done with it.</p>
<p>To start, I am allocation space for 14000 x and y coordinates in each density cell with <code>malloc()</code>. This value might be too high, or might be too low. Is hard to predict the number of coordinates that will be stored inside this density cell.</p>
<p>Because of that, it might be a good idea to transform these x and y arrays inside the density cell into growable arrays, instead of using fixed sized arrays. But for now, I don‚Äôt care about that, I don‚Äôt need this work now, I just want to write a version of the algorithm that works.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define D_SEP </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb6-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define DENSITY_GRID_WIDTH </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">FLOW_FIELD_WIDTH </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> D_SEP</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> DensityCell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> space_used<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">typedef</span> DensityCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-10"></span>
<span id="cb6-11">DensityCell density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb6-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> density_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-15">        density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>space_used <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-16">        density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> density_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-17">        density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>density_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb6-18">        density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>density_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb6-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Now, given that you have a coordinate in the flow field, how to do you store this coordinate inside the density grid? The function <code>insert_coord_in_density_grid()</code> below summarises this process.</p>
<p>First, we calculate the coordinate of the density cell that is mapped to this particular coordinate. We check if we are inside the boundaries of the density grid. Then, we look at the density cell found, and check if we have enough space to add this one coordinate to the density cell. If we do have space, then, we simply add this coordinate to the x and y arrays that are inside this <code>DensityCell</code> object.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> insert_coord_in_density_grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-2">                   <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-3">                   <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-4">                   DensityCell density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> density_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_density_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> density_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_density_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>off_boundaries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>density_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> density_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-10"></span>
<span id="cb7-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> space_used <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>density_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>density_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>space_used<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>density_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>density_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-13">    </span>
<span id="cb7-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>space_used <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-15">        density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>density_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>density_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>space_used<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-16">        density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>density_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>density_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>space_used<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-17">        density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>density_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>density_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>space_used <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> space_used <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-19">        printf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[ERROR]: Attempt to add coordinate in density cell that is out of capacity!</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="searching-for-points-near-by" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="searching-for-points-near-by"><span class="header-section-number">5.3</span> Searching for points near by</h2>
<p>We use the density grid to find all points from another curves that are near by our next move in the flow field. That is essentially the main purpose of the density grid. To help us finding which points are near by our next move in the flow field.</p>
<p>In essence, at each step we take in the flow field, we need to calculate the position of the density cell that is mapped to our next move. By identifying which cell in the density grid we are mapped to, we can look at the pointers that are already stored inside this specific density cell to find which points are near by.</p>
<p>Actually, the algortihm from <span class="citation" data-cites="jobard97">Jobard and Lefer (1997)</span> looks not only at the specific cell that is mapped to our next move, but it also looks at the 8 density cells that are surrounding this current cell.</p>
<p>You can see at Figure&nbsp;7 a representation of this process.</p>
<div id="fig-distance3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-distance3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/distance-surroundings.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-distance3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Calculating the distance between our current position and the near by points from neighbouring curves
</figcaption>
</figure>
</div>
</section>
<section id="checking-if-our-next-step-is-valid" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="checking-if-our-next-step-is-valid"><span class="header-section-number">5.4</span> Checking if our next step is valid</h2>
<p>So, in summary, we need to check if our next step, is a valid step, before we take it. If the step is not valid, we should ‚Äúcancel‚Äù the next step, and stop drawing the current curve.</p>
<p>But how to check if this next step is valid. The function <code>is_valid_step()</code> below summarises this process. This function returns a boolean value, 1 for true and 0 for false.</p>
<p>First, we find which density cell is mapped to the coordinates of this next step. Then, we need to calculate the coordinates of the surrounding density cells, as I showed at Figure&nbsp;7.</p>
<p>Having the coordinates of density cells we need to pass through, we use then, calculate the distance between our next step and each point stored in each density cell, and check if any of these distances are less or equal than <img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D">.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> is_valid_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-2">             <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-3">             <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> density_grid_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-4">             DensityCell density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-5"></span>
<span id="cb8-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> density_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_density_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> density_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_density_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>off_boundaries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>density_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> density_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-11">   </span>
<span id="cb8-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> start_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>density_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> density_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> end_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>density_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> density_grid_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> density_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> density_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb8-14">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> start_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>density_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> density_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-15">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> end_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>density_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> density_grid_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> density_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> density_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-16"> </span>
<span id="cb8-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Subtracting a very small amount from D_SEP, just to account for the lost of float precision</span></span>
<span id="cb8-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// that happens during the calculations below, specially in the distance calc</span></span>
<span id="cb8-19">    d_sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fabs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> D_SEP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb8-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> end_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> end_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-22">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n_elements <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>space_used<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-23">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n_elements <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-24">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-25">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-26"></span>
<span id="cb8-27">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n_elements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-28">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb8-29">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb8-30">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-31">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> d_sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-32">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-33">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-34">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-35">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-36">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-37">  </span>
<span id="cb8-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-39"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="drawing-the-curves" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="drawing-the-curves"><span class="header-section-number">5.5</span> Drawing the curves</h2>
<p>Now, the final piece of the alorithm. How can you draw non-overlaping curves? Actually, all we need to do, is to add two more steps to the same steps we described at Section&nbsp;3.</p>
<p>If you look at the C code below, you can see that we now have a main for loop, that draws a single curve per iteration. Now, the first inner loop is the exact same for loop we presented at Section&nbsp;3, with essentially the same steps, with only one difference.</p>
<p>We now have a if statement to check the result of <code>is_valid_next_step()</code>. If the function returns true, then, the next step we are trying to take is valid, so we go on with our lives, and we go to the next iteration.</p>
<p>However, if the function returns false (0), then, it means that the next step is not valid (i.e.&nbsp;it is too close to a neighboring curve), and because of that, we run a <code>break</code> statement to drawing the current curve. Then, we comeback to the main and outer loop, and we start to draw the next curve in the field.</p>
<p>You can also see that, after this first inner loop, it means that you finished drawing the current curve. Because of that, we now need, to register/insert all points of this curve into the density grid. So that the next curves that are drawn into the field, take the points from this current curve into account. That is what the second inner loop does. It walks trough the points of the curve, and register these points into the density grid.</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1">Curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> curves <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N_CURVES <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb9-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N_CURVES<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-3">    curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N_STEPS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb9-4">    curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N_STEPS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb9-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> curve_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> curve_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N_CURVES<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start_points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start_points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-10">    curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-11"></span>
<span id="cb9-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N_STEPS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-13">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ff_column_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> floor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-14">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ff_row_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> floor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-15"></span>
<span id="cb9-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>off_boundaries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ff_column_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ff_row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> FLOW_FIELD_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-17">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-19"></span>
<span id="cb9-20">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> flow_field<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>ff_row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>ff_column_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb9-21">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> STEP_LENGTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-22">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> STEP_LENGTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-23">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-24">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-25"></span>
<span id="cb9-26">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> valid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> is_valid_next_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb9-27">            x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-28">            D_SEP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-29">            DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-30">            density_grid</span>
<span id="cb9-31">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-32"></span>
<span id="cb9-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>valid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-34">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// This next step is not valid, stop drawing current curve</span></span>
<span id="cb9-35">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// and jump to start drawing next curve.</span></span>
<span id="cb9-36">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-37">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-38"></span>
<span id="cb9-39">        curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-40">        curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-41">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-42"></span>
<span id="cb9-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// After we finish calculating the coordinates of a curve,</span></span>
<span id="cb9-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// we add the coordinates of this curve to the density grid.</span></span>
<span id="cb9-45">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N_STEPS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-46">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb9-47">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb9-48">        insert_coord_in_density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> D_SEP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-49">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-50"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="the-full-source-code" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="the-full-source-code"><span class="header-section-number">5.6</span> The full source code</h2>
<p>After I explained each individual aspect about this first part of the algorithm, is finally time to see the entire piece. But, just for brevity reasons, and to save space in this article, I will not show the entire source code here. Instead, I will give you a link to GitHub, where you can read the source code peacefully.</p>
<p>Link to the entire algorithm: <a href="https://github.com/pedropark99/Personal-website/blob/main/posts/2024/2024-02-19-flow-even/src/non_overlap_curves.c" class="uri">https://github.com/pedropark99/Personal-website/blob/main/posts/2024/2024-02-19-flow-even/src/non_overlap_curves.c</a></p>
</section>
</section>
<section id="drawing-evenly-spaced-curves" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Drawing evenly-spaced curves</h1>
<p>Now, the other part of the algorithm introduces some new concepts, and strategies. According to <span class="citation" data-cites="jobard97">Jobard and Lefer (1997)</span>, in order to obtain a good visual appearance of the flow field, an accurante seed point selection method needs to be performed.</p>
<p>This sentence introduces a new term that we haven‚Äôt spoked about yet. A seed point is the term chosen by <span class="citation" data-cites="jobard97">Jobard and Lefer (1997)</span> to designate a starting point of a curve, is the point from where the curves starts to grow.</p>
<p>What <span class="citation" data-cites="jobard97">Jobard and Lefer (1997)</span> is really trying to say, is that, if you really want to draw curves that are evenly spaced between each other, then, you need choose wisely the points from where your curves starts.</p>
<section id="drawing-a-curve-in-two-directions" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="drawing-a-curve-in-two-directions"><span class="header-section-number">6.1</span> Drawing a curve in two directions</h2>
<p>Before we talk about how to select proper seed points for your curves, I want to talk about how can you draw a curve in two directions. Because <span class="citation" data-cites="jobard97">Jobard and Lefer (1997)</span> algorithm actually draws a curve in both directions (from right to left and left to right).</p>
<p>In other words, for the <span class="citation" data-cites="jobard97">Jobard and Lefer (1997)</span> algorithm to work effectively, we need to draw every single curve in both directions. Figure&nbsp;8 shows what ‚Äúdrawing a curve in both directions‚Äù actually means.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-curve-both-directions" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-curve-both-directions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/en/index_files/figure-html/fig-curve-both-directions-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-curve-both-directions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Drawing a curve in both directions
</figcaption>
</figure>
</div>
</div>
</div>
<p>So, to do that, we need to adjust our current script. First, let‚Äôs change the <code>Curve</code> struct to include some more information that will help us tracking the coordinates that are being calculated. These extra informations, will help us to sort these coordinates, or, to track the order of each step taken.</p>
<p>You can see below that, three more variables were added to the struct: <code>step_id</code> is essentially the number of the step that created the corresponding x and y coordinates; <code>steps_taken</code> is the total number of steps taken to draw this curve; <code>direction</code>, an integer indicating if the corresponding x and y coordinates were calculated when the algorithm was drawing the curve in the direction right to left (zero), or, if was drawing the curve from left to right (one).</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Curve <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>N_STEPS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb10-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>N_STEPS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb10-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If x and y coordinates are from a step that was taken from left to right (1)</span></span>
<span id="cb10-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// or a step from right to left (0).</span></span>
<span id="cb10-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> direction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>N_STEPS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb10-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The id of the step</span></span>
<span id="cb10-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> step_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>N_STEPS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb10-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> steps_taken<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">typedef</span> Curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>Now, our algorithm currently draws only curves from left to right. But we want to draw curves in both directions. For that, is good to include the logic for drawing curves into a nice function. That is why, I created the <code>draw_curve()</code> function below:</p>
<p>You can see in the function that, the logic of the function is essentially the same as before. But now, we have two main loops, represented as <code>while</code> loops. But the only thing that changes between one loop and another, is the ‚Äútranslation‚Äù operation that we apply after we calculated the step.</p>
<p>On the first <code>while</code> loop, we <strong>add</strong> the steps to the current x and y coordinates. But on the second <code>while</code> loop, we <strong>subtract</strong> these steps instead from the current x and y coordinates. That makes the walking process go backwards. In other words, that draws the curve in the inverse direction.</p>
<p>Despite this diference, we are essentially doing the exact same computations we did before. We are still validating at each iteration it the next step we calculated is a valid one, using the <code>is_valid_next_step()</code> function.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb11-1"></span>
<span id="cb11-2">Curve draw_curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-3">                 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-4">                 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-5">                 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> flow_field<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>FLOW_FIELD_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>FLOW_FIELD_HEIGHT<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb11-6">                 DensityCell density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-7"></span>
<span id="cb11-8">    Curve curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-9">    curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>curve_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-10">    curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N_STEPS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-12">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-13">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-14">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>direction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-15">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>step_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-17"></span>
<span id="cb11-18">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-19">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-20">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> direction <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-21">    curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-22">    curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-23">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> step_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-24">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Draw curve from right to left</span></span>
<span id="cb11-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N_STEPS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-27">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ff_column_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> floor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-28">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ff_row_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> floor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-29"></span>
<span id="cb11-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>off_boundaries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ff_column_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ff_row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> FLOW_FIELD_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-31">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-32">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-33"></span>
<span id="cb11-34">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> flow_field<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>ff_row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>ff_column_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb11-35">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> STEP_LENGTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-36">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> STEP_LENGTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-37">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-38">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-39"></span>
<span id="cb11-40">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> valid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> is_valid_next_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb11-41">            x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-42">            D_SEP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-43">            D_TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-44">            DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-45">            density_grid</span>
<span id="cb11-46">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-47"></span>
<span id="cb11-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>valid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-49"></span>
<span id="cb11-50">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-51">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-52">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>step_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> step_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-53">        step_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb11-54">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>steps_taken<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb11-55">        i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb11-56">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-57"></span>
<span id="cb11-58"></span>
<span id="cb11-59">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-60">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-61">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Draw curve from left to right</span></span>
<span id="cb11-62">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N_STEPS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-63">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ff_column_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> floor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-64">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ff_row_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> floor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-65"></span>
<span id="cb11-66">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>off_boundaries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ff_column_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ff_row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> FLOW_FIELD_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-67">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-68">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-69"></span>
<span id="cb11-70">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> flow_field<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>ff_row_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>ff_column_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb11-71">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> STEP_LENGTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-72">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> STEP_LENGTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-73">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-74">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-75"></span>
<span id="cb11-76">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> valid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> is_valid_next_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb11-77">            x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-78">            D_SEP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-79">            D_TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-80">            DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-81">            density_grid</span>
<span id="cb11-82">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-83"></span>
<span id="cb11-84">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>valid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-85"></span>
<span id="cb11-86">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-87">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-88">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>direction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-89">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>step_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> step_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-90">        step_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb11-91">        curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>steps_taken<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb11-92">        i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb11-93">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-94"></span>
<span id="cb11-95">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-96"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="the-logic-behind-the-core-algorithm" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="the-logic-behind-the-core-algorithm"><span class="header-section-number">6.2</span> The logic behind the core algorithm</h2>
<p>The main idea behind the core algorithm, is to select the next seed points from the current curve. In other words, instead of selecting all starting points for all the curves we want to draw, before we even touch the flow field and starting to draw any curve, in this algorithm, we now want to select new starting points from the curve we are currently drawing.</p>
<p>The main logic of the algorithm is:</p>
<ol type="1">
<li>First, we draw a curve;</li>
<li>Then, we go trough each point of this curve, and collects all possible seed points that are in a distance of <img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D"> from each point of the curve. That becomes like a queue of elegible seed points to be processed.</li>
<li>We then go through that queue of elegible seed points, and we check if each seed point is valid (i.e.&nbsp;if is not too close to a neighbouring curve).</li>
<li>If the current seedpoint is not valid, we jump to the next seed point in the queue, and we check it is valid.</li>
<li>If the current seedpoint is valid, then, we draw a curve from this seed point, and we add this new curve to the queue of curves to be evaluated.</li>
<li>After we finished going through all of the elegible seed points we collected from the current curve, we jump to the next curve in the queue, and repeat this process from step 2, until we have no more curves to be evaluated.</li>
</ol>
<p>You can see in the above steps that there are two types of ‚Äúqueues‚Äù involved in this process. First, we have a queue of starting points (or seed points). We need to check if each starting point in this queue is valid. Second, we also have a queue of curves to be evaluated. The idea is to collect all elegible starting points we can find from each curve registered in this queue.</p>
<p>The function <code>collect_seedpoints()</code> below is responsible for collecting all elegible seed points from a single curve. The collected seedpoints are stored inside a <code>SeedPointsQueue</code> object, that represents a queue of seed points to be evaluated.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">typedef</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-5"></span>
<span id="cb12-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> SeedPointsQueue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-7">    Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> space_used<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">typedef</span> SeedPointsQueue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-11"></span>
<span id="cb12-12">SeedPointsQueue collect_seedpoints <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Curve curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>steps_taken<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-14">    SeedPointsQueue queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-15">    queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>space_used <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-17">        queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-20"></span>
<span id="cb12-21">    queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb12-22">    queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-23">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> candidate_point_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-25">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb12-26">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb12-27">            </span>
<span id="cb12-28">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ff_column_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> floor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-29">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ff_row_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> floor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-30">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> atan2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-31"></span>
<span id="cb12-32">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> angle_left <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>M_PI <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-33">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> angle_right <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>M_PI <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-34"></span>
<span id="cb12-35">        Point left_point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-36">            x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D_SEP <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle_left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)),</span></span>
<span id="cb12-37">            y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D_SEP <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle_left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb12-38">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-39">        Point right_point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-40">            x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D_SEP <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle_right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)),</span></span>
<span id="cb12-41">            y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D_SEP <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>angle_right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb12-42">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-43"></span>
<span id="cb12-44">        queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>candidate_point_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> left_point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-45">        candidate_point_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb12-46">        queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>space_used<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb12-47">        queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>candidate_point_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> right_point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-48">        candidate_point_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb12-49">        queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>space_used<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb12-50">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-51"></span>
<span id="cb12-52">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-53"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>With this function, we can now build the complete logic of the algorithm. In the previous sections, we drawn all curves inside a for loop. But this time, we first, draw manually a single curve in to the field, from whatever starting point we want to (in the example below, I choose to start from the coordinate <img src="https://latex.codecogs.com/png.latex?x%20=%2045"> and <img src="https://latex.codecogs.com/png.latex?y%20=%2024">). And then, all of the other curves are derived from this first curve that we drawn.</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb13-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define MIN_STEPS_ALLOWED </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb13-2"></span>
<span id="cb13-3">Curve curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>N_CURVES<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb13-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">45.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">24.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> curve_array_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> curve_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-8">curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> draw_curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> flow_field<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb13-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>steps_taken<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb13-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb13-13">    insert_coord_in_density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> D_SEP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb13-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-15">curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb13-16"></span>
<span id="cb13-17"></span>
<span id="cb13-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>curve_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N_CURVES <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> curve_array_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N_CURVES<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-19">    SeedPointsQueue queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-20">    queue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> collect_seedpoints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb13-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> point_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> point_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>space_used<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> point_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-22">        Point p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>point_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb13-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// check if it is valid given the current state</span></span>
<span id="cb13-24">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> valid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> is_valid_next_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb13-25">            p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-26">            D_SEP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-27">            DENSITY_GRID_WIDTH<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-28">            density_grid</span>
<span id="cb13-29">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb13-30"></span>
<span id="cb13-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>valid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-32">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// if it is, draw the curve from it</span></span>
<span id="cb13-33">            Curve curve <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> draw_curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb13-34">                p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-35">                curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-36">                flow_field<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-37">                density_grid</span>
<span id="cb13-38">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb13-39">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> MIN_STEPS_ALLOWED<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-40">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-41">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-42"></span>
<span id="cb13-43">            curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-44">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// insert this new curve into the density grid</span></span>
<span id="cb13-45">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>steps_taken<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-46">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> steps_taken <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-47">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb13-48">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curves<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb13-49">                insert_coord_in_density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> D_SEP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> density_grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb13-50">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-51">            curve_array_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb13-52">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-53">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-54"></span>
<span id="cb13-55">    curve_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb13-56"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="the-end-result-of-the-algorithm" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="the-end-result-of-the-algorithm"><span class="header-section-number">6.3</span> The end result of the algorithm</h2>
<p>Now that the algorithm is complete, we can now see the end results it produces. Figure&nbsp;9 shows an example. We essentially took the exact same flow field of Figure&nbsp;3. We just changed the value for <img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D"> slightly.</p>
<div id="fig-even-curves1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-even-curves1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/even_curves1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-even-curves1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: A result of the evenly-spaced curves algorithm. Configs: flow_field_width=120; dsep=1; n_curves=1500; n_steps=30; step_length=0.01*flow_field_width; min_steps_allowed=2
</figcaption>
</figure>
</div>
<p>Now, that is a variable that is useful for you to control when you producing such images, which is the <code>MIN_STEPS_ALLOWED</code> variable. This variable controls which curves are considered and included in the end result, and which are not, based on the number of steps taken in that particular curve.</p>
<p>You see at Figure&nbsp;9 that it has a lot of very short curves in some particular areas of the flow field. In other words, depending on the flow field you are using, and all of the global configs (i.e.&nbsp;value of <img src="https://latex.codecogs.com/png.latex?d_%7Bsep%7D">, the number of steps, the step length, the number of curves, etc.), some particular areas of the flow field will tend to concentrate some very short curves.</p>
<p>Also, the order in which you draw each valid seed point you find can also influence this specific aspect of the image. For example, if you draw the valid seed points in sequential order, as they come to you, them, you get a result. But if you draw these valid seed points in a random order, you might end up getting a slightly different result.</p>
<p>This is not something that will happen always, in 100% cases. But it normally does happen with this particular algorithm. But this is something that you can easily improve (or fix) by changing the value of <code>MIN_STEPS_ALLOWED</code>.</p>
<p>In most cases, this variable is configured to 2. But If you raise this number, just a bit, you usually end up getting much better results. At Figure&nbsp;10 we have the result, when <code>MIN_STEPS_ALLOWED</code> is configured to 5.</p>
<div id="fig-even-curves2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-even-curves2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/even_curves2.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-even-curves2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: A result of the evenly-spaced curves algorithm. Configs: flow_field_width=120; dsep=1; n_curves=1500; n_steps=30; step_length=0.01*flow_field_width; min_steps_allowed=5
</figcaption>
</figure>
</div>
</section>
<section id="the-full-source-code-1" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="the-full-source-code-1"><span class="header-section-number">6.4</span> The full source code</h2>
<p>Again, for brevity reasons and to save space in this article, I will give you a link to GitHub, where you can read the full source code peacefully.</p>
<p>Link to the entire algorithm: <a href="https://github.com/pedropark99/Personal-website/blob/main/posts/2024/2024-02-19-flow-even/src/even_spaced_curves.c" class="uri">https://github.com/pedropark99/Personal-website/blob/main/posts/2024/2024-02-19-flow-even/src/even_spaced_curves.c</a></p>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-jobard97" class="csl-entry">
Jobard, Bruno, and Wilfrid Lefer. 1997. <span>‚ÄúCreating Evenly-Spaced Streamlines of Arbitrary Density.‚Äù</span> In <em>Visualization in Scientific Computing ‚Äô97</em>, edited by Wilfrid Lefer and Michel Grave, 43‚Äì55. Vienna: Springer Vienna.
</div>
<div id="ref-perlin" class="csl-entry">
Wikipedia. 2024a. <span>‚ÄúPerlin Noise.‚Äù</span> <a href="https://en.wikipedia.org/wiki/Perlin_noise">https://en.wikipedia.org/wiki/Perlin_noise</a>.
</div>
<div id="ref-simplex" class="csl-entry">
‚Äî‚Äî‚Äî. 2024b. <span>‚ÄúSimplex Noise.‚Äù</span> <a href="https://en.wikipedia.org/wiki/Simplex_noise">https://en.wikipedia.org/wiki/Simplex_noise</a>.
</div>
</div></section></div> ]]></description>
  <category>Flow Fields</category>
  <category>C</category>
  <category>Algorithm</category>
  <category>Computer Graphcis</category>
  <guid>https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/en/</guid>
  <pubDate>Mon, 19 Feb 2024 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2024/2024-02-19-flow-even/flow_field.png" medium="image" type="image/png" height="86" width="144"/>
</item>
<item>
  <title>Have you ever SSH before?</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2024/2024-01-22-did-you-ever-ssh/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>SSH stands for <em>Secure Socket Shell</em>, and it is probably the most used protocol today to establish a secure connection between two computers.</p>
<p>In this article, I want to explain how can access a remote computer through a SSH connection.</p>
</section>
<section id="ssh-client-vs-ssh-server" class="level1">
<h1>SSH Client vs SSH Server</h1>
<p>Two computers are involved when you are trying to perform a SSH connection. One computer is your personal desktop/laptop, this is the computer you are using to perform the connection. This computer, is commonly reffered to as the SSH Client.</p>
<p>The other computer, is the remote machine, and it is commonly reffered as the SSH Server. This SSH Server is the computer that you are trying to connect to, while the machine you are using to perform the connection, is the SSH Client.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2024/2024-01-22-did-you-ever-ssh/ssh-client-server.png" class="img-fluid figure-img"></p>
<figcaption>The SSH Client vs SSH Server relationship</figcaption>
</figure>
</div>
<p>On this experiment that I‚Äôm sharing here, I used my Ubuntu (Linux) machine as the SSH Server, because most servers these days uses Linux distributions as their operational systems, such as Ubuntu, Debian and Alpine.</p>
<p>In the other hand, my SSH Client here in this example is my Windows machine, or, to be more specific, I‚Äôm using my WSL (<em>Windows Subsystem for Linux</em>) with Ubuntu to perform the connection.</p>
<p>So essentially, in this experiment, both sides of this relationship (the SSH Server and the SSH Client) are using Ubuntu distros as they operational system.</p>
</section>
<section id="requirements" class="level1">
<h1>Requirements</h1>
<p>What you must have to login into a remote computer using SSH? Well‚Ä¶ you need the following things to establish a SSH connection between two computers:</p>
<ul>
<li>Both computers (SSH Client and Server) must be on and connected to the internet.</li>
<li>The SSH Client needs to have ‚ÄúOpenSSH‚Äù installed.</li>
<li>The SSH Server needs to have ‚ÄúOpenSSH Server‚Äù installed (which is also commonly reffered as the <code>sshd</code> program<sup>1</sup>).</li>
<li>In order to connect into the SSH Server, this Server needs to have the <code>sshd</code> program working and running, so that it waits for incoming connections.</li>
<li>You need to know the IP address (search specifically, for the public IPv4 address) of the SSH Server.</li>
<li>You need to know which username you want to use when you login into the SSH Server, and also, which is the password of this username.</li>
</ul>
<p>One thing is optional:</p>
<ul>
<li>If you want to establish a password-less connection, then, you need to generate a SSH Key Pair, by using the <code>ssh-keygen</code> command <sup>2</sup>.</li>
</ul>
</section>
<section id="find-the-ip-address-of-your-server" class="level1">
<h1>Find the IP Address of your Server</h1>
<p>The IP address of the remote computer (i.e.&nbsp;the SSH Server) you are trying to connect to is a crucial information, because SSH will use this information to find the actual computer. Without this information, SSH cannot locate where this computer is.</p>
<section id="ipv4-vs-ipv6" class="level2">
<h2 class="anchored" data-anchor-id="ipv4-vs-ipv6">IPv4 vs IPv6</h2>
<p>There are two styles (or models) of IP addresses, IPv4 and IPv6. The IPv4 model is the one that you are looking for! So search for an IP address that have the IPv4 format, which are 4 numbers separated by dots. Examples: <code>127.0.0.1</code> (also known as the IP address for <em>localhost</em>) and <code>172.16.254.1</code>.</p>
</section>
<section id="private-vs-public-ip-address" class="level2">
<h2 class="anchored" data-anchor-id="private-vs-public-ip-address">Private vs public IP address</h2>
<p>There is also the distinction between <em>private</em> and <em>public</em> IP addresses that you need to be aware of. Some IP addresses are <em>private</em> in the meaning that they can only be acessed from a very specific location, which is your local network. That is, private IP addresses are visible only within the same WiFi/Ethernet you are connected in.</p>
<p>In other words, if you are like in Italy for example, and you are trying to access a server that is in France, using the <em>private</em> IP address of that server, then, you will never succeed, it is impossible. Because a <em>private</em> IP address is only accesible if you were connected to the same WiFi/Ethernet that the server is. So you would need to be in the same phisical location of the server in France, and connected to the same network (WiFi/Ethernet) as the server to access it using it‚Äôs <em>private</em> IP address.</p>
<p>All of this means that, if you are trying to connect to a remote computer that is far away from you, then you certainly need the <strong>public</strong> IP address of this computer, not the private one. So you should always look for the <strong>public</strong> IP address of the computer you are trying to login in.</p>
</section>
<section id="where-to-find-it" class="level2">
<h2 class="anchored" data-anchor-id="where-to-find-it">Where to find it?</h2>
<p>If, and only if, your SSH Server is actually a Windows machine (which is not commom for servers in general), then, you could open the Windows Settings Menu, and look for the section Network &amp; internet, and look for the ‚ÄúProperties‚Äù window of the WiFi/Ethernet that your server is connected to.</p>
<p>In the print below, I used my Windows machine as an example, and I covered the sensible information with a red rectangle. But the IPv4 address can be found where I am pointing with the blue arrow (sorry, my Windows machine is in Portuguese):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2024/2024-01-22-did-you-ever-ssh/windows-ip.png" class="img-fluid figure-img"></p>
<figcaption>Looking the IP Address in Windows</figcaption>
</figure>
</div>
<p>But in contrast, if your server is a Linux machine, then, you can open a terminal, and run the command <code>ifconfig</code>, then look for the IPv4 address that will appear after the <code>inet</code> word.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ifconfig</span></span></code></pre></div>
</section>
<section id="the-ip-address-of-my-ubuntu-ssh-server" class="level2">
<h2 class="anchored" data-anchor-id="the-ip-address-of-my-ubuntu-ssh-server">The IP address of my Ubuntu SSH Server</h2>
<p>I cannot share the public IP address of Ubuntu machine, because if I did, then, I could suffer from remote attacks. If people know where my machine is, then, they can try to access it and break it.</p>
<p>That is why, in this article, I‚Äôm going to use a fictituous IP address over the next examples. Let‚Äôs suppose I looked for the IPv4 of my Ubuntu computer, which is the SSH Server in this experiment, and I found the IP <code>171.0.0.1</code>. So every time you see this IP <code>171.0.0.1</code>, you know that this is the IP of my SSH Server.</p>
</section>
</section>
<section id="find-the-users-available-in-your-server" class="level1">
<h1>Find the users available in your server</h1>
<p>Now, we need to know which username we want to use in the server‚Äôs login. If your SSH Server is a Linux machine, then, you can probably use the <code>root</code> username, which is the admin of the machine, it is the user with most privileges on the server. But using the <code>root</code> user is usually a bad practice.</p>
<p>So I will choose to use the <code>pedro</code> user instead, which is my personal user, to login into my server. Now, if your SSH Server is a Linux machine, and you are unsure about which user to use, you can look at the available users in your server, so that you get a list of ‚Äúavailable options‚Äù.</p>
<p>To get this list of available users, run the following bash command in the terminal of your SSH Server:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d:</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-f1</span> /etc/passwd</span></code></pre></div>
<p>Simply choose whatever user you want from this list.</p>
</section>
<section id="check-if-the-ssh-server-is-running" class="level1">
<h1>Check if the SSH Server is running!</h1>
<p>The machine that is behaving as the SSH Server in this relationship, not only needs to be up and running, and connected to the internet. This machine also needs to have the <code>sshd</code> (SSH Server daemon process) program up and running as well.</p>
<p>The <code>sshd</code> program, is the actual SSH Server process. In other words, that is the actual program that makes a computer behave as a SSH Server. This program will allocate (or take control over) a web socket in your computer, and will use this socket to wait and listen for incoming SSH connections, and it will handle/accept these connections as they come.</p>
<p>Usually, SSH is a core functionality of any web server in the world. As a consequence, usually, the <code>sshd</code> program is already started right at the startup of the machine. So usually, you do not have the need to manually start the <code>sshd</code> program, it automatically starts for you.</p>
<p>But you know‚Ä¶ problems or bugs can happen, or maybe, you lack some specific configurations in your server. So how can you check if the <code>sshd</code> program is up and running in your server? If this server is a Linux machine, you can simply run the following bash command to check the current state of the <code>sshd</code> program:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">systemctl</span> status sshd</span></code></pre></div>
<p>Now, if for some reason, the above command shows that the <code>sshd</code> program is not in ‚Äúactive/running‚Äù state, you can manually start the <code>sshd</code> program by running the following command:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> systemctl start sshd</span></code></pre></div>
</section>
<section id="making-the-ssh-connection" class="level1">
<h1>Making the SSH connection</h1>
<p>Now that we have all the information available, and we are sure that the SSH Server is up and running, we can effectively make the connection with SSH.</p>
<p>Everything you need to do now, is to run the <code>ssh</code> command in the terminal of your SSH Client, which the username you want to use in the login, followed by a <code>@</code> and the IP Address of the SSH Server. So the command have the format of <code>ssh {user}@{ip_address}</code>.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ssh</span> pedro@171.0.0.1</span></code></pre></div>
<p>After you run the above command, you probably will be prompted with some questions, just answer ‚Äúyes‚Äù, or whatever answer is most appropriate. After these questions, the SSH Server will ask you to provide the password of the user you choose. In the above example, I used the <code>pedro</code> user to login into the server, so I need to type the password of this user.</p>
<p>If you provide the correct password, the login will succeed and SSH connection to the server will be complete! After that, the server will provide a new bash terminal for you. Through this terminal, you have a lot of control over the server, and you can send whatever bash command you want to be executed into the server.</p>
<p>The output will probably look something like this. If you see the ‚ÄúLast login: ‚Ä¶‚Äù message, then, your SSH connection was succesful and you currently are inside the bash terminal of the SSH Server. Now, you can send whatever bash command you want to be executed by the server.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Last</span> login: Wed Jan 24 20:27:17 2024</span>
<span id="cb6-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pedro@pedro:~/$</span></span></code></pre></div>
</section>
<section id="using-password-less-mode-in-the-ssh-connection" class="level1">
<h1>Using password-less mode in the SSH connection</h1>
<p>Every time you connect to the server, you will need to provide the password of the user you are using to login. However, SSH offers a mode that does need a password, which is known as the ‚Äúpassword-less mode of SSH‚Äù, and in fact, it is the recommended way of connecting to a server.</p>
<p>In other words, using the ‚Äúpassword-less mode of SSH‚Äù is the most secure way of building a SSH connection, and because of that, it is how you should connect to your server. This mode uses a key pair to autenthicate the user into the server. This key pair is composed by a public key and a private key, and when you use this mode in SSH, all of the communications made in the SSH connection (between the server and the client) are encrypted by using this pair of keys.</p>
<p>This means that, in order to use this mode of SSH, you need first to generate a key pair, if you don‚Äôt have one already. You can generate this pair by running the <code>ssh-keygen</code> command in the terminal of your SSH Client.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ssh-keygen</span></span></code></pre></div>
<p>In theory, you can run this <code>ssh-keygen</code> command in whatever computer you want. You do not need to generate this key pair in the SSH Client necessarily. This computer does not even need to be involved in the SSH relationship here. You can generate this key pair in any place you can.</p>
<p>However! What really essential here, is that <strong>the SSH Client needs to have both the public and the private key</strong>, stored inside of him. In contrast, the SSH Server needs to have only the public key.</p>
<p>This is a very important/essential detail!</p>
<p>As a result, is much easier if you run the <code>ssh-keygen</code> command inside the SSH Client. Because then, you need to do nothing, since both keys were generated inside the SSH Client, and as a consequence, they are already stored inside the SSH Client. All you have to do is to send the public key that was generated to the SSH Server.</p>
<p>But if you generated this key pair in a different computer, like the notebook of your friend, then, you need to add both the public and private keys to the computer that you are using as the SSH Client in this relationship.</p>
<p>However, is important to emphasize, <strong>you should avoid at all costs</strong> moving the private key around! In other words, the private key is an extremely sensitive information, and you should not send it to anyone. If anyone with bad intentions have access to this private key, he may try to get access to your server and make some very serious damage.</p>
<p>That is why we usually generate this key pair inside the SSH Client. Because then we avoid the need to send/move this private key to somewhere else.</p>
<p>Having that said, there is no problem to exchange the public key with other people. The public key of this key pair, is really public in the sense that there is no danger if someone else discover this key. In fact, you need to exchange this public key with the other side of the relationship. The SSH Server in this relationship needs to know which is your public key.</p>
<p>One popular way of sending the public key to the SSH Server, is to use the <code>ssh-copy-id</code> command. You execute this command in the SSH Client. You provide the path to the public key you generated after the <code>-i</code> option, and after that, you provide the same information (username and IP address) you start the connection with the server before:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ssh-copy-id</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-i</span> ~/.ssh/id_rsa.pub pedro@171.0.0.1</span></code></pre></div>
<p>You probably will need to provide the password of your username one more time in this command. But if this command runs succesfully, then, over the next times you login into the server, you will not need a password anymore. Because the server will authenticate you automatically based on your key pair.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><a href="https://www.ssh.com/academy/ssh/sshd" class="uri">https://www.ssh.com/academy/ssh/sshd</a>‚Ü©Ô∏é</p></li>
<li id="fn2"><p><a href="https://www.ssh.com/academy/ssh/keygen" class="uri">https://www.ssh.com/academy/ssh/keygen</a>‚Ü©Ô∏é</p></li>
</ol>
</section></div> ]]></description>
  <category>SSH</category>
  <category>Servers</category>
  <category>Network</category>
  <guid>https://pedro-faria.netlify.app/posts/2024/2024-01-22-did-you-ever-ssh/en/</guid>
  <pubDate>Mon, 22 Jan 2024 03:00:00 GMT</pubDate>
</item>
<item>
  <title>How to use the cache effectively on Apache Spark</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2024/2024-01-13-spark-cache/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>I work a lot with Apache Spark on Databricks, and very recently, I encountered some cases of jobs failling because of cached DataFrames ocupying all the memory available, and, as consequence, raising <code>OutOfMemory</code> runtime errors.</p>
<p>In essence, the job was executing a Python notebook that contained some <code>pyspark</code> code. Many Spark DataFrames were being constantly cached by using the DataFrame method <code>cache()</code>. And this pattern was causing the memory to be crowed with more and more caches, until it became full, and caused the job to crash.</p>
<p>In this article, I want to describe how you should use <code>cache()</code> effectively on Apache Spark, and also, explain how this <code>OutOfMemory</code> error happenned.</p>
</section>
<section id="what-is-this-cache-method" class="level1">
<h1>What is this <code>cache()</code> method?</h1>
<p>In Apache Spark we work with Spark DataFrames. They are the core (or the essence) of any Spark application. We model, transform, load and export these objects to get the result we want.</p>
<p>However, in some cases, generating a specific Spark DataFrame can take a long time. Maybe this DataFrame is defined by a heavy query, that involves many and many layers of calculations, or maybe, a huge amount of data needs to be read to calculate/generate this DataFrame.</p>
<p>For these specific cases, we can cache this specific Spark DataFrame. By caching it, we avoid the need to calculate/generate from scratch this DataFrame, over and over again. We calculate it once, and then, we reuse this same data in posterior cases.</p>
<p>We do this, by calling the <code>cache()</code> DataFrame method, to mark that specific DataFrame as a ‚Äúcached DataFrame‚Äù. As an example, in the code below, I‚Äôm creating a Spark DataFrame called <code>df</code>:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pyspark.sql <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SparkSession</span>
<span id="cb1-2">spark <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SparkSession.builder.getOrCreate()</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> date</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pyspark.sql <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Row</span>
<span id="cb1-5"></span>
<span id="cb1-6">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb1-7">  Row(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">28.3</span>, date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2021</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb1-8">  Row(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">15.8</span>, date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2021</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb1-9">  Row(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">20.1</span>, date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2021</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)),</span>
<span id="cb1-10">  Row(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.6</span>, date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2021</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb1-11">]</span>
<span id="cb1-12"></span>
<span id="cb1-13">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spark.createDataFrame(data)</span></code></pre></div>
<p>If I want to cache this DataFrame, all I need to do is to call the <code>cache()</code> method with this <code>df</code> object, like this:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">df.cache()</span></code></pre></div>
<p>Now, the <code>df</code> DataFrame is marked as a ‚ÄúDataFrame to be cached‚Äù by Spark, and if we use this <code>df</code> DataFrame over the next lines of our notebook, instead of Spark recalculating the entire DataFrame each time, it will reuse the data of this DataFrame that was cached. This can make our Spark application much faster, because Spark will not spend more time recalculating the DataFrame.</p>
<p>But is important to note, that in Apache Spark, cache operations are lazy operations. I quickly described this lazy aspect of Spark at <a href="https://pedropark99.github.io/Introd-pyspark/Chapters/04-dataframes.html#sec-viewing-a-dataframe">Section 3.5 of my <code>pyspark</code> book</a>.</p>
<blockquote class="blockquote">
<p>A key aspect of Spark is its laziness. In other words, for most operations, Spark will only check if your code is correct and if it makes sense. Spark will not actually run or execute the operations you are describing in your code, unless you explicit ask for it with a trigger operation, which is called an ‚Äúaction‚Äù (this kind of operation is described in Section 5.2). <span class="citation" data-cites="pedro2024">Faria (2024)</span></p>
</blockquote>
<p>Therefore, the cache operation of the DataFrame will only happen if you call an action over the next lines of your notebook. I listed what operations are considered as actions in Spark at <a href="https://pedropark99.github.io/Introd-pyspark/Chapters/05-transforming.html#sec-dataframe-actions">Section 5.2 of my <code>pyspark</code> book</a>. But essentially, the Spark DataFrame methods below are all examples of actions in Spark:</p>
<ul>
<li><code>show()</code></li>
<li><code>collect()</code></li>
<li><code>count()</code></li>
<li><code>write.csv()</code></li>
<li><code>read.csv()</code></li>
</ul>
<p>So, if you call any of the Spark DataFrame methods above, after you called <code>cache()</code> over the same Spark DataFrame, then, Spark will effectively cache your DataFrame.</p>
</section>
<section id="how-to-use-cache-effectively" class="level1">
<h1>How to use cache effectively</h1>
<p>There are two commom situations where cache can be very effective, which are:</p>
<ul>
<li><p><strong>Constantly use the same DataFrame over the notebook</strong>.</p></li>
<li><p><strong>Frequently access a subset of a DataFrame</strong>.</p></li>
</ul>
<p>Every time you call an action on a Spark DataFrame in your notebook, Spark needs to read and load the DataFrame‚Äôs data from storage (this storage can be many things, like a data lake in the cloud, or a local static file, etc.). So if you repeateadly use the same Spark DataFrame, then, you are repeateadly reading from storage the same data over and over again.</p>
<p>Having this in mind, when you constantly use the same Spark DataFrame over and over again across your notebook, it might be a good idea to cache this specific DataFrame. For example, if you use a DataFrame called <code>students</code> in 15 locations in your notebook, then, by default, Spark will recalculate this <code>students</code> DataFrame, from scratch, 15 times. But if you cache this DataFrame, then, Spark will calculate the DataFrame on the first time, and reuse the cached data in the remaining 14 times.</p>
<p>So ‚Ä¶</p>
<blockquote class="blockquote">
<p>caching is optimal when you need to perform multiple operations on the same dataset to avoid reading from storage repeatedly. <span class="citation" data-cites="patidar2023">Patidar (2023)</span>.</p>
</blockquote>
<p>The same applies to when you are frequently using the same subset of a DataFrame. For example, you might have defined in your notebook a new object <code>under_10</code> which contains all rows from <code>students</code> DataFrame that describes students that have an age below 10.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pyspark.sql.functions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> col</span>
<span id="cb3-2">under_10 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> students.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'age'</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<p>If you use this subset of <code>students</code> DataFrame across multiple locations of your notebook, then, it might be also a good idea to cache this <code>under_10</code> DataFrame, like this:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pyspark.sql.functions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> col</span>
<span id="cb4-2">under_10 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb4-3">  students</span>
<span id="cb4-4">    .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'age'</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb4-5">    .cache()</span>
<span id="cb4-6">)</span></code></pre></div>
</section>
<section id="how-to-not-use-cache-effectively" class="level1">
<h1>How to NOT use cache effectively</h1>
<p>If your notebook have a very sequential logic, then, caching is usually wasteful or a bad idea. Take for example, a notebook that perform the following steps:</p>
<ol type="1">
<li>take DataFrame A, filter it, summarise it, and then, save it.</li>
<li>take DataFrame B, filter it, add new columns, group by and summarise it, and then, send it to the server.</li>
<li>take DataFrame C, filter the essential information you want, save this data into a new CSV file, and then, send this CSV file to an Amazon S3 bucket.</li>
</ol>
<p>If you pay attention to these steps above, you will notice that they are independent from each other. These steps can be performed in any order, because the result from each step does not depend on the results from the other steps.</p>
<p>In a notebook like this, caching any of the three cited DataFrames (A, B or C) is usually unnecessary (or a bad idea), because each of these DataFrames is used only once across the notebook, so there is no really need to cache it. By caching it, you will be wasting not only time, but also, memory space.</p>
<p>Having this in mind, notebooks that have a more complex and interconnected logic are much more suitable candidates for caching. For example, if you have a notebook that produces two DataFrames (B and C) as output, and they both are produced from a JOIN operation with the same DataFrame A, then, it might be worth to cache DataFrame A, so that Spark calculates DataFrame A from scratch only once, instead of two.</p>
<p>Now, another situation where caching might be a bad idea is when you do not have much memory available in your Spark cluster. As an example, let‚Äôs consider that you only had available a cluster with 2 nodes and 8 GB of RAM memory in your Spark environment.</p>
<p>If your notebook is working with a Spark DataFrame whose physical size is 7 GB worth of data, then, it might be a very bad idea to cache this DataFrame, because if you do cache it, then, 7 GB (almost 90%) of your memory will be occupied with the cached data, and this leaves only 1 GB avaialable to perform all the transformations and remaining operations of your notebook.</p>
<p>So caching can be more of a hindrance than a help (especially if you cache multiple DataFrames) when these caches occupy a too big chunk of memory. 1 GB might be (or might be not) enough to perform the remaining tasks in your notebook. But you should not take this risk. In general, when you have a low quantity of memory available, and you cache multiple DataFrames, two things can happen:</p>
<ol type="1">
<li>most likely, your job (or your Spark application) will crash with an <code>OutOfMemory</code> error.</li>
<li>the calculations and transformations become much, much, MUCH slower, because the memory does not have enough space available to perform these calculations in parallel. Your Spark application will succeed, and will produce the output you want‚Ä¶ only many, many, MANY times slower.</li>
</ol>
</section>
<section id="what-happened-with-the-cases-ive-seen" class="level1">
<h1>What happened with the cases I‚Äôve seen</h1>
<p>I recently encountered some cases of jobs failing during runtime because of <code>OutOfMemory</code> errors, that were generated by multiple caching operations that polluted all memory available in the cluster.</p>
<p>I want to use this practical example to demonstrate how caching was badly used in this example. So that you can learn from it.</p>
<p>The notebook I encountered, was essentially responsible for update 3 different tables in our SQL databases, and to do that, this notebook was defining 5 different Spark DataFrames, and all of them were being cached with the <code>cache()</code> DataFrame method.</p>
<p>If I execute this notebook in a more robust Spark cluster, with more worker nodes, with more RAM memory available, then, the notebook just executed fine.</p>
<p>The complete execution of the notebook took around 55 minutes, which is a long time‚Ä¶ But no runtime errors were raised. In essence, no <code>OutOfMemory</code> errors were raised because we were lucky. Because this more robust cluster had enough memory space to hold 5 DataFrames in cache. Figure&nbsp;1 presents this process visually:</p>
<div id="fig-memory2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-memory2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-01-13-spark-cache/memory2.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-memory2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: DataFrames being cached in a more robust Spark cluster
</figcaption>
</figure>
</div>
<p>However, this same notebook was being executed every day by a scheduled job in Databricks (i.e.&nbsp;a Databricks Workflow). But every time this notebook was executed through the scheduled job, it failed with <code>OutOfMemory</code> errors. The scheduled job was being executed by a much smaller cluster, that had only two worder nodes and 8 GB of RAM memory available.</p>
<p>The <code>OutOfMemory</code> errors were being raised right after we cached the third Spark DataFrame (let‚Äôs call this DataFrame of <code>df3</code>) defined in the notebook. So, in summary, what was happening is: Spark was caching each DataFrame defined in the notebook, but on the third DataFrame, the Spark process run out of memory. In other words, we did not had any more memory to do anything!</p>
<p>Figure&nbsp;2 summarizes this process visually:</p>
<div id="fig-memory" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-memory-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2024/2024-01-13-spark-cache/memory.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-memory-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Multiple caches surpassing the limit of memory available in a less robust Spark cluster
</figcaption>
</figure>
</div>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>In essence, using the Spark DataFrame <code>cache()</code> method can improve the performance of your Spark application. But you should be careful when using this resource, because it can be more of a hindrance than a help, depending on how you use it.</p>
<p>As a good rule of thumb, you usually want to use caches in Spark when:</p>
<ul>
<li>Constantly use the same DataFrame over the notebook.</li>
<li>Frequently access a subset of a DataFrame.</li>
</ul>
<p>In this article I also presented a situation where caches were responsible for crashing a Spark application, as a real example on how caches can be harmful.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-pedro2024" class="csl-entry">
Faria, Pedro Duarte. 2024. <em>Introduction to Pyspark</em>. 1st ed. Belo Horizonte. <a href="https://pedropark99.github.io/Introd-pyspark/">https://pedropark99.github.io/Introd-pyspark/</a>.
</div>
<div id="ref-patidar2023" class="csl-entry">
Patidar, Charchit. 2023. <span>‚ÄúHow Cache Works in Apache Spark.‚Äù</span> <a href="https://medium.com/@charchitpatidar/how-cache-works-in-apache-spark-aea6eeb3fd03">https://medium.com/@charchitpatidar/how-cache-works-in-apache-spark-aea6eeb3fd03</a>.
</div>
</div></section></div> ]]></description>
  <category>Apache Spark</category>
  <category>Performance</category>
  <guid>https://pedro-faria.netlify.app/posts/2024/2024-01-13-spark-cache/en/</guid>
  <pubDate>Sat, 13 Jan 2024 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2024/2024-01-13-spark-cache/memory.svg" medium="image" type="image/svg+xml"/>
</item>
<item>
  <title>Introduction to pyspark</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/publications/book/introd-pyspark/en/</link>
  <description><![CDATA[ 





<section id="about-the-book" class="level1">
<h1>About the book</h1>
<p>This book is for anyone who wants to learn quickly how to use <code>pyspark</code> to effectively load, process, and transform large volumes of data using Python.</p>
<p><a href="https://www.amazon.com/dp/B0CRYMVWDN"> <button type="button" class="btn btn-primary">Buy a copy of the book!</button></a> <a href="https://pedropark99.github.io/Introd-pyspark/"> <button type="button" class="btn btn-primary">Read online</button></a> <a href="https://github.com/pedropark99/Introd-pyspark"> <button type="button" class="btn btn-primary">Official repository</button></a></p>
<p>In more detail, this is a quick and introductory book about <code>pyspark</code>, which is the Python API for Apache Spark. Apache Spark is the de facto standard engine for big-data analytics. It is largely used to build data processing, data ingestion, and machine learning applications that process very large volumes of data.</p>
<p>One of the many reasons why Apache Spark became popular is because of its APIs. You can build Spark applications using different programming languages, such as Python, R, and Scala. But this book focuses solely on the Python API.</p>
<p>In this book, you will learn about:</p>
<ul>
<li>How an Apache Spark application works?</li>
<li>What are Spark DataFrames?</li>
<li>How to build, transform and model your Spark DataFrame.</li>
<li>How to import data into (or export data out of) Apache Spark.</li>
<li>How to work with SQL inside pyspark.</li>
<li>Tools for manipulating specific data types (e.g.&nbsp;strings, dates and datetimes).</li>
<li>How to use window functions.</li>
</ul>
</section>
<section id="motivation-for-the-book" class="level1">
<h1>Motivation for the book</h1>
<p>In summary, this book aims to give a solid introduction (for python and not python users) to the <code>pyspark</code> package, and on how to use it to build Spark applications for data pipelines and interactive data analysis.</p>
<p>Although we have a good range of materials about Apache Spark in general, such as <span class="citation" data-cites="damji2020">Damji et al. (2020)</span> and <span class="citation" data-cites="chambers2018">Chambers and Zaharia (2018)</span>, we do not have much abundance of materials about the APIs of Spark in ‚Äúforeign‚Äù languages, like the Python (<code>pyspark</code>) and R (<code>SparkR</code>) APIs.</p>
<p>The reason for this is simple: the Spark API have a consistent structure across all languages. As consequence, a general book about Spark can fairly cover all languages at once. In other words, Spark code in Scala can be easily translated into python code with <code>pyspark</code>. Because the structure of the code is very similar between all languages.</p>
<p>So why this book? First, Python is a more popular and friendly language than Scala or Java. If the reader is not interested in learning Java or Scala, why show Java/Scala code to him? Is very important to focus solely on what interest the reader, specially if it is in a language that he is familiar with. Second, I had some time to spent, and a lot of practical experience with <code>pyspark</code> on production to share (so‚Ä¶ why not write a book about it?).</p>
</section>
<section id="cover" class="level1">
<h1>Cover</h1>
<p><img src="https://pedro-faria.netlify.app/publications/book/introd-pyspark/featured.png" class="img-fluid" style="width:100.0%"></p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-chambers2018" class="csl-entry">
Chambers, Bill, and Matei Zaharia. 2018. <em>Spark: The Definitive Guide: Big Data Processing Made Simple</em>. Sebastopol, CA: O‚ÄôReilly Media.
</div>
<div id="ref-damji2020" class="csl-entry">
Damji, Jules, Brooke Wenig, Tathagata Das, and Denny Lee. 2020. <em>Learning Spark: Lightning-Fast Data Analytics</em>. Sebastopol, CA: O‚ÄôReilly Media.
</div>
</div></section></div> ]]></description>
  <category>Python</category>
  <category>Apache Spark</category>
  <category>Book</category>
  <guid>https://pedro-faria.netlify.app/publications/book/introd-pyspark/en/</guid>
  <pubDate>Tue, 09 Jan 2024 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/publications/book/introd-pyspark/featured.png" medium="image" type="image/png" height="215" width="144"/>
</item>
<item>
  <title>My experience with Typst, the potential sucessor of LaTex</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-12-31-introducing-typst/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Typst is a new markup-based typesetting system for the sciences written in Rust. The Typst works similarly to other typesetting systems. In resume, you write a Typst source file which describes the document you want to create, and then, you invoke the Typst compiler to build the document you described in the source file.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-12-31-introducing-typst/typst-process.svg" class="img-fluid figure-img"></p>
<figcaption>Producing documents with Typst</figcaption>
</figure>
</div>
<p>Typst is open-source and is freely available at GitHub, just <a href="https://github.com/typst/typst/releases/">download the release file according to your operational system</a> and install the tool into your system.</p>
</section>
<section id="what-i-like-about-typst" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> What I like about Typst</h1>
<p>First of all, Typst is an amazing tool! So let me describe the features about it that I like the most.</p>
<section id="have-good-documentation" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="have-good-documentation"><span class="header-section-number">2.1</span> Have good documentation!</h2>
<p><a href="https://typst.app/docs/">Typst have a very good documentation</a>, and this makes all the difference in the world! Because learning how to use the tool becomes so much easier when you have a good support material to rely on.</p>
</section>
<section id="have-fast-compilation-time" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="have-fast-compilation-time"><span class="header-section-number">2.2</span> Have fast compilation time!</h2>
<p>LaTex have a known weakness of being slow to compile the input file and producing the output PDF. Typst does not suffer from this problem, because it has a much faster compilation time.</p>
<p>Compiling a very small Typst document takes about 0.05s in my machine, while compiling essentially the same document in LaTex take 0,26s:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> time typst compile example.typ</span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">0,05s</span> user 0,06s system 88% cpu 0,121 total</span></code></pre></div>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> time xelatex example.tex</span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">0,26s</span> user 0,16s system 80% cpu 0,522 total</span></code></pre></div>
<p>This is an important advantage of Typst, because it delivers a much faster feedback loop into your workflow. In other words, if you reduce the compilation time, you will spend less time waiting to see if your code works! By spending less time trying to see the output of your work, you can spend more time in what really matters! Like writing more content or refining your work.</p>
</section>
<section id="understandable-error-messages" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="understandable-error-messages"><span class="header-section-number">2.3</span> Understandable error messages</h2>
<p>For me personally, one of the great weaknesses of LaTex is it‚Äôs error messages, which are very obscure, and honestly, useless in the majority of cases. And I mean this.</p>
<p>In contrast, Typst have much more understandable error messages. Messages that are easy to understand, and that are easy to relate back to your source code. Take this error messages from Typst as an example:</p>
<pre class="typst"><code>error: the character `#` is not valid in code
  ‚îå‚îÄ posts/2023/2023-12-31-introducing-typst/example.typ:2:3
  ‚îÇ
2 ‚îÇ    #set text(font: "Inconsolata")
  ‚îÇ    ^</code></pre>
<p>Or maybe this other error message:</p>
<pre class="typst"><code>error: expected function, found content
  ‚îå‚îÄ posts/2023/2023-12-31-introducing-typst/example.typ:1:19
  ‚îÇ  
1 ‚îÇ   #show raw: code =&gt; {
  ‚îÇ ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ^
2 ‚îÇ ‚îÇ    set text(font: "Inconsolata")
3 ‚îÇ ‚îÇ }[#code]
  ‚îÇ ‚ï∞‚îÄ^

help: error occurred while applying show rule to this raw
  ‚îå‚îÄ posts/2023/2023-12-31-introducing-typst/example.typ:7:16
  ‚îÇ
7 ‚îÇ Testing if this `raw code element` uses the show rule.
  ‚îÇ                 ^^^^^^^^^^^^^^^^^^
</code></pre>
</section>
<section id="very-good-quality-output" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="very-good-quality-output"><span class="header-section-number">2.4</span> Very good quality output</h2>
<p>LaTex is known for producing very-high quality documents, and Typst leaves nothing to be desired in this aspect. Specially because the Typst development team ported some of the core algorithms behind LaTex into Typst.</p>
<p>So Typst also produces very-high quality documents because it learned from the great powers of LaTex.</p>
</section>
<section id="preview-and-incremental-compilation" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="preview-and-incremental-compilation"><span class="header-section-number">2.5</span> Preview and Incremental compilation</h2>
<p>Typst have a preview mode which is very good and powerful. There is a <a href="https://typst.app/assets/videos/mockup.webm">great video in Typst‚Äôs website</a> that demonstrates it.</p>
<p>When you use this preview mode, Typst create a new window that shows the preview of the output document of your source code, and any changes that you make to your source code are instantly reflected (pratically in real time) into the previewed document.</p>
<p>This preview in real time of the output document is very good when you are trying to refine the aesthetics of your document, but you are not very sure yet on how to do it properly, and you want to test different options.</p>
<p>This power from the preview mode is only possible, because Typst has an incremental compilation engine inside Typst compiler, which is capable of compiling just the section of your code your changed, instead of recompiling the entire source file, and regenerate the entire PDF output again.</p>
</section>
<section id="show-rules-are-awesome" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="show-rules-are-awesome"><span class="header-section-number">2.6</span> Show rules are awesome!</h2>
<p>Show rules with the <code>#show</code> directive are an amazing way of customizing specific elements of your document. But the true power of <code>#show</code> directives is that you can write more clear and organized code with them.</p>
<p>When you want some parts of your document to have, for example, font Inconsolata with size 14pt, and other parts of the same document to have completely different settings, like font Times New Roman size 12pt, and coloured red, you usually end up redefining these settings over and over again.</p>
<p>You might for example set a ‚Äúdefault setting‚Äù to be applied over the entire document. Then, you overrule this default setting by setting specific settings every time that a specific element appears across the document. So you end up with a lot of duplicated code, that redefines the same settings over and over again, across the entire source file.</p>
<p>Show rules with the <code>#show</code> directive eliminates this necessitty by allowing you to specify a set of settings to be applied to every element of type <code>x</code> that appears in your document. As an example, if I want to use font Inconsolata size 14pt in any raw code that is exposed inside my document, I can set a show rule to be applied over any element of type <code>raw</code>, like this:</p>
<pre class="typst"><code>#show raw: code =&gt; {
   set text(font: "Inconsolata", size : 14pt)
   code
}

Testing if this `raw code element` uses the show rule.</code></pre>
<p>With the show rule that I created above, any raw code that I create across my Typst document will be rendered in the PDF output using font Inconsolata size 14pt. To some extent, show rules in Typst are almost like CSS code that uses CSS selectors to apply certain rules to specific HTML elements.</p>
</section>
<section id="reusing-code-is-much-easier" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="reusing-code-is-much-easier"><span class="header-section-number">2.7</span> Reusing code is much easier</h2>
<p>Reusing code or settings across different parts in your document in Typst is much more straightforward than it is in LaTex. Because is very easy to create functions in Typst, or show rules that can spread a piece of code over multiple locations of your document.</p>
<p>In other words, Typst looks like a real programming language. You can easily create functions in Typst to reuse the same piece of code. In contrast, in LaTex, there is no notion of functions per se, you have macros instead. When you want to reuse a piece of code , you normally you create new commands (with the <code>\newcommand</code> macro). This makes LaTex code harder to read and to comprehend in my opinion.</p>
</section>
<section id="csl-is-now-available-in-typst" class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="csl-is-now-available-in-typst"><span class="header-section-number">2.8</span> CSL is now available in Typst!</h2>
<p>Typst is very young, and until very recently, the use of different citation styles was very limited. But on the most recent version of Typst, a CSL (Citation Style Language) processor was added! And as consequence, we can use now any possible citation style in Typst documents by providing a CSL file to the <a href="https://typst.app/docs/reference/model/bibliography/"><code>style</code> argument of the <code>bibliography()</code> function</a> to be processed in conjunction with the Typst source file.</p>
<p>For example, in Brazil, academia have very rigorous rules about how citation should be written in a scientific article, and these rules are specified by the norms produced by the ABNT (<em>Brazilian Agency of Technical Norms</em>) agency. Now, with the new additions to Typst, we can easily write citations using the brazilian ABNT citation style, by providing a CSL file like the <a href="https://insumo.ibict.br/produtos/csl-ibict/">CSL styles produced by IBICT - <em>Brazilian Institute for Science and Technology Information</em></a>.</p>
</section>
<section id="syntax-similar-to-markdown" class="level2" data-number="2.9">
<h2 data-number="2.9" class="anchored" data-anchor-id="syntax-similar-to-markdown"><span class="header-section-number">2.9</span> Syntax similar to Markdown</h2>
<p>Typst have a markup language whose syntax is similar to Markdown. And this is a great thing. Because the markup language in LaTex is‚Ä¶., well, it is not awfull to write, but it produces an awfull visual mess in the text you write.</p>
<p>For example, if your write some text in LaTex that have a lot of emphasized words, you need to add a lot of <code>\textbf{}</code> or <code>\emph{}</code> macros in it, and, as a result, your text looks very messy. In typst, you just surround each word by stars (<code>*</code>), and, as consequence, you leave much less visual noise in your text. In other words, your text looks cleaner (or clearer) in Typst.</p>
</section>
</section>
<section id="conclusion" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Conclusion</h1>
<p>Typst is now a really great alternative to LaTex to compose scientific articles, or just any type of good PDF document. I did not find anything about Typst that I don‚Äôt like yet. So, my fisrt impressions on the system are only positive, and I think Typst has a great future ahead of it.</p>
<p>If you use LaTex a lot, and are not familiar yet with Typst, I highly recommend you to at least try it, and see what you think. Peace‚úåÔ∏è !</p>


</section>

 ]]></description>
  <category>Typst</category>
  <category>Typesetting system</category>
  <category>Documents</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-12-31-introducing-typst/en/</guid>
  <pubDate>Sun, 31 Dec 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-12-31-introducing-typst/post-back.svg" medium="image" type="image/svg+xml"/>
</item>
<item>
  <title>NeoVim commands and shortcuts cheatsheet</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-12-29-vim-cheatsheet/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p><a href="./../cheatsheet.pdf"> <button type="button" class="btn btn-primary">Access Cheatsheet PDF</button></a></p>
<p>NeoVim is a highly extensible and ‚Äúkeyboard-based‚Äù text editor. Many consider NeoVim as an evolution of the famous Vim text editor, with focus on extensibility.</p>
<p>What really makes NeoVim (and also Vim) an extremely powerful editor are the Vim commands and keyboards shortcuts. To make my life easier, I decided to write a quick cheatsheet that contains all of the Vim commands and keyboard shortcuts that I use the most.</p>


</section>

 ]]></description>
  <category>NeoVim</category>
  <category>Vim</category>
  <category>Cheatsheet</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-12-29-vim-cheatsheet/en/</guid>
  <pubDate>Sat, 30 Dec 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-12-29-vim-cheatsheet/post-image.png" medium="image" type="image/png" height="81" width="144"/>
</item>
<item>
  <title>How strings work in Zig?</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-12-12-zig-strings/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Zig is a new general-purpose and low level programming language that is being very promising. The documentation of the language<sup>1</sup> is very good in quality, but I missed some more specific details about strings in there.</p>
<p>That is why, I decided to write this article, to discuss in more depth how strings work in Zig, and give you some more specific details about it.</p>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script type="text/javascript" src="https://notabug.org/Ash/highlightjs-zig/raw/master/dist/zig.min.js"></script>


<script>hljs.highlightAll();</script>
</section>
<section id="what-strings-in-zig-are" class="level1">
<h1>What strings in Zig are?</h1>
<p>In Zig, a string literal (or a string object if you prefer) is a pointer to a null-terminated array of bytes. Each byte in this array is represented by an <code>u8</code> value, which is an unsigned 8 bit integer.</p>
<p>Zig always assumes that this sequence of bytes is UTF-8 encoded. This might not be true for every sequence of bytes you have it, but is not really Zig‚Äôs job to fix the encoding of your string (you can use <code>iconv</code> for that). Today, most of text data in our modern world should be UTF-8 encoded. So if your string literal is not UTF-8 encoded, then, you will probably have problems in Zig.</p>
<p>Let‚Äôs take for example the word ‚ÄúHello‚Äù. In UTF-8, this sequence of characters (H, e, l, l, o) is represented by the sequence of decimal numbers 72, 101, 108, 108, 111. In xecadecimal, this is the sequence <code>0x48</code>, <code>0x65</code>, <code>0x6C</code>, <code>0x6C</code>, <code>0x6F</code>. So if I take this sequence of hexadecimal values, and ask Zig to print this sequence of bytes as a sequence of characters (i.e.&nbsp;a string), then, the text ‚ÄúHello‚Äù will be printed into the terminal:</p>
<pre><code class="zig">const std = @import("std");

pub fn main() !void {
    const bytes = [_]u8{0x48, 0x65, 0x6C, 0x6C, 0x6F};
    std.debug.print("{s}\n", .{bytes});
}
</code></pre>
<pre class="text"><code>Hello</code></pre>
<p>If you want to see the actual bytes that represents a string in Zig, you can use a for loop to loop trough each byte in the string, and ask Zig to print each byte as an hexadecimal value to the terminal, using a <code>print()</code> statement with the <code>X</code> formatting specifier. Like this:</p>
<pre><code class="zig">const std = @import("std");

pub fn main() !void {
    const string_literal = "This is an example of string literal in Zig";
    std.debug.print("Bytes that represents the string object: ", .{});
    for (string_literal) |byte| {
        std.debug.print("{X} ", .{byte});
    }
    std.debug.print("\n", .{});
}
</code></pre>
<pre class="text"><code>Bytes that represents the string object: 54 68 69 73 20 69 73 20 61 6E 20 65 78 61 6D 70 6C 65 20 6F 66 20 73 74 72 69 6E 67 20 6C 69 74 65 72 61 6C 20 69 6E 20 5A 69 67 </code></pre>
</section>
<section id="strings-in-c" class="level1">
<h1>Strings in C</h1>
<p>This is very similar to how C treats strings as well. That is, string values in C are also treated internally as an array of bytes, and this array is also null-terminated.</p>
<p>But one key difference between a Zig string and a C string, is that Zig also stores the length of the array inside the string object. This small detail makes your code safer, because is much easier for the Zig compiler to check if you are trying to access an element out of bounds, or if your trying to access memory that does not belong to you.</p>
<p>To achieve this same kind of safety in C, you have to do a lot of work, that kind of seems pointless. So getting this kind of safety is not automatic and much harder to do in C. For example, if you want to track the length of your string troughout your program in C, then, you first need to loop through the array of bytes that represents this string, and find the null element (<code>'\0'</code>) position to discover where exactly the array ends, or, in other words, to find how much elements the array of bytes contain.</p>
<p>To do that, you would need something like this in C. In this example, the C string is 25 bytes long:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdio.h&gt;</span></span>
<span id="cb3-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> array <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"An example of string in C"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-9">        index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb3-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-11">    printf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of elements in the array: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<pre class="text"><code>Number of elements in the array: 25</code></pre>
<p>But in Zig, you do not have to do this, because the object already contains a <code>len</code> field which stores the length information of the array. As an example, the <code>string_literal</code> object below is 43 bytes long:</p>
<pre><code class="zig">const std = @import("std");

pub fn main() !void {
    const string_literal = "This is an example of string literal in Zig";
    std.debug.print("{d}\n", .{string_literal.len});
}
</code></pre>
<pre class="text"><code>43</code></pre>
</section>
<section id="a-better-look-at-the-object-type" class="level1">
<h1>A better look at the object type</h1>
<p>Now, we can inspect better the type of objects that Zig create. To check the type of any object in Zig, you can use the <code>@TypeOf()</code> function.</p>
<p>If we look at the type of the <code>simple_array</code> object below, you will find that this object is a array of 4 elements. Each element is a signed integer of 32 bits (<code>i32</code>). That is what an object of type <code>[4]i32</code> is.</p>
<p>But if we look closely at the type of the <code>string_literal</code> object below, you will find that this object is a constant pointer (<code>*const</code>) to an array of 43 elements (or 43 bytes). Each element is a single byte (more precisely, an unsigned 8 bit integer), that is why we have the <code>[43:0]u8</code> portion of the type below. In other words, the string stored inside the <code>string_literal</code> object is 43 bytes long. That is why you have the type <code>*const [43:0]u8</code> below.</p>
<p>Now, if we create an pointer to the array object, then, we get a constant pointer to an array of 4 elements (<code>*const [4]i32</code>), which is very similar to the type of the <code>string_literal</code> object. This demonstrates that a string object (or a string literal) in Zig is already a pointer to an array.</p>
<p>Just remember that a ‚Äúpointer to an array‚Äù is different than an ‚Äúarray‚Äù. So a string object in Zig is a pointer to an array of bytes, and not simply an array of bytes.</p>
<pre><code class="zig">const std = @import("std");
const print = std.debug.print;

pub fn main() !void {
    const string_literal = "This is an example of string literal in Zig";
    const simple_array = [_]i32{1, 2, 3, 4};


    print("Type of array object: {}\n", .{@TypeOf(simple_array)});
    print("Type of string object: {}\n", .{@TypeOf(string_literal)});
    print("Type of a pointer that points to the array object: {}\n", .{@TypeOf(&amp;simple_array)});
}
</code></pre>
<pre class="text"><code>Type of array object: [4]i32
Type of string object: *const [43:0]u8
Type of a pointer that points to the array object: *const [4]i32</code></pre>
</section>
<section id="byte-vs-unicode-points" class="level1">
<h1>Byte vs unicode points</h1>
<p>Is important to point out that each byte in the array is not necessarily a single character. This fact arises from the difference between a single byte and a single unicode point.</p>
<p>The encoding UTF-8 works by assigning a number (which is called a <em>unicode point</em>) to each character in the string. For example, the character ‚ÄúH‚Äù is stored in UTF-8 as the decimal number 72. This means that the number 72 is the unicode point for the character ‚ÄúH‚Äù. Each possible character that can appear in a UTF-8 encoded string have its own unicode point.</p>
<p>For example, the Latin Capital Letter A With Stroke (»∫) is represented by the number (or the unicode point) 570. However, this decimal number (570) is higher than the maximum number stored inside a single byte, which is 255. In other words, the maximum decimal number that can be represented with a single byte is 255. That is why, the unicode point 570 is actually stored inside the computer‚Äôs memory as the bytes <code>C8 BA</code>.</p>
<pre><code class="zig">const std = @import("std");

pub fn main() !void {
    const string_literal = "»∫";
    std.debug.print("Bytes that represents the string object: ", .{});
    for (string_literal) |char| {
        std.debug.print("{X} ", .{char});
    }
    std.debug.print("\n", .{});
}
</code></pre>
<pre class="text"><code>Bytes that represents the string object: C8 BA</code></pre>
<p>This means that to store the character »∫ in an UTF-8 encoded string, we need to use two bytes together to represent the number 570. That is why the relationship between bytes and unicode points is not always 1 to 1. Each unicode point is a single character in the string, but not always a single byte corresponds to a single unicode point.</p>
<p>All of this means that if you loop trough the elements of a string in Zig, you will be looping through the bytes that represents that string, and not through the characters of that string. In the »∫ example above, the for loop needed two iterations (instead of a single iteration) to print the two bytes that represents this »∫ letter.</p>
<p>Now, all english letters (or ASCII letters if you prefer) can be represented by a single byte in UTF-8. As a consequence, if your UTF-8 string contains only english letters (or ASCII letters), then, you are lucky. Because the number of bytes will be equal to the number of characters in that string. In other words, in this specific situation, the relationship between bytes and unicode points is 1 to 1.</p>
<p>But on the other side, if your string contains other types of letters‚Ä¶ for example, you might be working with text data that contains, chinese, japanese or latin letters, then, the number of bytes necessary to represent your UTF-8 string will likely be much higher than the number of characters in that string.</p>
<p>If you need to iterate through the characters of a string, instead of its bytes, then, you can use the <code>std.unicode.Utf8View</code> struct to create an iterator that iterates through the unicode points of your string.</p>
<p>In the example below, we loop through the japanese characters ‚Äú„Ç¢„É°„É™„Ç´‚Äù. Each of the four characters in this string is represented by three bytes. But the for loop iterates four times, one iteration for each character/unicode point in this string:</p>
<pre><code class="zig">const std = @import("std");

pub fn main() !void {
    var utf8 = (try std.unicode.Utf8View.init("„Ç¢„É°„É™„Ç´")).iterator();
    while (utf8.nextCodepointSlice()) |codepoint| {
        std.debug.print("got codepoint {}\n", .{std.fmt.fmtSliceHexUpper(codepoint)});
    }
}
</code></pre>
<pre class="text"><code>got codepoint E382A2
got codepoint E383A1
got codepoint E383AA
got codepoint E382AB</code></pre>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><a href="https://ziglang.org/documentation/0.11.0/" class="uri">https://ziglang.org/documentation/0.11.0/</a>.‚Ü©Ô∏é</p></li>
</ol>
</section></div> ]]></description>
  <category>Zig</category>
  <category>Strings</category>
  <category>Encoding</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-12-12-zig-strings/en/</guid>
  <pubDate>Tue, 12 Dec 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-12-12-zig-strings/zig-image.png" medium="image" type="image/png" height="60" width="144"/>
</item>
<item>
  <title>Developing a parser for Python with Python</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-11-18-python-parser/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Me and my team are currently working in a massive migration (similar to a cloud migration). This migration involves many process, but one of them is to redirect every table reference that we find in more than <strong>130 thousand lines of Python code</strong>.</p>
<p>However, this task proved to be so complex that I had to develop a small parser for Python expressions. In this article, I want to use this experience to introduce the subject of parsing expressions to beginners.</p>
</section>
<section id="sec-context" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Context about what we have to do</h1>
<p>Most of these 130 thousand lines of Python code are <a href="https://spark.apache.org/docs/latest/api/python/index.html"><code>pyspark</code></a> code to extract, transform and load data using the <a href="https://spark.apache.org/">Apache Spark</a> engine.</p>
<p>Let‚Äôs consider the following example:</p>
<div id="lst-table" class="python listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-table-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;1: Example of pyspark code that we might find in our codebase
</figcaption>
<div aria-describedby="lst-table-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode" id="lst-table" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-table-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pyspark.sql <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SparkSession</span>
<span id="lst-table-2">spark <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SparkSession.builder.getOrCreate()</span>
<span id="lst-table-3"></span>
<span id="lst-table-4">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spark.table(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blip.events"</span>)</span>
<span id="lst-table-5">df.show()</span></code></pre></div>
</div>
</figure>
</div>
<p>You can see at Listing&nbsp;1 that we have a <code>spark.table()</code> call to access the SQL table <code>blip.events</code>. In other words, we are basically making a <code>SELECT * FROM</code> query over this table. However, in our new infrastructure, all table references will change. As a result, me and my team need to rewrite every table reference that we find across our codebase.</p>
<p>For example, let‚Äôs suppose that the new table reference is <code>platform.blipraw.events</code>. This means that I need to alter the above snippet of code to:</p>
<div id="lst-table2" class="python listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-table2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;2: Example with the new reference
</figcaption>
<div aria-describedby="lst-table2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode" id="lst-table2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-table2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pyspark.sql <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SparkSession</span>
<span id="lst-table2-2">spark <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SparkSession.builder.getOrCreate()</span>
<span id="lst-table2-3"></span>
<span id="lst-table2-4">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spark.table(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"platform.blipraw.events"</span>)</span>
<span id="lst-table2-5">df.show()</span></code></pre></div>
</div>
</figure>
</div>
<section id="the-quick-and-dirty-approach" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="the-quick-and-dirty-approach"><span class="header-section-number">2.1</span> The quick and dirty approach</h2>
<p>This does not look so bad, right? I mean, considering the above example, I could just use a simple REGEX (<em>regular expression</em>) to find the places where I have an <code>spark.table()</code> call, capture the reference given as input, alter it to the new reference, and replace the text with the new reference.</p>
<p>This approach would involve some code similar to this:</p>
<div id="c7f1a663" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb1-2">notebook_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''from pyspark.sql import SparkSession</span></span>
<span id="cb1-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">spark = SparkSession.builder.getOrCreate()</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">df = spark.table("blip.events")</span></span>
<span id="cb1-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">df.show()</span></span>
<span id="cb1-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span>
<span id="cb1-8"></span>
<span id="cb1-9">spark_table_regex <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'spark[.]table[(][a-zA-Z0-9.\'\"]+[)]'</span></span>
<span id="cb1-10">new_table_call <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spark.table(</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">platform.blipraw.events</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span></span>
<span id="cb1-11">new_notebook_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(spark_table_regex, new_table_call, notebook_content)</span>
<span id="cb1-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(new_notebook_content)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>from pyspark.sql import SparkSession
spark = SparkSession.builder.getOrCreate()

df = spark.table("platform.blipraw.events")
df.show()
</code></pre>
</div>
</div>
</section>
<section id="sec-challenge" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="sec-challenge"><span class="header-section-number">2.2</span> The size of the challenge</h2>
<p>It would be great if it was that simple, but unfortunately, it is not. What makes this problem so challenging is that the table reference used in <code>spark.table()</code> appears in too many different formats across the 130 thousand lines in our codebase. For example, we might use a <em>formatted string</em> to actually compute the table reference:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">database <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blip"</span></span>
<span id="cb3-2">table_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"events"</span></span>
<span id="cb3-3">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spark.table(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>database<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>table_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<p>Or maybe, we call a variable that contains the computed reference:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">table_ref <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> database <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> table_name</span>
<span id="cb4-2">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spark.table(table_ref)</span></code></pre></div>
<p>These two examples demonstrates that too much variation exists in the use of a table reference. So much variation, that using multiple REGEX‚Äôs to solve this problem would be impractical, and probably too much complex.</p>
<p>Here is where the parser comes into place.</p>
</section>
</section>
<section id="introducing-the-parser" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Introducing the parser</h1>
<section id="what-is-a-parser" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="what-is-a-parser"><span class="header-section-number">3.1</span> What is a parser?</h2>
<p>Parsers (or the process of parsing expressions) are core components of every existing compiler, like <code>gcc</code> or <code>rustc</code>, as well as the R and Python compilers. In essence, a parser is a piece of software that analyzes expressions following the rules of a grammar. A parser is the main part of compilers responsible for analyzing and comprehend the structure of your source code.</p>
<p>The process of parsing is usually made in two steps, which are: 1) breaking (or ‚Äúsplitting‚Äù) the input expression into smaller pieces, building a list of tokens, or a list of small components; 2) analyzing this sequence of tokens to build a tree that is equivalent to the input expression. The first step above is usually made by a component called <em>lexer</em> or <em>tokenizer</em> (both names are commom to find), and the second step is made by the parser itself.</p>
<p>Basically, the process of parsing takes a string (which contains the expression, or the source code your want to parse) as input. Then, the lexer (or tokenizer) breaks the input string into smaller pieces, which are usually called <em>tokens</em>. Then, the parser receives this stream of tokens produced by the tokenizer as input, and starts to analyze this sequence of tokens, to understand the structure of the input expression (or source code). As output, the parser produces a tree that is equivalent to the input expression, which is usually called <em>abstract syntax tree</em> (or AST for short). Figure&nbsp;1 below exposes this process.</p>
<div id="fig-parser-pic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-parser-pic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2023/2023-11-18-python-parser/parser-pic.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-parser-pic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: The process of parsing
</figcaption>
</figure>
</div>
<p>So the process of parsing takes an expression as input, and builds a tree that is equivalent to that expression as output. This process of parsing is always one of the first operations that a compiler performs.</p>
<p>Because trees are a much more suitable and efficient data structure for the different tasks a compiler performs such as: type and syntax checking, evaluating the result of expressions and assignments, or compiling the input tree into machine code to be executed.</p>
<p>Probably, the most important data structures for every compiler are trees and stacks.</p>
</section>
<section id="sec-kind" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sec-kind"><span class="header-section-number">3.2</span> What kind of expressions we want to parse?</h2>
<p>Just to be clear, we neither need (or want) to develop a complete parser capable of parsing every expression in the Python language. That would be a much larger task, that would involve a great amount of effort. We just want to build a small parser capable of parsing a very small and specific subset of Python expressions.</p>
<p>We are particularly interested in the expressions that are related to the table references that we find in our codebase. We already showed examples of these expressions at Section&nbsp;2 and Section&nbsp;2.2.</p>
<p>But just to state clearly, we want to build a parser capable of parsing:</p>
<ol type="1">
<li>expressions that involves only string constants (other types of constants or structures such as lists, integers, booleans are not important for us, so let‚Äôs ignore them). Example: <code>"platform.blipraw.events"</code>.</li>
<li>expressions that concatenate strings with the plus operator. Example: <code>"blip" + "." + "events"</code>.</li>
<li>expressions that contains identifiers (that is, variable names). Example: <code>database + "." + table_name</code>.</li>
<li>formatted strings which contain expressions that fit the above cases. Example: <code>f"{database}.{table_name}"</code>.</li>
</ol>
<p>Lets store these examples of expressions inside a list that we can easily access:</p>
<div id="91604672" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">EXPRESSION_EXAMPLES <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'platform.blipraw.events'"</span>,</span>
<span id="cb5-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'"blip" + "." + "events"'</span>,</span>
<span id="cb5-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"database + </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> + table_name"</span>,</span>
<span id="cb5-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{database}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{table_name}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'</span></span>
<span id="cb5-6">]</span></code></pre></div>
</div>
</section>
<section id="building-the-lexer-or-tokenizer" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="building-the-lexer-or-tokenizer"><span class="header-section-number">3.3</span> Building the Lexer (or Tokenizer)</h2>
<p>Lets begin by building a lexer (or tokenizer) for our parser. Just be aware that, from now on, I will use the term tokenizer instead of lexer (this is just a personal preference).</p>
<p>But how can we split our input string into small pieces? Well, there are different approaches to do this. However, one particular approach that fit‚Äôs perfectly our example here is to iterate through the characters of our input string, and look for single characters that represent ‚Äúelegible break points‚Äù, or points where we can split the string.</p>
<p>This approach is probably the easiest of all to implement, and it fit‚Äôs perfectly our example here because we are interested in parsing just a very small subset of simple Python expressions. If we wanted to parse more complex expressions, then, it would probably be better to use another approach to break the input string.</p>
<p>So, the tokenizer will iterate through each character in the input string, and will mark any place that contains a single character the we interpret as an elegible place to break the string. Considering the type of expressions we stated at Section&nbsp;3.2, the characters <code>"</code>, <code>'</code>, <code>+</code>, <code>{</code>, <code>}</code> are good candidates for ‚Äúelegible break points‚Äù. Also, the character <code>f</code> is important for identifying formatted strings, as a consequence, he is also a good candidate.</p>
<p>Let‚Äôs consider the following tokenizer:</p>
<div id="lst-tokenizer" class="python listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-tokenizer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;3: The function that represents our tokenizer
</figcaption>
<div aria-describedby="lst-tokenizer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode" id="lst-tokenizer" style="background: #f1f3f5;"><pre class="sourceCode code-annotation-code python code-with-copy"><code class="sourceCode python"><span id="lst-tokenizer-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List</span>
<span id="lst-tokenizer-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="lst-tokenizer-3"></span>
<span id="lst-tokenizer-4">is_not_blank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> re.search(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"^ +$"</span>, x)</span>
<span id="lst-tokenizer-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> tokenizer(input_string: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]:</span>
<span id="lst-tokenizer-6">    candidates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'"'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'+'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'{'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'}'</span>]</span>
<span id="lst-tokenizer-7">    break_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="lst-tokenizer-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(input_string)):</span>
<span id="lst-tokenizer-9">        current_char <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> input_string[i]</span>
<span id="lst-tokenizer-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> current_char <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> candidates:</span>
<span id="lst-tokenizer-11">            break_points.append(i)</span>
<span id="lst-tokenizer-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> current_char <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"f"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> (i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(input_string):</span>
<span id="lst-tokenizer-13">            next_char <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> input_string[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="lst-tokenizer-14">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> next_char <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'"'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'"</span>]:</span>
<span id="lst-tokenizer-15">                break_points.append(i)</span>
<span id="lst-tokenizer-16"></span>
<span id="lst-tokenizer-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(break_points) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="lst-tokenizer-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [input_string]</span>
<span id="lst-tokenizer-19"></span>
<span id="lst-tokenizer-20">    tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="lst-tokenizer-21">    last_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="lst-tokenizer-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> index <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> break_points:</span>
<span id="lst-tokenizer-23">        tokens.append(input_string[last_index:index])</span>
<span id="lst-tokenizer-24">        tokens.append(input_string[index:(index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)])</span>
<span id="lst-tokenizer-25">        last_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="lst-tokenizer-26"></span>
<span id="lst-tokenizer-27">    tokens.append(input_string[last_index:])</span>
<span id="lst-tokenizer-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(is_not_blank, tokens))</span></code></pre></div>
</div>
</figure>
</div>
<ol type="1">
<li><p>If current character is <code>f</code> check if the next character is the beginning of a string (characters <code>"</code> and <code>'</code>), if it is the beginning of a string, then, it is a formatted string and should be included in the ‚Äúbreak points‚Äù. If the next character is not the beginning of a string, then, we should not consider it as an elegible breakpoint, because it probably is just a letter ‚Äúf‚Äù inside a variable name, such as <code>platform_database</code>.</p></li>
<li><p>If no break point position was found, then, the input expression is likely an expression with a single component. For example, a single string constant (e.g.&nbsp;<code>"blip.events"</code>) or a single variable name (<code>events_table</code>). In this case, the tokenizer should return this single component itself as the only token present in the input string.</p></li>
<li><p>Every iteration of the loop generates two different tokens, which are: 1) a token with the part of the string from the previous break point index until the current elegible break point index; 2) and another token containing the single character that identifies the current elegible breakpoint. For example, the text <code>database"</code> will generate the break point index <code>8</code>, so, in the first iteration of the loop, the tokens <code>'database'</code> and <code>'"'</code> will be generated.</p></li>
<li><p>Empty tokens (i.e.&nbsp;tokens that are empty strings, or, that contains only spaces) can be generated during the process. So we use <code>filter()</code> with a <code>lambda</code> function to eliminate them from the output.</p></li>
</ol>
<p>This <code>tokenizer()</code> function generates a list of tokens to be analyzed by the parser:</p>
<div id="3087c5da" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> example <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> EXPRESSION_EXAMPLES:</span>
<span id="cb6-2">    tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer(example)</span>
<span id="cb6-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"================================================================"</span>)</span>
<span id="cb6-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  * Input expression: "</span>, example)</span>
<span id="cb6-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  * Tokens produced: "</span>, tokens)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================
  * Input expression:  'platform.blipraw.events'
  * Tokens produced:  ["'", 'platform.blipraw.events', "'"]
================================================================
  * Input expression:  "blip" + "." + "events"
  * Tokens produced:  ['"', 'blip', '"', '+', '"', '.', '"', '+', '"', 'events', '"']
================================================================
  * Input expression:  database + "." + table_name
  * Tokens produced:  ['database ', '+', '"', '.', '"', '+', ' table_name']
================================================================
  * Input expression:  f"{database}.{table_name}"
  * Tokens produced:  ['f', '"', '{', 'database', '}', '.', '{', 'table_name', '}', '"']</code></pre>
</div>
</div>
</section>
<section id="building-the-actual-parser" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="building-the-actual-parser"><span class="header-section-number">3.4</span> Building the actual parser</h2>
<p>Building the actual parser is definitely the hard part. Because a parser usually involves: 1) having a variable to store the current state of the parser, or, the current state of the AST; 2) and also some level of recursion to traverse the AST, or to decide which move or production rule should be applied. Making these two components working well together can be difficult depending on how you implement it.</p>
<section id="the-different-types-of-strategies" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="the-different-types-of-strategies"><span class="header-section-number">3.4.1</span> The different types of strategies</h3>
<p>Remember, the end goal of a parser, is to build an abstract syntax tree (AST) by analizing a sequence of tokens. There are different strategies to build this tree, and they are usually divided into two categories: 1) <em>top-down</em>. These are strategies that builds the tree from the root, and work they way to the bottom of the tree, which contains the ‚Äúleaves of the tree‚Äù; 2) <em>bottom-up</em> (the inverse). These are strategies which starts to build the tree from the leaves, and work they way up until it hits the root of the tree.</p>
<p>In the subject of parsing, <em>top-down</em> strategies are the most popular (notice that this does not mean that <em>bottom-up</em> strategies are bad or not commom). The most popular strategy of all is the <em>Recursive Descent</em>, which is a <em>top-down</em> strategy. But I will not describe these strategy here, specially to avoid all the technical jargon that they bring with them. Anyway, just be aware that there are different strategies out there, and that in this article I‚Äôm only presenting one of them.</p>
</section>
<section id="the-smaller-components-of-a-parser" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="the-smaller-components-of-a-parser"><span class="header-section-number">3.4.2</span> The smaller components of a parser</h3>
<p>Every parser usually involves two smaller components: 1) a cache that holds the current state of the parser. This cache stores variables that are essential to the parsing process, such as the current state of the AST builded by the parser; 2) and a control (or ‚Äúdecision-making‚Äù) mechanism, which is usually a collection of methods or functions that decides which move the parser should make considering it‚Äôs current state (<span class="citation" data-cites="gries2008">Gries and Schneider (2008)</span>).</p>
<p>Some degree of recursion is found very frequently on some of these methods or functions that decides which move the parser should make. Although this recursion is not something mandatory, because there are some available strategies to build the AST that do not involves any recursion at all.</p>
</section>
<section id="the-cache-to-store-the-current-parsers-state" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="the-cache-to-store-the-current-parsers-state"><span class="header-section-number">3.4.3</span> The cache to store the current parser‚Äôs state</h3>
<p>Lets build a Python class to represent the cache of the parser. This <code>ParserCache</code> class will be responsible for storing all variables that are vital to the parsing process. These variables are:</p>
<ul>
<li><code>ast</code>: stores the current state of the AST.</li>
<li><code>tokens</code>: stores the full sequence of tokens that the parser needs to analyze.</li>
<li><code>index</code>: stores the index on the sequence of tokens that the parser is currently on.</li>
<li><code>token</code>: stores a copy of the current token that the parser is analyzing at the moment.</li>
</ul>
<p>It is not really vital to have the <code>token</code> variable, because we could easily access the current token by using <code>tokens[index]</code>. But‚Ä¶ having a variable called <code>token</code> is easier to type, and it makes most of the parser‚Äôs code more readable, so, it is woth it.</p>
<p>While the parser is analyzing the sequence of tokens stored at the <code>tokens</code> variable, he will slowly grow (or complete) the AST, by replacing and adding elements to the <code>ast</code> variable. At the end, when the parser finishs the parsing process, the <code>ast</code> variable will store the complete AST that is equivalent to the input expression.</p>
<p>You can see below at the <code>__init__()</code> method that to initialize a new object of class <code>ParserCache</code>, you need to give the sequence of tokens to analyze as input. After that, all variables of the class are initialized, and you can start to use the two methods of the class, which are <code>len()</code>, <code>current_token()</code> and <code>next_token()</code>. The <code>len()</code> method returns the length of the tokens sequence that the parser is analyzing, <code>current_token()</code> method returns the current token that the parser is analyzing at the moment, and the <code>next_token()</code> method will effectively advance the parser to the next token in the sequence.</p>
<div id="9f13e297" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ParserCache:</span>
<span id="cb8-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Class that represents a cache to store the current state of the parser.'''</span></span>
<span id="cb8-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, tokens: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb8-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ast <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb8-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokens</span>
<span id="cb8-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb8-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(tokens) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb8-8">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokens[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.index]</span>
<span id="cb8-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb8-10">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb8-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb8-12"></span>
<span id="cb8-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb8-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tokens)</span>
<span id="cb8-15"></span>
<span id="cb8-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> current_token(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb8-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.token</span>
<span id="cb8-18"></span>
<span id="cb8-19">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> current_index(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb8-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.index</span>
<span id="cb8-21"></span>
<span id="cb8-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> next_token(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb8-23">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tokens):</span>
<span id="cb8-25">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tokens[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.index]</span>
<span id="cb8-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span></code></pre></div>
</div>
</section>
<section id="the-main-function-or-entrypoint-for-the-parser" class="level3" data-number="3.4.4">
<h3 data-number="3.4.4" class="anchored" data-anchor-id="the-main-function-or-entrypoint-for-the-parser"><span class="header-section-number">3.4.4</span> The main function or entrypoint for the parser</h3>
<p>We need a main function for the parser, and that is the <code>parse()</code> function. In other words, this is the public API or the main entrypoint of the parser. That is the function that we should use to effectively parse any input and get the resulting AST.</p>
<p>You can see below that all of this function does is: get the input string; generate the tokens with <code>tokenizer()</code>; initialize the parser‚Äôs cache with these tokens; and then, it calls a private function called <code>_parse_input()</code> to initiate the parsing process.</p>
<p>Once <code>_parse_input()</code> is done with the parsing process, <code>parse()</code> gets the parsing results and simply return the complete AST produced, which is stored in the <code>ast</code> variable of the parser‚Äôs cache.</p>
<div id="78ce9e68" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Dict, Any</span>
<span id="cb9-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> parse(input_string: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, Any]]:</span>
<span id="cb9-3">    tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer(input_string)</span>
<span id="cb9-4">    parser_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ParserCache(tokens)</span>
<span id="cb9-5">    parsing_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_input(parser_cache)</span>
<span id="cb9-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> parsing_result.ast</span></code></pre></div>
</div>
</section>
<section id="building-the-main-logic-of-the-parser" class="level3" data-number="3.4.5">
<h3 data-number="3.4.5" class="anchored" data-anchor-id="building-the-main-logic-of-the-parser"><span class="header-section-number">3.4.5</span> Building the main logic of the parser</h3>
<p>The true magic starts with the private function <code>_parse_input()</code>. Basically, <code>_parse_input()</code> starts by looking at the current of token in the sequence that is being analyzed.</p>
<p>If this current token represents the beginning of a string (characters <code>"</code> and <code>'</code>), <code>_parse_string()</code> is called to effectively parse the next tokens in the sequence, which (very likely) are the contents of that string. If this current token is <code>f</code>, then, we have the beginning of a formatted string, so we just skip this <code>f</code> token with <code>parse_cache.next_token()</code>, and call <code>_parse_string()</code> to parse the formatted string. But if this token is a plus sign, then, he will call <code>_parse_addition()</code> to parse this token. If the current token is neither the beginning of a string or a plus sign, then, <code>_parse_input()</code> will assume that this current token is an identifier, and he will call <code>_parse_identifier()</code> to parse it.</p>
<p>Notice that all of these three parsing functions (<code>_parse_string()</code>, <code>_parse_addition()</code> and <code>_parse_identifier()</code>) returns the <code>ParserCache</code> object back as output. In other words, these functions receives the parser cache as input, they use this cache to parse the current token, and they add new elements (or replace the existing ones) to the AST, which is stored inside this cache object. Once they finished their businesses, they simply return this cache back as their output.</p>
<p>After we know that we parsed the current token, then, we ask the parser to advance to the next token, with <code>next_token()</code> method. Then, we check if there is really a next token in the sequence to parse/analyze, by checking if the current index is greater than the number of tokens in the sequence.</p>
<p>If there are still some remaining tokens in the sequence to analyze, then, <code>_parse_input()</code> will call itself recursively to parse the remaining tokens in the sequence. However, if there is not remaining tokens to analyze anymore, then, the function finally returns the parser cache (which contains the complete AST inside of the <code>ast</code> variable) as output.</p>
<div id="1b47fdea" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="annotated-cell-8" style="background: #f1f3f5;"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _parse_input(parser_cache: ParserCache) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> ParserCache:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-8-2" class="code-annotation-target">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> parser_cache.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="annotated-cell-8-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> parser_cache</span>
<span id="annotated-cell-8-4"></span>
<span id="annotated-cell-8-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> parser_cache.current_token() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'"'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'"</span>]:</span>
<span id="annotated-cell-8-6">        parser_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_string(parser_cache)</span>
<span id="annotated-cell-8-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> parser_cache.current_token() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'f'</span>:</span>
<span id="annotated-cell-8-8">        parser_cache.next_token()</span>
<span id="annotated-cell-8-9">        parser_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_string(parser_cache)</span>
<span id="annotated-cell-8-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> parser_cache.current_token() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'+'</span>:</span>
<span id="annotated-cell-8-11">        parser_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_addition(parser_cache)</span>
<span id="annotated-cell-8-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="annotated-cell-8-13">        parser_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_identifier(parser_cache)</span>
<span id="annotated-cell-8-14"></span>
<span id="annotated-cell-8-15">    parser_cache.next_token()</span>
<span id="annotated-cell-8-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> parser_cache.current_index() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> parser_cache.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="annotated-cell-8-17">        parser_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_input(parser_cache)</span>
<span id="annotated-cell-8-18"></span>
<span id="annotated-cell-8-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> parser_cache</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="2" data-code-annotation="1">If the sequence of tokens is empty, then, we have no tokens to analyze, and the function should simply return right away.</span>
</dd>
</dl>
</div>
</div>
<p>Yes! I know what you are thinking. If the current token is neither the beginning of a string or a plus sign, then, he could be anything else. For example, he could be the beginning of a function call, or, a logic comparison, or it could be the beginning of an assignment expression. Anyway, it could be many things! So in theory, it is not safe to simply assume that it is an identifier.</p>
<p>However, you need to remember what we proposed at Section&nbsp;3.2. We want to parse only a very small subset of Python expressions. We do not want (or care) to parse other kinds of expressions. If you look at the expressions examples that fitted the description in Section&nbsp;3.2, you will see that the only components that appears in those expressions are identifiers, additions and string constants.</p>
<p>That is why we care only about these components. That is why, <strong>for this specific case</strong>, it is safe to assume that the last option has to be an identifier.</p>
</section>
<section id="parsing-identifiers" class="level3" data-number="3.4.6">
<h3 data-number="3.4.6" class="anchored" data-anchor-id="parsing-identifiers"><span class="header-section-number">3.4.6</span> Parsing identifiers</h3>
<p>Lets begin by discussing what the <code>_parse_identifier()</code> function should do. Because parsing an identifier component is by far the simplest of all three components. I mean‚Ä¶ how would you parse an identifier? To answer this question, is probably best to think what an identifier is.</p>
<p>Well, an identifier is just a name to a variable, right? So, the value of an identifier object should be the identifier itself! In other words, the name of the variable is the identifier itself. So why not just simply add to the AST an object of type <code>IDENTIFIER</code> and the value of that object being the current token which is the identifier (or the variable name) itself? Right? That should be sufficient.</p>
<p>So we have the following body for <code>_parse_identifier()</code>:</p>
<div id="2895ea2c" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _parse_identifier(parser_cache: ParserCache) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> ParserCache:</span>
<span id="cb10-2">    parser_cache.ast.append({</span>
<span id="cb10-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'IDENTIFIER'</span>,</span>
<span id="cb10-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(parser_cache.current_token())</span>
<span id="cb10-5">    })</span>
<span id="cb10-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> parser_cache</span></code></pre></div>
</div>
</section>
<section id="parsing-strings" class="level3" data-number="3.4.7">
<h3 data-number="3.4.7" class="anchored" data-anchor-id="parsing-strings"><span class="header-section-number">3.4.7</span> Parsing strings</h3>
<p>Now, things get worse when it is time to parse strings. Not because strings are complicated, but because we need to account for <em>formatted strings</em>. In other words, the string that we analyzing might contain expressions inside of it. And if it does have them, we need to parse these expressions in a separate process.</p>
<p>However, if you come back and look at the body of <code>_parse_input()</code> you will see that we call <code>_parse_string()</code> right after we encounter a <code>"</code> or <code>'</code> character. But we do not need to parse this single character exactly. We just know that these characters delimit the beginning of a string, so everything that goes after it should be tokens that together composes the actual content of the string. That is why, we start <code>_parse_string()</code> by calling the <code>next_token()</code> method, to skip this <code>"</code> or <code>'</code> character that we are not particularly interested in.</p>
<p>Now, after that, the next tokens in the sequence will very likely represent the contents of this string that we are currently parsing. So all we need to do, is to use a loop to iterate trough these next tokens and stop (or break) the loop in the moment that we hit a token that contains the <code>"</code> or <code>'</code> character, because these tokens will represent the end of the string.</p>
<p>We could use a stack to accumulate the tokens that represents the contents of the string while we are looping, and then, we analyze these tokens separately after we break the loop. Then, we could simply append to the AST a new object of type <code>STRING</code> containing this stack with all of the components of this string element. It would be a fair strategy. But it would also make the parsing of subexpressions inside of formatted strings harder.</p>
<p>As a result, I decided to opt for a placeholder strategy. Before we start to loop through the sequence of tokens that represents the contents of the string, we add a placeholder at the top level of the AST. At each iteration of the <code>while</code> loop we update the <code>value</code> field of this placeholder by adding the current token to it. By doing this, at the end of the <code>while</code> loop we will have a string object at the top of the AST, and its <code>value</code> field will contain the full/complete list of contents of that string.</p>
<p>Now‚Ä¶ if we do find a opening bracket (<code>{</code>) inside the string, that likely means that the current string that we are analyzing now is a formatted string, and whatever sequence of tokens that is right after this opening bracket, they are a new expression to be parsed. That is why we call the <code>_parse_formatted_string()</code> in case we do find an opening bracket inside the string.</p>
<div id="3ef7343b" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="annotated-cell-10" style="background: #f1f3f5;"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _parse_string(parser_cache: ParserCache) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> ParserCache:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-10-2" class="code-annotation-target">    char_that_opens_the_string <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser_cache.current_token()</span>
<span id="annotated-cell-10-3">    parser_cache.next_token()</span>
<span id="annotated-cell-10-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add a placeholder in the top of the AST</span></span>
<span id="annotated-cell-10-5">    parser_cache.ast.append({</span>
<span id="annotated-cell-10-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'STRING'</span>,</span>
<span id="annotated-cell-10-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="annotated-cell-10-8">    })</span>
<span id="annotated-cell-10-9"></span>
<span id="annotated-cell-10-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> parser_cache.current_index() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> parser_cache.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="annotated-cell-10-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> parser_cache.current_token() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> char_that_opens_the_string:</span>
<span id="annotated-cell-10-12">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="annotated-cell-10-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> parser_cache.current_token() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'{'</span>:</span>
<span id="annotated-cell-10-14">            parser_cache.next_token()</span>
<span id="annotated-cell-10-15">            parser_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_formatted_string(parser_cache)</span>
<span id="annotated-cell-10-16">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="annotated-cell-10-17">        </span>
<span id="annotated-cell-10-18">        elem_ref <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser_cache.ast[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="annotated-cell-10-19">        elem_ref[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>].append(parser_cache.current_token())</span>
<span id="annotated-cell-10-20">        parser_cache.next_token()</span>
<span id="annotated-cell-10-21">    </span>
<span id="annotated-cell-10-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> parser_cache</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="2" data-code-annotation="1">We copy the character (<code>'</code> or <code>"</code>) that openned the string that we are analyzing now, because then, we can search for a new occurence of this same character in the tokens sequence to detect the end of the string.</span>
</dd>
</dl>
</div>
</div>
<!-- 2. We add a placeholder at the top level of the AST. At each iteration of the `while` loop we update the `value` field of this placeholder by adding the current token to it. By doing this, at the end of the `while` loop we will have a string object at the top of the AST, and its `value` field will contain the full/complete list of contents of that string. -->
</section>
<section id="parsing-expressions-inside-formatted-strings" class="level3" data-number="3.4.8">
<h3 data-number="3.4.8" class="anchored" data-anchor-id="parsing-expressions-inside-formatted-strings"><span class="header-section-number">3.4.8</span> Parsing expressions inside <em>formatted strings</em></h3>
<p>We call <code>_parse_formatted_string()</code> if we find a <code>{</code> character inside sequence of tokens that are inside a string. Inside the pair of brackets (<code>{}</code>) we will always have an expression. And because this is a new expression, we need to parse it too, in a separate process.</p>
<p>First, we use a loop and a stack object to accumulate all the tokens in the sequence that are inside of the pair of brackets (<code>{}</code>). This way, we have inside the stack object all the tokens that represents the subexpression that is inside of the brackets that we need to parse.</p>
<div id="68a31cfe" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="annotated-cell-11" style="background: #f1f3f5;"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _parse_formatted_string(parser_cache: ParserCache) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> ParserCache:</span>
<span id="annotated-cell-11-2">    stack <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="annotated-cell-11-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> parser_cache.current_index() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> parser_cache.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-11-4" class="code-annotation-target">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> parser_cache.current_token() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'}'</span>:</span>
<span id="annotated-cell-11-5">            parser_cache.next_token()</span>
<span id="annotated-cell-11-6">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="annotated-cell-11-7">        stack.append(parser_cache.current_token())</span>
<span id="annotated-cell-11-8">        parser_cache.next_token()</span>
<span id="annotated-cell-11-9"></span>
<span id="annotated-cell-11-10">    parsed_subexpression <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ParserCache(stack)</span>
<span id="annotated-cell-11-11">    parsed_subexpression <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_input(parsed_subexpression)</span>
<span id="annotated-cell-11-12">    elem_ref <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser_cache.ast[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="annotated-cell-11-13">    elem_ref[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>].append({</span>
<span id="annotated-cell-11-14">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXPR'</span>,</span>
<span id="annotated-cell-11-15">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>: parsed_subexpression.ast</span>
<span id="annotated-cell-11-16">    })</span>
<span id="annotated-cell-11-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> parser_cache</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="4" data-code-annotation="1">We break the loop, at the moment that we find a closing bracket in the sequence of tokens, because this character represents the end of the pair of brackets that contains the subexpression that we are analyzing.</span>
</dd>
</dl>
</div>
</div>
<p>After we accumulated the sequence of tokens that represents the subexpression that we are analyzing, we need to parse this subexpression separately. To do that, we create a new <code>ParserCache</code> object with this sequence of tokens that represents this subexpression, or, in other words, with all of the tokens that are between the openning and closing brackets. Then, we just call the <code>_parse_input()</code> over this expression to effectively parse this expression.</p>
<p>After that, we add to the top of the AST a new expression object (<code>EXPR</code>) that contains the AST of parsed subexpression inside of it.</p>
</section>
<section id="parsing-addition-operations" class="level3" data-number="3.4.9">
<h3 data-number="3.4.9" class="anchored" data-anchor-id="parsing-addition-operations"><span class="header-section-number">3.4.9</span> Parsing addition operations</h3>
<p>Now, things get a little bit more complicated when we find a plus sign in the middle of the sequence of tokens. Because if we do find a plus sign, that means that this plus sign is surrounded by operands in the original expression. In other words, this plus sign connects the left operand to the right operand of this addition operation.</p>
<p>In theory, the previous token in the sequence is the left operand of this addition, and the next token in the sequence is the right operand. That means that, just in theory, at the moment we find a plus sign in the sequence of tokens, we can collect the left operand of the addition operation by looking at the previous token, and, we could also collect the right operand by advancing the parser with <code>next_token()</code> and using <code>current_token()</code> to get the next token in the sequence.</p>
<section id="the-challenge" class="level4" data-number="3.4.9.1">
<h4 data-number="3.4.9.1" class="anchored" data-anchor-id="the-challenge"><span class="header-section-number">3.4.9.1</span> The challenge</h4>
<p>However, this is not really true, or, it would be too easy to be true. The real problem, is that the left and right operands could be splitten by the tokenizer into multiple tokens. In other words, there are very commom cases where single calls to <code>current_token()</code> would be insufficient to actually get the complete right or left operands.</p>
<p>That means that the tokenizer step might make the part of identifying where the left and right operands are in the sequence of tokens a difficult task. If you think about how the tokenizer works (see Listing&nbsp;3), you will probably be able to find examples where the left or right operands could be composed of multiple tokens, and not just a single token.</p>
<p>Take the expression <code>database + '.events'</code> as an example. Take a look at the tokenizer‚Äôs output over this expression. The left operand is the first token (<code>database</code>), but the right operand, is actually the three last tokens in the sequence (<code>['"', '.events', '"']</code>). This means that these three tokens together compose the right operand.</p>
<div id="7106a92e" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(tokenizer(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'database + ".events"'</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['database ', '+', '"', '.events', '"']</code></pre>
</div>
</div>
<p>As a result, at the moment where the parser is at the plus sign, if we advance the parser with <code>next_token()</code>, and run <code>current_token()</code> we would get only the token <code>"</code>, so the right operand would be incomplete. How do we know that we need to accumulate the next three tokens instead of looking to just one token in the sequence?</p>
</section>
<section id="solving-the-issue-for-the-left-operand" class="level4" data-number="3.4.9.2">
<h4 data-number="3.4.9.2" class="anchored" data-anchor-id="solving-the-issue-for-the-left-operand"><span class="header-section-number">3.4.9.2</span> Solving the issue for the left operand</h4>
<p>For now, lets ignore the right operand and think about the left operand. The left operand is whatever sequence of tokens that are before the plus sign. But, as we saw in the previous section, in some cases, we might need to look 3, 4 or 5 tokens behind to actually get the full left operand, instead of looking at just 1 token behind.</p>
<p>But instead of looking at the previous tokens in the sequence, we could get the left operand by looking at the top of the AST. In other words, the last element in the AST is the previous token already parsed, and we can easily access this last element by calling <code>parser_cache.ast[-1]</code>.</p>
<p>Perfect, after we saved a copy of the left operand inside a <code>left_operand</code> variable, we can delete him from the AST in the parser cache, with <code>del parser_cache.ast[-1]</code>. If we do not delete him now, then, he would become duplicated in the AST at the moment that we add our object for the addition operation to the AST, which contains both left and right operands.</p>
<div id="45bd6c0f" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _parse_addition(parser_cache: ParserCache) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> ParserCache:</span>
<span id="cb13-2">    left_operand <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser_cache.ast[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb13-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">del</span> parser_cache.ast[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb13-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Now that we managed the left operando, we will deal</span></span>
<span id="cb13-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># with the right operand in the next section</span></span>
<span id="cb13-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> parser_cache</span></code></pre></div>
</div>
</section>
<section id="solving-the-issue-for-the-right-operand" class="level4" data-number="3.4.9.3">
<h4 data-number="3.4.9.3" class="anchored" data-anchor-id="solving-the-issue-for-the-right-operand"><span class="header-section-number">3.4.9.3</span> Solving the issue for the right operand</h4>
<p>After we deleted the last element in the AST (which contained the left operand), we can now look for the right operand, which is whatever sequence of tokens that are after the plus sign.</p>
<p>But getting the right operand is unfortunately more complicated. Because of that, let‚Äôs concentrate the main logic of getting the right operand into a new separate function called <code>_parse_right_operand()</code>. After we get the right operand, we just return from <code>_parse_addition()</code> with an <code>ADDITION</code> object which contains both left and right operands.</p>
<div id="77e9b27b" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _parse_addition(parser_cache: ParserCache) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> ParserCache:</span>
<span id="cb14-2">    left_operand <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser_cache.ast[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb14-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">del</span> parser_cache.ast[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb14-4">    parser_cache.next_token()</span>
<span id="cb14-5">    right_operand <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_right_operand(parser_cache)</span>
<span id="cb14-6">    parser_cache.ast.append({</span>
<span id="cb14-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ADDITION'</span>,</span>
<span id="cb14-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left_operand'</span>: left_operand,</span>
<span id="cb14-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'right_operand'</span>: right_operand</span>
<span id="cb14-10">    })</span>
<span id="cb14-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> parser_cache</span></code></pre></div>
</div>
<p>Now, what <code>_parse_right_operand()</code> should do? I think it should iterate through the sequence of tokens that is after the plus sign, parse this sequence of tokens and then, return the parsed AST of this sequence. That is basically what <code>_parse_right_operand()</code> is doing in the function definition below.</p>
<p>We start with a <code>while</code> loop which will use a new stack object to accumulate all the tokens after the plus sign. This loop stops in two situations:</p>
<ol type="1">
<li>If it hits the end of the stream of tokens that the parser is analyzing.</li>
<li>If it hits a new plus sign in the sequence of tokens, which basically means that, the loop found a new addition operation in the sequence of tokens.</li>
</ol>
<p>When the loop stops in situation 1, then, the stack object will contain all of the tokens that represents the right operand. Having that in mind, all we need to do is to create a new temporary <code>ParserCache</code> object with these tokens, and call <code>_parse_input()</code> over it to parse the right operand. Then, <code>_parse_right_operand()</code> will simply return the parsed AST from this operation.</p>
<p>In the other side, if the loop stops in situation 2, that means that, the right operand that we are currently trying to parse, is in fact, the left hand to a new addition operation. In other words, the tokens that we accumulated in the stack object until this very moment, are in fact, the tokens that represents the left operand of this new addition operation that we found.</p>
<p>At Figure&nbsp;2 we can see this idea visually. Everything that is marked by the light red rectangle is the left operand of that particular addition operation, and everything that is marked by the dark blue rectangle is the right operand of that particular addition operation.</p>
<div id="fig-addition" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-addition-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2023/2023-11-18-python-parser/addition.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-addition-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Marking the right and left operands in each addition operation
</figcaption>
</figure>
</div>
<p>So, lets consider as an example, that the parser was parsing the expression <code>database + '.' + 'events'</code>. When <code>_parse_right_operand()</code> is parsing the right operand of the first addition (which is <code>'.'</code>), the function is looping through the sequence of tokens. The tokens <code>["'", '.', "'"]</code> are accumulated inside the stack object, until the loop hits the token <code>+</code>, which is second plus sign in the entire input expression. At this point the function understands that it hitted a new addition operation to be parsed.</p>
<p>That is why <code>_parse_right_operand()</code>, in this situation, will call itself recursively to parse the remaining tokens in the sequence, which are the right operand of this new/second addition it founded. The tokens that are accumulated in the stack object, are the left operand of this new/second addition, and they are parsed by <code>_parse_input()</code>.</p>
<p>So in this situation, to get the actual right operand of the first addition, <code>_parse_right_operand()</code> needs to parse this new/second addition operation that if founded. The right operand of the first addition, is the second addition in its entirety, or, you could also interpret that the right operand of the first addition is the second addition already parsed. That is why, in this situation, <code>_parse_right_operand()</code> will call both <code>_parse_input()</code> and itself recursively to parse the right and left operands of this new/second addition operation, and return the <code>ADDITION</code> object that represents this parsed new/second addition.</p>
<p>Having all of these aspects in mind, here is the source code for <code>_parse_right_operand()</code>:</p>
<div id="9f585493" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _parse_right_operand(parser_cache: ParserCache) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> ParserCache:</span>
<span id="cb15-2">    stack <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb15-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> parser_cache.current_index() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> parser_cache.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb15-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> parser_cache.current_token() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"+"</span>:</span>
<span id="cb15-5">            parser_cache.next_token()</span>
<span id="cb15-6">            second_addition_right_operand <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_right_operand(parser_cache)</span>
<span id="cb15-7">            temp_parse_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ParserCache(stack)</span>
<span id="cb15-8">            second_addition_left_operand <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_input(temp_parse_cache)</span>
<span id="cb15-9">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb15-10">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ADDITION'</span>,</span>
<span id="cb15-11">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left_operand'</span>: second_addition_left_operand.ast[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb15-12">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'right_operand'</span>: second_addition_right_operand</span>
<span id="cb15-13">            }</span>
<span id="cb15-14"></span>
<span id="cb15-15">        stack.append(parser_cache.current_token())</span>
<span id="cb15-16">        parser_cache.next_token()</span>
<span id="cb15-17">    </span>
<span id="cb15-18">    temp_parse_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ParserCache(stack)</span>
<span id="cb15-19">    parsed_right_operand <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _parse_input(temp_parse_cache)</span>
<span id="cb15-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> parsed_right_operand.ast[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
</div>
</section>
</section>
</section>
<section id="finally-the-parser-is-complete" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="finally-the-parser-is-complete"><span class="header-section-number">3.5</span> Finally! The parser is complete!</h2>
<p>Now our parser is finally complete! We can now test it, and see what AST‚Äôs are produced for each example of expressions we have:</p>
<div id="3dd8f2c3" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> example <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> EXPRESSION_EXAMPLES:</span>
<span id="cb16-2">    parsed_expr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parse(example)</span>
<span id="cb16-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"===================================="</span>)</span>
<span id="cb16-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  * Input expression: "</span>, example)</span>
<span id="cb16-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  * Parsed AST: "</span>, parsed_expr)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>====================================
  * Input expression:  'platform.blipraw.events'
  * Parsed AST:  [{'type': 'STRING', 'value': ['platform.blipraw.events']}]
====================================
  * Input expression:  "blip" + "." + "events"
  * Parsed AST:  [{'type': 'ADDITION', 'left_operand': {'type': 'STRING', 'value': ['blip']}, 'right_operand': {'type': 'ADDITION', 'left_operand': {'type': 'STRING', 'value': ['.']}, 'right_operand': {'type': 'STRING', 'value': ['events']}}}]
====================================
  * Input expression:  database + "." + table_name
  * Parsed AST:  [{'type': 'ADDITION', 'left_operand': {'type': 'IDENTIFIER', 'value': 'database '}, 'right_operand': {'type': 'ADDITION', 'left_operand': {'type': 'STRING', 'value': ['.']}, 'right_operand': {'type': 'IDENTIFIER', 'value': ' table_name'}}}]
====================================
  * Input expression:  f"{database}.{table_name}"
  * Parsed AST:  [{'type': 'STRING', 'value': [{'type': 'EXPR', 'value': [{'type': 'IDENTIFIER', 'value': 'database'}]}, '.', {'type': 'EXPR', 'value': [{'type': 'IDENTIFIER', 'value': 'table_name'}]}]}]</code></pre>
</div>
</div>
<p>You can see in the above output, that parser I presented here produces an AST which is composed by a list of dict (or JSON) objects which describes the elements of the three. Now that we have this three, we might do a lot of different things with it. As I mentioned before, every compiler uses trees like this to do type checking, to identify dependencies of your source code, and also, to perform optimization processes.</p>
<p>But these operations are out of the scope of this article. Our objective here is complete, which was to show a basic example of a parser written in Python. If you want to take a closer look, you can see the full source code of the parser at <a href="./../parser.py"><code>parser.py</code></a>.</p>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-gries2008" class="csl-entry">
Gries, David, and Fred B. Schneider. 2008. <em>Parsing Techniques: A Practical Guide</em>. 2nd ed. Springer.
</div>
</div></section></div> ]]></description>
  <category>Python</category>
  <category>Parser</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-11-18-python-parser/en/</guid>
  <pubDate>Sat, 18 Nov 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-11-18-python-parser/image-pic.png" medium="image" type="image/png" height="51" width="144"/>
</item>
<item>
  <title>A small example on how to make better decisions with data</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-08-31-data-decisions/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This article describes a real-world situation where me and my team used data to convince our client (which is one of the biggest companies in the brazilian financial market) at the time to make a better decision. Special thanks to <a href="https://www.linkedin.com/in/guilhermeggarcia/">Guilherme Goes</a> and <a href="https://www.linkedin.com/in/paulo-gon-oli/">Paulo Gon√ßalves</a>. They both help me to present these ideas and insights to our client.</p>
<p>In essence, <strong>making decisions is hard</strong>. But you always make a better decision when you have data to guide you into a safer and better outcome. When you do not have data to back you up, you are basically in the dark. That is, you make the decision, but you do not know upfront what are the possible outcomes of that decision. You just hope for the best, and this is always a hard position to be in.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>All data, graphs and images indicated in this article are for illustrative purposes only. Therefore, they do not represent the real data of Blip or the bank involved in any shape or form!</p>
</div>
</div>
</section>
<section id="a-data-analyst-should-focus-on-understanding-the-business" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> A Data Analyst should focus on understanding the business</h1>
<p>You will probably notice that a big part of this article is dedicated to give you context and explain the business behind this example.</p>
<p>This is intentional! Because, one of the real values of this article is to show that we come up with a good proposal to our client, because we understood his business, and we raised some good hypothesis about this business, and by analyzing these hypothesis we come up with a good new strategy.</p>
<p>If you do not understand the business you are analyzing, is less likely that you will come up with a good strategy, or, a good data analysis. In other words, by having a good understanding of the business, you will likely have much better ideas on ‚Äúhow‚Äù to analyze the data you have.</p>
</section>
<section id="context" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Context</h1>
<p>In essence, our client was a big brazilian bank, one of the largest in the market. The bank was using our digital plataform to sell different products and services through <a href="https://www.whatsapp.com/">WhatsApp</a>. Our job was to analyze the data generated by the platform to understand how the bank could increase their sales inside this channel.</p>
<section id="the-secured-loan-product" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="the-secured-loan-product"><span class="header-section-number">3.1</span> The secured loan product</h2>
<p>A secured loan was one of several products offered by the bank on WhatsApp. To acquire this product, the user needed to answer several questions, and also, fit into some criterias.</p>
<p>Depending on the type of industry you work in, you might call this as the <em>sales flow</em>, or, the <em>sales path</em>, which is the path (or the steps) that the user needs to follow to acquire the product you are selling.</p>
<p>Most companies want to make this path as short as possible so that the user gets to the product faster. However, we are talking about a loan, so the bank certainly needs a lot of personal and financial information about the user before it gives the loan.</p>
<p>So in this example, the user needed to answer a considerable amount of questions through WhatsApp to get to the final step of the sales path, that is, to acquire the loan.</p>
<p>Most of these questions were asking for some personal information, to check whether this particular user fitted or not into some important criterias. Most of these criterias were very standard for any type of loan, like‚Ä¶ the person should not have any legal debts with the government. Some other criterias were purelly financial and assets related, and were also a very commom practice among banks, like‚Ä¶ the person needs to be fully employed, he/she needs to have a car which is fully paid, and, this car needs to be a personal property of the person, i.e.&nbsp;it cannot be a borrowed car from another person.</p>
</section>
<section id="the-weird-criteria" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="the-weird-criteria"><span class="header-section-number">3.2</span> The weird criteria</h2>
<p>But one of the many criterias was a bit strange for us. Identify the exact criteria is not important for the content of this article. Let‚Äôs just say that, to be elegible for this loan, <strong>the user needed to be elegible to three different modalities</strong>.</p>
<p>Each modality corresponded to a different type of loan. If the user was not elegible to all of these three modalities (or types of loan), then, we would automatically rejected the user‚Äôs request for the loan.</p>
<p>In essence, we had a flow that worked a bit like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-08-31-data-decisions/flow-extended.png" class="img-fluid figure-img"></p>
<figcaption>A small representation of the sales path</figcaption>
</figure>
</div>
<p>Every time a user entered our flow, we collected the social ID of this user. Because with this social ID we can use the API to check multiple informations about this person. One of the many things we checked, was whether or not this user was elegible or not to these three modalities of loan.</p>
</section>
<section id="why-this-was-weird" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="why-this-was-weird"><span class="header-section-number">3.3</span> Why this was weird?</h2>
<p>This was a weird criteria, because‚Ä¶ if an user called ‚ÄúAna‚Äù is elegible to modality A, then, why not offer a loan of modality A to ‚ÄúAna‚Äù ? As another example, if an user ‚ÄúMike‚Äù is elegible to both modalities A and B, then, why not offer both of these modalities (A and B) to him? Let the user get whatever type of loan he is elegible to, right?</p>
<p>Why only users that are elegible to all three modalities (A, B and C) get to decide which loan they want to get? In our head, this criteria did not made much sense, because if an user is elegible to one modality of loan, he should be able to get a loan on this modality he is elegible to.</p>
</section>
<section id="why-this-criteria-existed" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="why-this-criteria-existed"><span class="header-section-number">3.4</span> Why this criteria existed?</h2>
<p>But let‚Äôs face it. Despite this being a weird criteria, there certainly is a reason for it. Nothing exists without a reason. We thought this weird criteria probably existed either because:</p>
<ol type="1">
<li>a MVP strategy.</li>
<li>or a ‚Äúrisk trade-off‚Äù strategy.</li>
</ol>
<p>The MVP strategy means that the bank included this weird criteria because it greatly simplified the development of the sales path. By simplifying the development, the bank could deliver a MVP (minimal viable product) as fast as possible, and, as a consequence, he could make a profit out of it faster.</p>
<p>On the other side, the ‚Äúrisk trade-off‚Äù means that the bank included this weird criteria, because it probably estimated that the risk is considerably higher for people that are not elegible to all three modalities. If the estimated risk is higher, then, the bank have a good reason to not offer this loan to people that are elegible to only one or two modalities.</p>
<p>Banks are constantly facing a trade-off between risk and profit. In other words, a secured loan like this is always a good profit opportunity. However, this profit opportunity always come at a cost, mostly in the form of risk.</p>
<p>That is why banks are usually very good at analysing and estimating risks. When a person looks to acquire a loan, the bank starts to analyze several factors in order to estimate how much risky is to give a loan to this person.</p>
</section>
</section>
<section id="what-we-discovered" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> What we discovered</h1>
<p>Regardless of which of the above options was the exact bank‚Äôs strategy, we had the hypothesis that this business rule (or this ‚Äúweird criteria‚Äù) was severely affecting the sales result.</p>
<p>We created this hypothesis, because we notice a big loss of users at the step in the sales path where we do all the multiple validations through the API, checking wether the user fitted or not all the criterias and business rules.</p>
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-08-31-data-decisions/funnel-chart.png" class="img-fluid"></p>
<p>We did not know which specific criteria of the many was the real source of this loss. But we suspected that the ‚Äúelegible to all 3 modalities‚Äù was this problematic criteria.</p>
<p>In other words, we suspected that this strategy of rejecting users that did not had all three modalities was not worth it, despite of what decisions the bank actually made to include this criteria into the sales path. But we needed to confirm this hypothesis.</p>
<p>Since we had the data returned from the API, we could potentially identify which users did have the three modalities, and which did not have. So I setted up a simple R script to collect the data of each user that visited our sales path in the last month from the API, and I putted this script to run through the night.</p>
<p>In the next day, I had all of the data locally, which looked a bit like this:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb1-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb1-2">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-3">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"username"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ana"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-4">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"socialid"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"12212212212"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_analysis"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:{</span></span>
<span id="cb1-6">         <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_modalities_elegible_to"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-7">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-8">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-9">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-10">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"username"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mike"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-11">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"socialid"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"13313313313"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-12">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_analysis"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:{</span></span>
<span id="cb1-13">         <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_modalities_elegible_to"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[]</span></span>
<span id="cb1-14">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-15">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-16">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-17">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"username"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Arthur"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-18">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"socialid"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"14414414414"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-19">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_analysis"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:{</span></span>
<span id="cb1-20">         <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_modalities_elegible_to"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-21">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-22">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-23"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<p>We then started to analyze this data, investigating the metadata of each user, and potentially measuring the size of the hole that this business rule was creating.</p>
<p>As a result, we discovered that the bank was constantly <strong>losing a huge opportunity</strong> because of this weird criteria, or, this specific business rule. Doing some basic math, we identified that <strong>67% of the users that visited our channel were not elegible to all three modalities</strong>. This means that 67% of the users that entered our channel were automatically rejected. We were constantly losing a huge chunk of potential leads because they did not fitted into this criteria.</p>
<p>So, for example, if 13,000 users entered our channel, only (1 - 0.67) x 13,000 = 4,290 of these users could potentially finish the path and acquire the loan. The remaining 8,710 users were automatically lost. They were just rejected because they did not had these three modalities.</p>
<p>This discovery generated some important possibilities for us:</p>
<ul>
<li>Are we reaching the right audience?</li>
<li>Maybe we should focus in attract only people that do have the three modalities to our channel?</li>
<li>Is this criteria or business-rule worth it?</li>
</ul>
</section>
<section id="using-data-to-get-a-better-outcome" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Using data to get a better outcome</h1>
<p>Our job was to use the data we collected, to show the bank that the potential gains of selling different types of loans to these users that did not had the three modalities, were much higher than the potential risk they offered, or than the effort to develop some improvements over the sales path to use the new strategy.</p>
<p>By using data, we can show the bank (in numbers) the size of the opportunity they were losing. And that is exactly what we did. Our argument was basically divided into two separate parts:</p>
<ol type="1">
<li>The size of the lost;</li>
<li>The size of the potential gain;</li>
</ol>
<p>The first part of our presentation focused on the 67% number. We shown the bank that 67% of the users (which is a huge number) were constantly rejected in the flow. But this number alone does not have much flavor. As long as they are maximizing their profit, the bank does not care if he is saying ‚Äúno‚Äù to 60%, 70%, 80% of the users or whatever.</p>
<p>That is why in the second part, we did some more basic math to estimate the potential gains they were losing by not selling to this 67% of users.</p>
</section>
<section id="the-new-strategy" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> The new strategy</h1>
<p>A quick recap. Each individual user that entered inside our sales path, wants to get a loan. But, this user needed to be elegible to three different types of loan to actually acquire the loan he wanted through our channel.</p>
<p>But, what if we change the sales path, so that:</p>
<ul>
<li>An user does not need to be elegible to all three modalities to acquire a loan;</li>
<li>If an user is elegible to one modality, then, we should offer a loan of this modality he is elegible to;</li>
<li>If an user is elegible to more than one modality, then, we should offer multiple options of loans for the user, one for each modality he is elegible to;</li>
</ul>
<p>Using the same API data that we used to get to the 67% number, we estimated that, if we changed the sales path so that it would fit the descriptions above, then, we would increase the users coverage to 96.8%! This means that we could sell a loan to 96.8% of the users that entered our sales path, instead of only 33%.</p>
<p>Now, if you are thinking that 33% + 67% should be equal to 100% instead, you are forgetting that the user needs to fit into some other criterias that I did not mentioned here. In other words, 96.8 - 100 = 3.2% of users would still be rejected because they did not fit into other necessary criterias.</p>
</section>
<section id="the-end-result" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> The end result</h1>
<p>The time and effort necessary to develop this new strategy into the sales path was relatively low, and the potential gains of it were quite high! By increasing the users coverage from 33% to 96.8%, we estimated that the sales could have a potential 193% increase. Spoiler! This estimate was way low compared to the end result we got. But that is what estimates are right? They are just estimates.</p>
<p>So the bank was very happy with the proposal. The managers quickly accepted the idea. A low effort for a potentail high gain.</p>
<p>If you think about it, this new strategy we come up with was very simple. It just provided more options to the users that did not fitted into the ideal scenario for the bank. But despite it being simple, we wroted a very short, clear and effective proposal (it was just 4 slides basically). We showed the size of the hole to the bank, and we showed the size of the opportunity we could get if we implemented our new strategy, and we also showed that this new strategy was relatively easy and quick to implement.</p>
<p>However, the end result was enormous. On the first month after we implemented this new strategy on production, the sales increased approximately 142%, and on the second month, 400%. The sales of this specific loan have a strong seasonal component to it, that is why you have such a big variation from 142% to 400%. But nevertheless, this demonstrates the positive impact of our new strategy. This end result of <strong>400% sales increase</strong> from our proposal was humongous.</p>
</section>
<section id="conclusion" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Conclusion</h1>
<p>We identified a weird criteria that our client included on the sales path. We raised some simple hypothesis about this weird criteria, and we used data to confirm or test this hypothesis.</p>
<p>By analysing this data, we identified a huge opportunity for our client. We then builded a simple presentation with a proposal to our client, with the numbers that we calculated from the data analysis that did.</p>
<p>At the end, this proposal was a huge success for our team, and for our client too that got a huge sales increase after we implemented the improvements that we proposed.</p>


</section>

 ]]></description>
  <category>Data Storytelling</category>
  <category>Data Science</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-08-31-data-decisions/en/</guid>
  <pubDate>Sat, 28 Oct 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-08-31-data-decisions/decision.avif" medium="image" type="image/avif"/>
</item>
<item>
  <title>Um pequeno exemplo sobre como utilizar dados para tomar melhores decis√µes</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-08-31-data-decisions/pt/</link>
  <description><![CDATA[ 





<section id="introdu√ß√£o" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introdu√ß√£o</h1>
<p>Este artigo descreve um exemplo real em que eu e meu time usamos dados para convencer o nosso cliente na √©poca (que √© um dos maiores bancos do mercado brasileiro) a tomar uma melhor decis√£o. Agradecimentos especiais ao <a href="https://www.linkedin.com/in/guilhermeggarcia/">Guilherme Goes</a> e ao <a href="https://www.linkedin.com/in/paulo-gon-oli/">Paulo Gon√ßalves</a>. Ambos me ajudaram a montar e apresentar essas ideias e <em>insigths</em> para o nosso cliente.</p>
<p>Em resumo, <strong>tomar decis√µes √© dif√≠cil</strong>. Mas voc√™ sempre toma uma decis√£o melhor quando voc√™ tem dados para gui√°-lo em dire√ß√£o a um resultado melhor e mais seguro. Quando voc√™ n√£o tem dados para te defender, voc√™ est√° basicamente no escuro. Ou seja, voc√™ toma a decis√£o, mas n√£o sabe antecipadamente quais s√£o os poss√≠veis resultados dessa decis√£o. Voc√™ apenas espera o melhor, e esta √© sempre uma posi√ß√£o dif√≠cil de se estar.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Todos os dados, gr√°ficos e imagens mostrados neste artigo s√£o meramente ilustrativos. Portanto, eles n√£o representam os dados reais de Blip ou do banco envolvido de nenhuma forma ou dimens√£o!</p>
</div>
</div>
</section>
<section id="um-analista-de-dados-deveria-focar-em-entender-o-neg√≥cio" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Um analista de dados deveria focar em entender o neg√≥cio</h1>
<p>Voc√™ provavelmente vai notar que grande parte deste artigo √© dedicado a contextualizar e explicar o neg√≥cio por tr√°s deste exemplo.</p>
<p>Isso √© intencional! Porque, um dos reais valores deste artigo √© mostrar que chegamos a uma boa proposta para o nosso cliente, porque n√≥s entendemos o neg√≥cio desse cliente, e levantamos algumas hip√≥teses boas sobre esse neg√≥cio, e ao analisarmos essas hip√≥teses n√≥s conseguimos chegar a uma boa nova estrat√©gia.</p>
<p>Se voc√™ n√£o entende o neg√≥cio que est√° analisando, √© menos prov√°vel que voc√™ encontre uma boa estrat√©gia ou uma boa an√°lise de dados. Em outras palavras, ao ter um bom entendimento do neg√≥cio, voc√™ provavelmente ter√° ideias muito melhores sobre ‚Äúcomo‚Äù analisar os dados que possui.</p>
</section>
<section id="contexto" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Contexto</h1>
<p>Em resumo, o nosso cliente era um grande banco brasileiro, um dos maiores do mercado. O banco estava utilizando nossa plataforma digital para vender diversos produtos e servi√ßos pelo <a href="https://www.whatsapp.com/">WhatsApp</a>. Nosso trabalho foi analisar os dados gerados pela plataforma para entender como o banco poderia aumentar suas vendas dentro deste canal.</p>
<section id="o-produto-de-empr√©stimo-com-garantia" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="o-produto-de-empr√©stimo-com-garantia"><span class="header-section-number">3.1</span> O produto de empr√©stimo com garantia</h2>
<p>O empr√©stimo com garantia era um dos diversos produtos oferecidos pelo banco no WhatsApp. Para adquirir este produto, o usu√°rio precisava responder diversas perguntas, e tamb√©m, se enquadrar em alguns crit√©rios.</p>
<p>Dependendo do tipo de setor em que voc√™ atua, voc√™ pode chamar isso de ‚Äúfluxo de vendas‚Äù, ou ‚Äúcaminho de vendas‚Äù, que nada mais √© do que o caminho (ou as etapas) que o usu√°rio precisa seguir para adquirir o produto que voc√™ est√° vendendo.</p>
<p>A maioria das empresas deseja tornar esse caminho o mais curto poss√≠vel para que o usu√°rio chegue ao produto com mais rapidez. Por√©m, estamos falando de um empr√©stimo, ent√£o o banco certamente precisa de muitas informa√ß√µes pessoais e financeiras do usu√°rio antes de conceder o empr√©stimo.</p>
<p>Ou seja, neste exemplo, o usu√°rio precisava responder uma quantidade consider√°vel de perguntas pelo WhatsApp para chegar √† etapa final do caminho de vendas para adquirir o empr√©stimo.</p>
<p>A maioria dessas perguntas solicitava algumas informa√ß√µes pessoais, para verificar se esse usu√°rio espec√≠fico se enquadrava ou n√£o em alguns crit√©rios importantes. A maioria desses crit√©rios eram bastante comuns (ou o <em>standard</em>) para qualquer tipo de empr√©stimo. Por exemplo, a pessoa n√£o deveria ter nenhuma d√≠vida legal com o governo. Alguns outros crit√©rios eram puramente financeiros e patrimoniais, e tamb√©m eram uma pr√°tica muito comum entre os bancos, como‚Ä¶ a pessoa precisa estar totalmente empregada, precisa ter um carro totalmente pago, e, esse carro precisa ser uma propriedade pessoal da pessoa, ou seja, n√£o poderia ser um carro emprestado de outra pessoa.</p>
</section>
<section id="um-crit√©rio-estranho" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="um-crit√©rio-estranho"><span class="header-section-number">3.2</span> Um crit√©rio estranho</h2>
<p>Por√©m um dos v√°rios crit√©rios era um pouco estranho para n√≥s. Identificar exatamente qual crit√©rio era esse n√£o √© importante para o conte√∫do deste artigo. Portanto, vamos dizer apenas que, para que um usu√°rio consiga adquirir esse empr√©stimo, <strong>ele precisava necessariamente ser eleg√≠vel para tr√™s modalidades diferentes</strong>.</p>
<p>Cada modalidade correspondia a um tipo diferente de empr√©stimo. Se o usu√°rio n√£o fosse eleg√≠vel a todas essas tr√™s modalidades (ou tipos de empr√©stimo), n√≥s automaticamente rejeitamos a solicita√ß√£o de empr√©stimo desse usu√°rio.</p>
<p>Em ess√™ncia, t√≠nhamos um fluxo que funcionava mais ou menos assim:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-08-31-data-decisions/flow-pt.png" class="img-fluid figure-img"></p>
<figcaption>Uma pequena representa√ß√£o do fluxo de vendas</figcaption>
</figure>
</div>
<p>Cada vez que um usu√°rio entrava em nosso fluxo, n√≥s coletamos o CPF desse usu√°rio. Pois com esse CPF podemos usar a API para verificar m√∫ltiplas informa√ß√µes sobre essa pessoa de uma vez s√≥. Uma das muitas coisas que n√≥s verific√°vamos nessa chamada de API, era se esse usu√°rio se encaixava no crit√©rio estranho que descrevemos. Isto √©, n√≥s confer√≠amos se esse usu√°rio era eleg√≠vel ou n√£o √†s tr√™s modalidades de empr√©stimo.</p>
</section>
<section id="por-que-esse-crit√©rio-era-estranho" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="por-que-esse-crit√©rio-era-estranho"><span class="header-section-number">3.3</span> Por que esse crit√©rio era estranho?</h2>
<p>Na nossa cabe√ßa, este era um crit√©rio muito estranho, porque‚Ä¶ se uma usu√°ria chamada ‚ÄúAna‚Äù por exemplo for eleg√≠vel para a modalidade A, ent√£o, por que n√£o oferecer um empr√©stimo da modalidade A para a ‚ÄúAna‚Äù? Como um outro exemplo, se um o usu√°rio ‚ÄúMike‚Äù √© eleg√≠vel para ambas as modalidades A e B, ent√£o por que n√£o oferecer ambas as modalidades (A e B) para ele? Ou seja, por que n√£o oferecer ao usu√°rio qualquer tipo de empr√©stimo ao qual ele √© eleg√≠vel?</p>
<p>Por que apenas usu√°rios que s√£o eleg√≠veis para todas as tr√™s modalidades (A, B e C) podem adquirir o empr√©stimo? Na nossa cabe√ßa esse crit√©rio n√£o fazia muito sentido, pois se um usu√°rio for eleg√≠vel a uma modalidade de empr√©stimo, ele deveria ser capaz de obter um empr√©stimo nesta modalidade ao qual ele tem direito.</p>
</section>
<section id="por-que-esse-crit√©rio-existia" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="por-que-esse-crit√©rio-existia"><span class="header-section-number">3.4</span> Por que esse crit√©rio existia?</h2>
<p>Mas vamos encara um fato. Apesar de este ser um crit√©rio estranho, certamente existe uma raz√£o para ele existir. Nada existe sem uma raz√£o. N√≥s imaginamos que esse crit√©rio estranho existia provavelmente por causa de:</p>
<ol type="1">
<li>uma estrat√©gia MVP.</li>
<li>ou de uma estrat√©gia de risco, em outras palavras, por causa de um <em>trade-off</em>.</li>
</ol>
<p>Uma estrat√©gia MVP significa que o banco decidiu incluir esse crit√©rio estranho porque inclu√≠-lo reduziria muito a complexidade do desenvolvimento do fluxo de vendas, e, portanto, ao simplificar o desenvolvimento, o banco poderia entregar um MVP (<em>minimal viable product</em>, ou, produto m√≠nimo vi√°vel) o mais r√°pido poss√≠vel e, como consequ√™ncia, ele poderia come√ßar a lucrar com esse produto mais rapidamente.</p>
<p>Por outro lado, uma estrat√©gia de risco significa que o banco decidiu incluir este crit√©rio estranho, porque ele provavelmente estimou que o risco √© consideravelmente maior para pessoas que n√£o s√£o eleg√≠veis para as tr√™s modalidades. Se o risco estimado for muito alto, ent√£o o banco tem um bom motivo para n√£o oferecer esse empr√©stimo a pessoas que s√£o eleg√≠veis a apenas uma ou duas modalidades diferentes.</p>
<p>Os bancos enfrentam constantemente uma escolha (ou uma balan√ßa) entre risco e lucro. Ou seja, um empr√©stimo de qualquer tipo √© sempre uma boa oportunidade de lucro para o banco. No entanto, esta oportunidade de lucro tem sempre um custo atrelado a ela. Esse custo aparece principalmente na forma de risco para o banco.</p>
<p>√â por isso que os bancos s√£o normalmente muito bons em analisar e estimar riscos. Quando uma pessoa busca adquirir um empr√©stimo, o banco passa a analisar diversos fatores para estimar o quanto arriscado √© conceder um empr√©stimo a essa pessoa.</p>
</section>
</section>
<section id="o-que-n√≥s-descobrimos" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> O que n√≥s descobrimos</h1>
<p>Independentemente de qual das op√ß√µes acima tenha sido realmente a estrat√©gia exata adotada pelo banco, n√≥s t√≠nhamos a hip√≥tese de que esta regra de neg√≥cio (ou este ‚Äúcrit√©rio estranho‚Äù) estava afetando severamente o resultado das vendas.</p>
<p>Criamos essa hip√≥tese, pois n√≥s percebemos uma grande perda de usu√°rios na etapa do fluxo de vendas onde fazemos todas as m√∫ltiplas valida√ß√µes atrav√©s da API, verificando se o usu√°rio se enquadrava ou n√£o em todos os crit√©rios e regras de neg√≥cio.</p>
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-08-31-data-decisions/funnel-chart-pt.png" class="img-fluid"></p>
<p>N√≥s n√£o sab√≠amos qual dos muitos crit√©rios espec√≠ficos era a verdadeira fonte desta perda. Mas n√≥s t√≠nhamos a suspeita de que o crit√©rio ‚Äúeleg√≠vel para todas as 3 modalidades‚Äù era o crit√©rio problem√°tico que gerava essa enorme perda.</p>
<p>Em outras palavras, n√≥s suspeitamos que essa estrat√©gia de rejeitar usu√°rios que n√£o possu√≠am as tr√™s modalidades n√£o valia a pena, independente de quais decis√µes o banco tenha realmente tomado para incluir esse crit√©rio no fluxo de vendas. Mas precis√°vamos confirmar esta hip√≥tese.</p>
<p>N√≥s t√≠nhamos acesso aos dados retornados pela API (a que usamos para puxar v√°rias informa√ß√µes do usu√°rio), e com esses dados, n√≥s poder√≠amos potencialmente identificar quais usu√°rios possu√≠am as tr√™s modalidades e quais n√£o possu√≠am. Ent√£o eu montei um script de R simples para coletar atrav√©s da API os dados de cada usu√°rio que visitou o nosso fluxo de vendas no √∫ltimo m√™s, e coloquei esse script para rodar durante a noite.</p>
<p>No dia seguinte, eu tinha todos os dados localmente na minha m√°quina, que tinham um formato parecido com esse:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb1-1"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb1-2">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-3">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"username"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ana"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-4">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"cpf"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"12212212212"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_analysis"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:{</span></span>
<span id="cb1-6">         <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_modalities_elegible_to"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-7">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-8">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-9">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-10">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"username"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mike"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-11">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"cpf"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"13313313313"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-12">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_analysis"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:{</span></span>
<span id="cb1-13">         <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_modalities_elegible_to"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[]</span></span>
<span id="cb1-14">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-15">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-16">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-17">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"username"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Arthur"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-18">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"cpf"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"14414414414"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-19">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_analysis"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:{</span></span>
<span id="cb1-20">         <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loan_modalities_elegible_to"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-21">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-22">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-23"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<p>Come√ßamos ent√£o a analisar esses dados, investigando os metadados de cada usu√°rio e potencialmente medindo o tamanho do buraco que essa regra de neg√≥cio estava criando.</p>
<p>Como resultado, descobrimos que o banco estava constantemente <strong>perdendo uma grande oportunidade</strong> por causa desse crit√©rio estranho, ou, dessa regra de neg√≥cio espec√≠fica. Fazendo algumas contas b√°sicas, identificamos que <strong>67% dos usu√°rios que visitaram nosso canal n√£o eram eleg√≠veis √†s tr√™s modalidades</strong>. Isso significa que 67% dos usu√°rios que entravam em nosso canal eram automaticamente rejeitados. Est√°vamos constantemente perdendo uma grande quantidade de potenciais <em>leads</em> porque eles n√£o se enquadravam nesse crit√©rio.</p>
<p>Tendo isso em mente, por exemplo, se 13.000 usu√°rios entrassem em nosso canal, apenas (1 - 0,67) x 13.000 = 4.290 desses usu√°rios poderiam potencialmente terminar o fluxo e adquirir o empr√©stimo. Os 8.710 usu√°rios restantes eram automaticamente perdidos. Eles eram rejeitados porque n√£o tinham essas tr√™s modalidades.</p>
<p>Essa descoberta gerou algumas possibilidades importantes para n√≥s:</p>
<ul>
<li>Estamos alcan√ßando o p√∫blico certo?</li>
<li>Talvez dev√™ssemos focar em atrair apenas pessoas que possuem as tr√™s modalidades para o nosso canal?</li>
<li>Este crit√©rio ou regra de neg√≥cio vale a pena?</li>
</ul>
</section>
<section id="usando-dados-para-atingir-um-resultado-melhor" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Usando dados para atingir um resultado melhor</h1>
<p>Nosso trabalho foi usar os dados que coletamos da API para mostrar ao banco que, os ganhos potenciais de vendermos diferentes tipos de empr√©stimos para esses usu√°rios que n√£o tinham as tr√™s modalidades eram muito maiores do que o risco que esses usu√°rios ofereciam, ou muito maiores que o esfor√ßo necess√°rio para desenvolver essa nova estrat√©gia de vendas no fluxo.</p>
<p>Ou seja, usando dados, n√≥s podiamos mostrar ao banco (em n√∫meros) o tamanho da oportunidade que ele estava perdendo. E foi exatamente isso que fizemos. Nosso argumento foi basicamente dividido em duas partes distintas:</p>
<ol type="1">
<li>o tamanho do buraco, ou da perda que est√°vamos tendo;</li>
<li>o tamanho do ganho potencial que poder√≠amos ter.</li>
</ol>
<p>A primeira parte da nossa apresenta√ß√£o estava focada nos 67%. N√≥s mostramos ao banco que 67% dos usu√°rios (que √© um n√∫mero enorme) eram constantemente rejeitados no fluxo. Mas este n√∫mero por si s√≥ n√£o tem muito significado. Desde que o banco esteja maximizando o seu lucro, ele n√£o se importa se ele est√° recusando 60%, 70%, ou 80% dos usu√°rios.</p>
<p>√â por isso que na segunda parte da apresenta√ß√£o fizemos algumas contas b√°sicas para estimar os ganhos potenciais que eles estavam perdendo por n√£o venderem para esses 67% de usu√°rios.</p>
</section>
<section id="a-nova-estrat√©gia-de-vendas" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> A nova estrat√©gia de vendas</h1>
<p>Uma r√°pida recapitula√ß√£o. Cada usu√°rio que entrava no nosso fluxo de vendas desejava obter um empr√©stimo. Por√©m, esse usu√°rio precisava ser eleg√≠vel a tr√™s tipos diferentes de empr√©stimo para realmente ser capaz de adquirir o empr√©stimo que desejava por meio do nosso canal.</p>
<p>Mas, e se mudarmos esse fluxo de vendas, para que:</p>
<ul>
<li>O usu√°rio n√£o precise ser eleg√≠vel √†s tr√™s modalidades para adquirir um empr√©stimo;</li>
<li>Se um usu√°rio for eleg√≠vel a uma modalidade espec√≠fica, ent√£o devemos oferecer um empr√©stimo dessa modalidade a que ele √© eleg√≠vel;</li>
<li>Caso um usu√°rio seja eleg√≠vel a mais de uma modalidade, ent√£o, devemos oferecer m√∫ltiplas op√ß√µes de empr√©stimos para ele, uma para cada modalidade a que ele √© eleg√≠vel;</li>
</ul>
<p>Usando os mesmos dados da API que usamos para chegar aos 67%, n√≥s tamb√©m estimamos que, se alter√°ssemos o fluxo de vendas para que ele se ajustasse √†s condi√ß√µes acima, aumentar√≠amos a cobertura de usu√°rios para 96,8%! Isto significa que poder√≠amos vender um empr√©stimo a 96,8% dos usu√°rios que entrassem no nosso fluxo de vendas, em vez de apenas 33%.</p>
<p>Caso voc√™ esteja pensando que 33% + 67% deveria ser igual a 100%, voc√™ est√° se esquecendo de que o usu√°rio precisa se enquadrar em alguns outros crit√©rios que n√£o mencionei aqui. Ou seja, 96,8 - 100 = 3,2% dos usu√°rios ainda seriam rejeitados por n√£o se enquadrarem em outros crit√©rios necess√°rios.</p>
</section>
<section id="o-resultado-final" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> O resultado final</h1>
<p>O tempo e o esfor√ßo necess√°rios para desenvolver esta nova estrat√©gia no fluxo de vendas eram relativamente baixos e os ganhos potenciais dela eram bastante elevados! Ao aumentar a cobertura de usu√°rios de 33% para 96,8%, estimamos que as vendas poderiam ter um aumento potencial de 193%. Spoiler! Essa estimativa foi muito baixa em compara√ß√£o com o resultado final que obtivemos. Mas √© assim que estimativas funcionam, n√£o √© mesmo? S√£o apenas estimativas.</p>
<p>Ent√£o os gerentes do banco ficaram muito felizes com a proposta. Os gestores rapidamente aceitaram a ideia. Um baixo esfor√ßo para um ganho potencial alto.</p>
<p>Se voc√™ pensar sobre, essa nova estrat√©gia que criamos era muito simples. Ela apenas inclu√≠a mais op√ß√µes para os usu√°rios que n√£o se enquadravam no cen√°rio ideal do banco. Mas apesar dessa estrat√©gia ser simples, n√≥s escrevemos uma proposta bem curta, clara e eficaz (eram basicamente apenas 4 slides). N√≥s mostramos o tamanho do buraco ao banco e tamb√©m mostramos o tamanho da oportunidade que poder√≠amos obter se implement√°ssemos essa nossa nova estrat√©gia, e tamb√©m mostr√°mos que esta nova estrat√©gia era relativamente f√°cil e r√°pida de ser implementada no fluxo.</p>
<p>No entanto, o resultado final foi enorme. No primeiro m√™s ap√≥s implementarmos esta nova estrat√©gia no ambiente de produ√ß√£o, as vendas aumentaram aproximadamente 142%, j√° no segundo m√™s, o aumento chegou a 400%. As vendas deste empr√©stimo espec√≠fico t√™m uma forte componente sazonal, por isso temos uma varia√ß√£o t√£o grande de 142% a 400%. Mas de qualquer modo, isto demonstra o impacto positivo que a nossa nova estrat√©gia obteve. O resultado final de <strong>400% de aumento de vendas</strong> com a nossa proposta foi enorme.</p>
</section>
<section id="conclus√£o" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Conclus√£o</h1>
<p>Identificamos um crit√©rio estranho que nosso cliente incluiu no fluxo de vendas. Levantamos algumas hip√≥teses simples sobre esse crit√©rio estranho e usamos dados para confirmar ou testar essa hip√≥tese.</p>
<p>Ao analisar esses dados, identificamos uma grande oportunidade para o nosso cliente. Constru√≠mos ent√£o uma apresenta√ß√£o simples com uma proposta ao nosso cliente, com os n√∫meros que calculamos a partir da an√°lise dos dados que fizemos.</p>
<p>No final, esta proposta foi um grande sucesso para a nossa equipe, e tamb√©m para o nosso cliente que obteve um grande aumento de vendas ap√≥s implementarmos as melhorias que propusemos.</p>


</section>

 ]]></description>
  <category>Data Storytelling</category>
  <category>Data Science</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-08-31-data-decisions/pt/</guid>
  <pubDate>Sat, 28 Oct 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-08-31-data-decisions/decision.avif" medium="image" type="image/avif"/>
</item>
<item>
  <title>Improving decision making with Git and why you should care</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-07-31-git-mark-decisions/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Last week, me and my team encountered a situation where we need to find out why and how a certain problem occurred. We needed to understand which decisions led to this problem, and why they were made. Pretty normal stuff right?</p>
<p>But understanding what happened was only possible for us because we track every change and every decision that we make with Git, by signing commits and writing Pull Requests (or PRs for short). This article uses this real world situation that we faced to showcase how Git and formal processes to register changes in the codebase (like PRs) are a critical part for improving decision making and understanding how your past decisions are affecting you in the present.</p>
<p>I begin the article describing what problem occurred, and in sequence, I explain what mistakes were made, and how Git helped us to identify those mistakes.</p>
</section>
<section id="what-is-the-argument-in-this-article" class="level1">
<h1>What is the argument in this article?</h1>
<p>To improve your decision making process, you need to actually remember what decisions you made in the first place. Sometimes, that remembering is actually hard.</p>
<p>Different people use different strategies to keep track of the decisions they made. Some people keep various notes about each decision, others, like to document their decisions inside the cards created in the kanban board. But regardless of what strategy you choose, it will always involve some kind (or level) of tracking and documenting the decisions you make along the way.</p>
<p>In this article, I show an real world example where Git and formal Pull Request played this role. In other words, this article seeks to show how Git and Pull Requests can help you to keep track of the decisions that are being made in your team. Who and why they made these decisions? When these decisions took place? etc.</p>
</section>
<section id="the-data-pipeline-where-the-problem-occurred" class="level1">
<h1>The data pipeline where the problem occurred</h1>
<p>The problem occurred in one of the many data pipelines<sup>1</sup> that we manage and support. This specific data pipeline was a ‚Äúaggregate the data and send the results to client‚Äù type of pipeline. In more technical details, this pipeline was a JSON file that cointained all metadata that described what this pipeline was, what steps it performed, what were the dependencies and settings for each task, which specific time of the day these tasks should be performed, etc.</p>
<p>The main step (or task) performed in this pipeline was triggering the execution of a Python notebook. This notebook was perfoming the following steps:</p>
<ol type="1">
<li>aggregates the raw data to get the total sales made per channel.</li>
<li>saves the result in a CSV or Excel file.</li>
<li>send this CSV or Excel file by email to the client.</li>
</ol>
<p>The following diagram show these steps in a visual manner:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-07-31-git-mark-decisions/diagrams-en.png" class="img-fluid figure-img"></p>
<figcaption>A diagram that summarises the data pipeline were the problem occurred</figcaption>
</figure>
</div>
</section>
<section id="what-problem-occurred" class="level1">
<h1>What problem occurred ?</h1>
<p>Our client notified us saying that they were not receiving the CSV files for about a week. So we started to search for this data pipeline, to look at it‚Äôs execution logs. But we did not find anything! Both the Python notebook and the JSON file that described the data pipeline itself disappeared! Is like they never existed.</p>
<p>Not having the Python notebook, is the same as not having any pipeline at all. Both Python and JSON files had simply disapeared from our repository. But the client did received some files a few weeks ago, so, we were positive that this pipeline did existed at some point in the past. But where did it go? Why it disappeared?</p>
</section>
<section id="investigating-the-commmits" class="level1">
<h1>Investigating the commmits</h1>
<p>We use Git to store and track any changes in all of our data pipelines. In other words, all changes that we make to the JSON files that describes each one of our data pipelines are tracked by Git. As you well know, a file do not simply disappear from a Git repository. When a file is removed from a Git repository, is because someone intentionally deleted the file and committed the change to the repository.</p>
<p>Since we knew that this data pipeline existed at some point in the time, I started to investigate, and follow the history of commits. Took around 30 minutes to find the exact commit that deleted the data pipeline, and, oops! The commit was created by me! I deleted the data pipeline from our repository. Ok‚Ä¶ now Why? Why did I deleted this data pipeline?</p>
<p>At this point, Git already helped me to answer two very important questions which were: 1. Who deleted the pipeline? 2. When it was deleted? Because every commit you create in Git have a timestamp associated with it, and the name of the author of that commit, we knew at that point that it was me that deleted the pipeline, a few weeks ago.</p>
</section>
<section id="why-i-made-this-decision" class="level1">
<h1>Why I made this decision?</h1>
<p>But that alone does not answers another part of the problem. We still need to know why I made that decision. Why did I intentionally deleted this pipeline? This is the point where Pull Requests<sup>2</sup> can help us.</p>
<p>Every time we want to publish some changes that we made to a data pipeline, we need to document these changes in a PR. We describe what changes we made, and why we made them. I found the associated PR that contained the commit I made, and in the description of that PR I found the reason why I deleted the pipeline.</p>
<p>The pipeline was constantly failing with a ‚Äúnotebook not found‚Äù error. In other words, the pipeline was trying to trigger the execution of the Python notebook that I mentioned before. But the notebook itself was not found, and because of that, it was throwing this error. This means that the pipeline was basically useless, it was creating execution costs without delivering any value. It also means, that the Python notebook disappeared before the pipeline was deleted.</p>
<p>So I deleted the pipeline. This way we were not spending our resources trying to execute something that we know is going to throw an error, and will not give any value.</p>
</section>
<section id="another-part-of-the-problem" class="level1">
<h1>Another part of the problem</h1>
<p>Ok, now we know why I deleted the pipeline. But that in itself raises some new questions for us. Why did the Python notebook disappeared? The reality is that‚Ä¶ we didn‚Äôt know why. Unfortunately, our Python notebooks were not hosted inside a Git repository. This means that we did not traced any changes that were made to the notebook.</p>
<p>To be fair, our Python notebooks are hosted inside a Databricks instance, and, if you are familiar with Databricks, you know that actually the Databricks platform do track (to some extent) every change that is made to the notebook, with the <a href="https://docs.databricks.com/pt/notebooks/notebooks-code.html#version-control">Revisions pannel</a>.</p>
<p>So yes, we do have some level of monitoring over the changes made to these notebooks. But not enough to actually understand why that particular notebook was missing. In other words, this ‚ÄúRevision‚Äù pannel of Databricks is not capable of tracking removal actions over notebooks.</p>
<p>We were only able to figure it out what was happening in the week after, when we discover that other Python notebooks were also missing. Was a set of three notebooks, called <code>Job_ClientX_Opened_Sessions</code>, <code>Job_ClientX_Sales_per_Channel</code> and <code>Job_ClientX_Opened_Tickets</code>. These three notebooks were located at the folder <code>ClientX</code>. So we had a file structure like this:</p>
<pre><code>‚îú‚îÄ‚îÄ‚îÄüìÅ ClientX
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄJob_ClientX_Opened_Sessions.py
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄJob_ClientX_Sales_per_Channel.py
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄJob_ClientX_Opened_Tickets.py
‚îÇ 
‚îú‚îÄ‚îÄ‚îÄüìÅ ClientY
‚îú‚îÄ‚îÄ‚îÄüìÅ ClientW
‚îî‚îÄ‚îÄ‚îÄüìÅ ClientZ
...</code></pre>
<p>At that specific day, we found in the execution logs that , close to 08:00 AM, this set of notebooks was avaialable, in other words, they did existed in our Databricks environment close to 08:00 AM. But on that same day, when we searched again at 11:00 AM for these same notebooks in the Databricks environment, we did not found them anymore.</p>
<p>We knew at that point, that these notebooks disappeared within the last 3 hours. It was very recent. But a detail called our attention. The folder <code>ClientX</code>, where these notebooks were supposed to be, was filled with other notebooks with similar names, like this:</p>
<pre><code>‚îú‚îÄ‚îÄ‚îÄüìÅ ClientX
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ[ClientX] Opened sessions.py
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ[ClientX] Sales per Channel.py
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ[ClientX] Opened Tickets.py
‚îÇ 
‚îú‚îÄ‚îÄ‚îÄüìÅ ClientY
‚îú‚îÄ‚îÄ‚îÄüìÅ ClientW
‚îî‚îÄ‚îÄ‚îÄüìÅ ClientZ
...</code></pre>
<p>That looks weird, because it go against our naming conventions. Me and my team do not name files like this. Than, we raised the question: ‚Äúwait! I think someone is renaming these notebooks‚Äù. Later that day, our suspicions were confirmed. A colleague outside of our team was intentionally renaming the Python notebooks that were published in the production environment. That is why we were not finding the notebooks, because their names were modified.</p>
<p>The immediate consequence of this renaming action was that the link between the Python notebooks and the data pipelines was lost. That is, the data pipelines were trying to execute these notebooks, but they did not find these notebooks, because their original names were lost.</p>
<p>If we did used Git to track every change made to these python notebooks, we would have discovered this problem much earlier, and could acted to fix it. But the damage was already made. As next steps, we had to:</p>
<ol type="1">
<li>rename the notebooks back to their original names;</li>
<li>remove some of the privileges of our colleague in the Databricks environment;</li>
<li>advise this colleague about what happened, and how his actions caused harm.</li>
</ol>
</section>
<section id="what-mistakes-were-made" class="level1">
<h1>What mistakes were made?</h1>
<p>Below we have the timeline of important events we described:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-07-31-git-mark-decisions/timeline.png" class="img-fluid figure-img"></p>
<figcaption>The timeline of events</figcaption>
</figure>
</div>
<p>In my head, there was at least three mistakes that were made across this timeline:</p>
<ol type="1">
<li>I did not communicated the removal of the pipeline properly;</li>
<li>Our colleague renamed a notebook in a production environment;</li>
<li>Not using Git to track changes in the notebooks at production environment.</li>
</ol>
<p>Deleting the pipeline was not a mistake. But my mistake was to not <strong>communicate my action</strong> properly. I mean, I did communicated the removal of the pipeline to my peers, but I did not communicate it to my colleague outside of my team that was also involved with this specific client, the same colleague that started to rename multiple notebooks.</p>
<p>In other words, if I had communicated to him that I deleted the pipeline, we would probably have a dialog similar to this:</p>
<ul>
<li><p>Colleague: ‚Äúwait! Our client is still using this data pipeline, why did you removed it?‚Äù</p></li>
<li><p>Me: ‚Äúbecause the pipeline was not finding the notebook‚Äù</p></li>
<li><p>Colleague: ‚Äúbut why is it not finding the notebook?‚Äù</p></li>
<li><p>Me: ‚Äúwell, the pipeline is looking for a notebook called ‚ÄòX‚Äô, but this notebook disappeared. It does not exist in our environment.‚Äù</p></li>
<li><p>Colleague: ‚Äúwait! I remember of this notebook! I think I just renamed it a few days ago‚Äù</p></li>
<li><p>Me: ‚Äúwait! You renamed a notebook in production?‚Äù</p></li>
<li><p>Colleague: ‚Äúyes, I think so‚Äù</p></li>
</ul>
<p>With this dialog we could probably solved the puzzle much quicker, and we could fix the mistakes before any more harm could be created. So if I did communicated to this colleague that I deleted the pipeline, we would probably reach the core of the problem more quickly.</p>
<p>Everything started when our colleague decided to rename a notebook directly in the production environment without us knowing. This was certainly a mistake, but who does not mistakes sometimes right? As we described in the article, the ‚ÄúRevision system‚Äù of Databricks is limited, and did not tracked this very important change, and because of that, we initially had no idea what have happened with the notebook.</p>
<p>We took one week to actually figure it out what was causing the ‚Äúdisappearance‚Äù of the notebooks. If we did use Git to track all changes made to the notebooks published in the production environment, we would spot the ‚Äúrenaming action‚Äù made much, much, much quicker. So not using Git over these notebooks was a mistake too.</p>
</section>
<section id="how-git-helped-us-to-solve-the-issue" class="level1">
<h1>How Git helped us to solve the issue</h1>
<p>Git is an extremely powerful tool, and by having a centrallized server that register all changes you make to the project, you can look at the past, understand what changes you made. You can actually see the evolution or the timeline of your project, and perceive how much features, or, how much improvements you made to the project. You can also spot the decisions you made in the past. This gives you the ability to re-think your decision making process.</p>
<p>One fact we knew from the beggining: a data pipeline and a Python notebook simply disappeared from our environment. With Git we manage to track down and understand how, when and why did the data pipeline disappeared, and we were able to locate the data pipeline again, and restore it to it‚Äôs previous state, and re-send the files. If we did used Git on the notebooks, we could also track down the renaming operations made to these notebooks as well.</p>
<p>Not only did we fixed the issue, but also, by understanding what happened, and what decisions were made that led to the dissapeareance of the data pipeline, we could identify the flaws in our decision making process. And by identifying these issues, we can now address them, so we do not make these mistakes again.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>What is a pipeline? A pipeline is just a sequence of steps (or tasks) to be performed at a specific time of the day (or a specific day of the week or of the month, etc.). And a data pipeline is a pipeline that contains tasks that load, transform, send, or ingest data in some form.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>In essence, a Pull Request (or PR) is a <strong>proposal</strong> to perform a <code>git merge</code> operation. In other words, you create a PR when you want to merge the changes you made in a branch into another branch (most of the times the main branch). The ‚Äúproposal‚Äù aspect of a PR means that it needs be approved to be effectively performed. A PR is not a feature from Git. It is actually a standard feature from most Git service providers. So you create a PR inside a Git services platform such as GitHub, GitLab and Azure DevOps, and not inside Git itself. If you are not familiar with PRs, the <a href="https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests">GitHub documentation has an excellent article about it</a>‚Ü©Ô∏é</p></li>
</ol>
</section></div> ]]></description>
  <category>Git</category>
  <category>Decisions</category>
  <category>Documentation</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-07-31-git-mark-decisions/en/</guid>
  <pubDate>Mon, 31 Jul 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-07-31-git-mark-decisions/git-logo.png" medium="image" type="image/png" height="70" width="144"/>
</item>
<item>
  <title>Melhorando a tomada de decis√£o com Git e porqu√™ voc√™ deveria se importar</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-07-31-git-mark-decisions/pt/</link>
  <description><![CDATA[ 





<section id="introdu√ß√£o" class="level1">
<h1>Introdu√ß√£o</h1>
<p>Na semana passada, eu e minha equipe nos deparamos com uma situa√ß√£o em que precis√°vamos descobrir por que e como ocorreu um determinado problema. Precis√°vamos entender quais decis√µes levaram a esse problema. Algo bem normal, n√£o √©?</p>
<p>Mas entender o que aconteceu s√≥ foi poss√≠vel para n√≥s porque rastreamos cada mudan√ßa e cada decis√£o que tomamos com o Git, assinando commits e escrevendo Pull Requests (ou PRs para abreviar). Este artigo usa essa situa√ß√£o do mundo real que enfrentamos para mostrar como o Git e os processos formais para registrar altera√ß√µes na base de c√≥digo (como PRs) s√£o uma parte cr√≠tica para melhorar a tomada de decis√µes e entender como suas decis√µes passadas est√£o afetando voc√™ no presente.</p>
<p>Come√ßo o artigo descrevendo qual foi o problema que n√≥s enfrentamos e, na sequ√™ncia, explico quais erros foram cometidos e como o Git nos ajudou a identificar esses erros.</p>
</section>
<section id="qual-√©-o-argumento-deste-artigo" class="level1">
<h1>Qual √© o argumento deste artigo?</h1>
<p>Para melhorar o seu processo de tomada de decis√£o, voc√™ precisa primeiro se lembrar de quais foram as decis√µes que voc√™ tomou. √Äs vezes, essa lembran√ßa se torna uma tarefa realmente dif√≠cil.</p>
<p>Diferentes pessoas adotam estrat√©gias diferentes para acompanhar as decis√µes que tomaram. Algumas pessoas mant√™m v√°rias anota√ß√µes sobre cada decis√£o, outros, gostam de documentar suas decis√µes dentro dos cart√µes (ou <em>cards</em>) criados dentro do quadro kanban de sua equipe. Mas independentemente de qual seja a estrat√©gia que voc√™ escolher, ela sempre vai envolver algum tipo (ou n√≠vel) de rastreamento e tamb√©m de documenta√ß√£o dessas decis√µes que voc√™ faz ao longo do caminho.</p>
<p>Neste artigo, mostro um exemplo do mundo real em que o Git e o Pull Request formal desempenharam esse papel. Em outras palavras, este artigo busca mostrar como Git e Pull Requests podem te ajudar a acompanhar as decis√µes que est√£o sendo feitas em sua equipe. Quem e por que eles tomaram essas decis√µes? Quando essas decis√µes aconteceram? etc.</p>
</section>
<section id="o-pipeline-de-dados-onde-ocorreu-o-problema" class="level1">
<h1>O pipeline de dados onde ocorreu o problema</h1>
<p>O problema ocorreu em um dos muitos pipelines de dados<sup>1</sup> que gerenciamos e oferecemos suporte. Esse pipeline de dados espec√≠fico era um pipeline do tipo ‚Äúagregar os dados e enviar os resultados ao cliente‚Äù. Em detalhes mais t√©cnicos, esse pipeline era um arquivo JSON que continha todos os metadados que descreviam o que era esse pipeline, quais etapas deveriam ser executavas, quais eram as depend√™ncias e configura√ß√µes de cada tarefa, em que hor√°rio espec√≠fico do dia essas tarefas deveriam ser executadas, etc.</p>
<p>A principal etapa (ou tarefa) executada nesse pipeline era a execu√ß√£o de um notebook de Python. Este notebook estava executando as seguintes etapas:</p>
<ul>
<li>agregar os dados brutos para obter o total de vendas feitas por canal.</li>
<li>salva o resultado em um arquivo CSV ou Excel.</li>
<li>enviar este arquivo CSV ou Excel por e-mail para o cliente.</li>
</ul>
<p>O diagrama a seguir mostra essas etapas de maneira visual:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-07-31-git-mark-decisions/diagrams-pt.png" class="img-fluid figure-img"></p>
<figcaption>Um diagrama que resume o pipeline de dados onde o problema ocorreu</figcaption>
</figure>
</div>
</section>
<section id="qual-foi-o-problema-que-ocorreu" class="level1">
<h1>Qual foi o problema que ocorreu?</h1>
<p>Um dia, nosso cliente nos notificou dizendo que n√£o estava recebendo os arquivos CSV h√° cerca de uma semana. Ent√£o come√ßamos a procurar por esse pipeline de dados, com o objetivo de verificar os seus logs de execu√ß√£o. Contudo, n√≥s simplesmente n√£o encontramos nada! Tanto o notebook Python quanto o arquivo JSON que descrevia o pr√≥prio pipeline de dados desapareceram! √â como se eles nunca tivessem existido.</p>
<p>N√£o ter o notebook Python era a mesma coisa que n√£o ter pipeline nenhum. Os arquivos Python e JSON simplesmente desapareceram de nosso reposit√≥rio. Mas n√≥s sab√≠amos que o cliente tinha recebido alguns arquivos a algumas semanas atr√°s, portanto, t√≠nhamos certeza de que esse pipeline existia em algum momento no passado. Mas para onde ele foi? Por que ele desapareceu?</p>
</section>
<section id="investigando-os-commits" class="level1">
<h1>Investigando os commits</h1>
<p>Usamos o Git para armazenar e rastrear quaisquer altera√ß√µes feitas em todos os nossos pipelines de dados. Em outras palavras, todas as altera√ß√µes que fazemos nos arquivos JSON que descrevem cada um de nossos pipelines de dados s√£o rastreadas pelo Git. Como voc√™ bem sabe, um arquivo simplesmente n√£o desaparece de um reposit√≥rio Git. Quando um arquivo √© removido de um reposit√≥rio Git, √© porque algu√©m excluiu intencionalmente o arquivo, e criou o commit da altera√ß√£o no reposit√≥rio.</p>
<p>Como sab√≠amos que esse pipeline de dados existia em algum momento, eu comecei a investigar e seguir o hist√≥rico de commits. Demorou cerca de 30 minutos para encontrar o commit exato que excluiu o pipeline de dados e, oops! O commit foi criado por mim! Eu exclu√≠ o pipeline de dados do nosso reposit√≥rio. Ok‚Ä¶ agora, por qu√™? Por que eu exclu√≠ esse pipeline de dados?</p>
<p>A essa altura, o Git j√° me ajudou a responder duas quest√µes muito importantes que eram: 1. Quem deletou o pipeline? 2. Quando foi exclu√≠do? Pois todo commit que voc√™ cria no Git tem um carimbo de data/hora associado a ele e o nome do autor desse commit, sab√≠amos naquele momento que fui eu quem excluiu o pipeline, a algumas semanas atr√°s.</p>
</section>
<section id="por-que-tomei-essa-decis√£o" class="level1">
<h1>Por que tomei essa decis√£o?</h1>
<p>Mas isso por si s√≥ n√£o responde a outra parte do problema. Ainda precisamos saber o porqu√™ tomei essa decis√£o. Por que exclu√≠ intencionalmente este pipeline? Este √© o ponto onde Pull Requests<sup>2</sup> podem nos ajudar.</p>
<p>Sempre que quisermos publicar alguma altera√ß√£o que fizemos em um pipeline de dados, precisamos documentar essa altera√ß√£o em um PR. Descrevemos quais mudan√ßas foram feitas e por que as fizemos. Encontrei o PR associado que continha o commit que fiz e, na descri√ß√£o desse PR, descobri o motivo pelo qual exclu√≠ o pipeline.</p>
<p>O pipeline estava constantemente falhando com um erro de ‚Äúnotebook n√£o encontrado‚Äù. Em outras palavras, o pipeline estava tentando acionar a execu√ß√£o do notebook Python que mencionei anteriormente. Por√©m o notebook em si n√£o foi encontrado, e por conta disso, estava dando esse erro. Isso significa que o pipeline era basicamente in√∫til, ele estava criando custos de execu√ß√£o sem entregar nenhum valor. Isso tamb√©m significa que o notebook Python desapareceu antes que o pipeline fosse exclu√≠do.</p>
<p>Ent√£o eu apaguei o pipeline. Dessa forma, n√≥s deixamos de gastar nossos recursos tentando executar algo que sabemos que vai gerar um erro de execu√ß√£o, e, consequentemente, n√£o vai gerar nenhum valor.</p>
</section>
<section id="a-outra-parte-do-problema" class="level1">
<h1>A outra parte do problema</h1>
<p>Ok, agora sabemos o porqu√™ de eu ter exclu√≠do o pipeline. Mas isso por si s√≥ levanta algumas novas quest√µes. Por que o notebook Python desapareceu? Todavia, a realidade √© que‚Ä¶ n√£o sab√≠amos o porqu√™. Infelizmente, nossos notebooks Python n√£o estavan hospedados em um reposit√≥rio Git. Isso significa que n√£o nenhuma altera√ß√£o feita no notebook era rastreada.</p>
<p>Por√©m, para ser justo, nossos notebooks Python s√£o hospedados dentro de uma inst√¢ncia do Databricks e, se voc√™ estiver familiarizado com o Databricks, saber√° que, na verdade, a plataforma Databricks rastreia sim (at√© certo ponto) altera√ß√µes feitas no notebook, atrav√©s do <a href="https://docs.databricks.com/pt/notebooks/notebooks-code.html#version-control">painel de ‚ÄúRevisions‚Äù</a>.</p>
<p>Ent√£o, sim, temos algum n√≠vel de monitoramento sobre as altera√ß√µes feitas nesses notebooks. Mas n√£o temos um n√≠vel suficiente para realmente entendermos por que aquele caderno em particular estava faltando. Em outras palavras, esse painel de ‚ÄúRevisions‚Äù do Databricks n√£o √© capaz de rastrear a√ß√µes de remo√ß√£o em notebooks.</p>
<p>N√≥s s√≥ conseguimos descobrir o que estava acontecendo na semana seguinte, quando identificamos que outros notebooks de Python tamb√©m haviam sumido misteriosamente da pasta do mesmo cliente. Era um conjunto de tr√™s notebooks, chamados <code>Job_ClientX_Opened_Sessions</code>, <code>Job_ClientX_Sales_per_Channel</code> e <code>Job_ClientX_Opened_Tickets</code>. Esses tr√™s notebooks estavam localizados na pasta <code>ClientX</code>. Ent√£o, t√≠nhamos uma estrutura de arquivo como esta:</p>
<pre><code>‚îú‚îÄ‚îÄ‚îÄüìÅ ClientX
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄJob_ClientX_Opened_Sessions.py
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄJob_ClientX_Sales_per_Channel.py
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄJob_ClientX_Opened_Tickets.py
‚îÇ 
‚îú‚îÄ‚îÄ‚îÄüìÅ ClientY
‚îú‚îÄ‚îÄ‚îÄüìÅ ClientW
‚îî‚îÄ‚îÄ‚îÄüìÅ ClientZ
...</code></pre>
<p>Nesse dia espec√≠fico, descobrimos atrav√©s dos logs de execu√ß√£o que, por volta das 08:00 AM, esse conjunto de notebooks estava sim dispon√≠veis (ou seja, eles existiam de fato) em nosso ambiente Databricks por volta das 08:00. Mas nesse mesmo dia, quando n√≥s procuramos novamente √†s 11:00 por esses mesmos notebooks no ambiente Databricks, n√£o os encontramos mais.</p>
<p>Sab√≠amos naquele momento que esses notebooks haviam desaparecido nas √∫ltimas 3 horas. Era algo muito recente. Contudo, um detalhe chamou a nossa aten√ß√£o. A pasta <code>ClientX</code>, que era onde deveriam estar esses notebooks, estava preenchida com outros notebooks que possu√≠am nomes semelhantes aos que est√°vamos procurando, como estes:</p>
<pre><code>‚îú‚îÄ‚îÄ‚îÄüìÅ ClientX
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ[ClientX] Opened sessions.py
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ[ClientX] Sales per Channel.py
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ[ClientX] Opened Tickets.py
‚îÇ 
‚îú‚îÄ‚îÄ‚îÄüìÅ ClientY
‚îú‚îÄ‚îÄ‚îÄüìÅ ClientW
‚îî‚îÄ‚îÄ‚îÄüìÅ ClientZ
...</code></pre>
<p>A princ√≠pio, isso parecia muito estranho para n√≥s, pois esses nomes iam contra as nossas conven√ß√µes de nomenclatura. Ou seja, eu e minha equipe n√£o nomeamos arquivos dessa forma. Ent√£o, novas desconfian√ßa surgiram, e levantamos a seguinte hip√≥tese: ‚Äúespere! Acho que algu√©m est√° renomeando esses notebooks‚Äù. Mais tarde naquele dia, nossas suspeitas foram confirmadas. Um colega de fora de nossa equipe estava renomeando intencionalmente os notebooks de Python desse cliente que foram publicados no ambiente de produ√ß√£o. Por isso n√£o est√°vamos encontrando mais os notebooks, pois os seus nomes foram modificados.</p>
<p>A consequ√™ncia imediata dessa a√ß√£o de nosso colega foi que a conex√£o entre os notebooks de Python e os pipelines de dados foi perdida. Ou seja, os pipelines de dados estavam tentando executar esses notebooks, mas esses pipelines n√£o estavam encontrando mais esses notebooks, pois os seus nomes originais foram perdidos.</p>
<p>Se us√°ssemos o Git para rastrear todas as altera√ß√µes feitas nesses notebooks de Python, talvez n√≥s ter√≠amos descoberto esse problema muito mais cedo, e, com isso, poder√≠amos agir para corrigi-lo. Por√©m o estrago j√° havia sido feito. Como pr√≥ximos passos, o nosso time teve que:</p>
<ul>
<li>renomear os notebooks de volta para os seus nomes originais;</li>
<li>remover alguns dos privil√©gios de nosso colega no ambiente Databricks;</li>
<li>aconselhar este colega sobre o que aconteceu e como as suas a√ß√µes causaram danos.</li>
</ul>
</section>
<section id="quais-erros-foram-cometidos" class="level1">
<h1>Quais erros foram cometidos?</h1>
<p>Abaixo temos a linha do tempo dos eventos importantes que descrevemos at√© aqui:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-07-31-git-mark-decisions/timeline-pt.png" class="img-fluid figure-img"></p>
<figcaption>Uma timeline dos eventos</figcaption>
</figure>
</div>
<p>Na minha cabe√ßa, existem pelo menos tr√™s erros que foram cometidos ao longo desta linha do tempo:</p>
<ul>
<li>Eu n√£o comuniquei a retirada do pipeline de forma adequada;</li>
<li>Nosso colega estava renomeando notebooks em um ambiente de produ√ß√£o;</li>
<li>N√£o usamos o Git para rastrear altera√ß√µes nos notebooks no ambiente de produ√ß√£o.</li>
</ul>
<p>Excluir o pipeline n√£o foi um erro. Na realdiade, o meu erro foi n√£o comunicar a minha a√ß√£o da forma adequada. Quer dizer, eu comuniquei a remo√ß√£o do pipeline aos meus colegas, mas eu n√£o comuniquei essa remo√ß√£o ao meu colega de fora da minha equipe que tamb√©m estava envolvido com esse cliente espec√≠fico, o mesmo colega que come√ßou a renomear v√°rios notebooks em produ√ß√£o.</p>
<p>Em outras palavras, se eu tivesse comunicado a ele que exclu√≠ o pipeline, provavelmente o seguinte di√°logo teria acontecido:</p>
<ul>
<li><p>Colega: ‚Äúespere! Nosso cliente ainda est√° usando esse pipeline de dados, por que voc√™ o removeu?‚Äù</p></li>
<li><p>Eu: ‚Äúporque o pipeline n√£o estava encontrando o notebook‚Äù</p></li>
<li><p>Colega: ‚Äúmas porque ele n√£o estava achando o notebook?‚Äù</p></li>
<li><p>Eu: ‚Äúbom, o pipeline est√° procurando um notebook chamado ‚ÄòX‚Äô, mas esse notebook sumiu. N√£o existe em nosso ambiente‚Äù.</p></li>
<li><p>Colega: ‚Äúespere! Eu me lembro deste caderno! Acho que acabei de renome√°-lo h√° alguns dias‚Äù</p></li>
<li><p>Eu: ‚Äúespere! Voc√™ renomeou um notebook em produ√ß√£o?‚Äù</p></li>
<li><p>Colega: ‚Äúsim, acho que sim‚Äù</p></li>
</ul>
<p>Com este di√°logo, provavelmente poder√≠amos ter resolvido o quebra-cabe√ßa muito mais rapidamente e corrigido os erros antes que mais danos pudessem ser criados. Portanto, se eu tivesse comunicado a esse colega que exclu√≠ o pipeline, provavelmente atingir√≠amos o cerne do problema mais rapidamente.</p>
<p>Tudo come√ßou quando esse nosso colega decidiu renomear um notebook diretamente no ambiente de produ√ß√£o sem que soub√©ssemos. Isso com certeza foi um erro, mas quem n√£o erra as vezes n√©? Al√©m disso, como descrevemos no artigo, o sistema de ‚ÄúRevisions‚Äù do Databricks √© limitado e n√£o foi capaz de gravar essa mudan√ßa t√£o importante no notebook e, por causa disso, n√≥s inicialmente ficamos no escuro. N√≥s n√£o t√≠nhamos ideia do que havia acontecido com o notebook.</p>
<p>Levamos uma semana para realmente descobrir o que estava causando o ‚Äúdesaparecimento‚Äù dos notebooks. Se us√°ssemos o Git para rastrear todas as altera√ß√µes feitas nos notebooks publicados no ambiente de produ√ß√£o, n√≥s ter√≠amos identificado a ‚Äúa√ß√£o de renomear‚Äù muito, muito, muito mais r√°pido. Portanto, n√£o usar o Git nesses notebooks tamb√©m foi um erro.</p>
</section>
<section id="como-o-git-nos-ajudou-a-resolver-o-problema" class="level1">
<h1>Como o Git nos ajudou a resolver o problema</h1>
<p>O Git √© uma ferramenta extremamente poderosa. Ao termos um servidor centralizado que registra todas as mudan√ßas que cada pessoa faz no projeto, conseguimos olhar para o passado, e entender quais mudan√ßas foram feitas. Voc√™ pode realmente ver a evolu√ß√£o ou a linha do tempo do seu projeto e perceber quantos recursos ou melhorias voc√™ fez no projeto. Voc√™ tamb√©m pode identificar as decis√µes que tomou no passado. Isso lhe d√° a capacidade de repensar o seu processo de tomada de decis√£o.</p>
<p>Um fato que sab√≠amos desde o in√≠cio: um pipeline de dados e um notebook de Python simplesmente desapareceram de nosso ambiente. Com o Git conseguimos rastrear e entender como, quando e por que o pipeline de dados desapareceu, e conseguimos localizar o pipeline de dados novamente, restaur√°-lo ao seu estado anterior e reenviar os arquivos que o nosso cliente precisava. Se us√°ssemos o Git nos notebooks, tamb√©m poder√≠amos rastrear as opera√ß√µes de ‚Äúrenomear‚Äù que haviam sido feitas nesses notebooks.</p>
<p>N√≥s n√£o apenas corrigimos o problema, mas tamb√©m, ao entender o que aconteceu e quais decis√µes foram tomadas que levaram ao desaparecimento do pipeline de dados, pudemos identificar as falhas em nosso processo de tomada de decis√£o. E ao identificar esses problemas, agora podemos resolv√™-los, para n√£o cometermos esses erros novamente.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>O que √© um pipeline? Um pipeline √© apenas uma sequ√™ncia de etapas (ou tarefas) a serem realizada em uma hora espec√≠fica do dia (ou em um dia espec√≠fico da semana ou do m√™s, etc.). E um pipeline de dados √© um pipeline que cont√©m tarefas que carregam, transformam, enviam ou ingerem dados de alguma forma.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>Em resumo, um Pull Request (ou PR) √© uma <strong>proposta</strong> para realizar uma opera√ß√£o <code>git merge</code>. Em outras palavras, voc√™ cria um PR quando deseja mesclar as altera√ß√µes feitas em uma branch em outra branch (na maioria das vezes a main branch). O aspecto de ‚Äúproposta‚Äù de uma PR significa que este PR precisa ser aprovado para ser efetivamente executado. Um PR n√£o √© um recurso do Git. Na verdade, √© um recurso padr√£o da maioria dos provedores de servi√ßos Git. Ent√£o voc√™ cria um PR dentro de uma plataforma de servi√ßos Git como GitHub, GitLab e Azure DevOps, e n√£o dentro do pr√≥prio Git. Se voc√™ n√£o est√° familiarizado com PRs, a <a href="https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests">documenta√ß√£o do GitHub tem um excelente artigo sobre isso</a>.‚Ü©Ô∏é</p></li>
</ol>
</section></div> ]]></description>
  <category>Git</category>
  <category>Decisions</category>
  <category>Documentation</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-07-31-git-mark-decisions/pt/</guid>
  <pubDate>Mon, 31 Jul 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-07-31-git-mark-decisions/git-logo.png" medium="image" type="image/png" height="70" width="144"/>
</item>
<item>
  <title>A case study about Data Storytelling at some of the largest brazilian banks</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This article discusses how I improved my <em>Data Storytelling</em> process within my presentations and reports delivered to two of the largest commercial banks in the Brazilian market. I try to share what I learned in this process, and I give some tips that will possibly help you to build more intuitive, captivating, clear and effective data reports.</p>
<p>In summary, we will discuss in this article the following tips:</p>
<ul>
<li><em>Data Storytelling</em> is about telling stories through data;</li>
<li>Stories have structure, use these structures in your favor;</li>
<li>Avoid sharing too much attention with long texts on your slides;</li>
<li>Trace relationships between your data;</li>
<li>Build your story around a main message;</li>
<li>Deliver your story at small pieces;</li>
</ul>
<p>Most of this knowledge was built through intense research, reflection and planning about my presentations, and later, getting feedback, and making small adjustments here and there.</p>
<p>As you might expect with every great work like this, it also involved other peoples. During this process, I received help and feedback from my co-workers. Specially from <a href="https://www.linkedin.com/in/andressa-de-souza-freitas-697195177/">Andressa de Souza Freitas</a> and <a href="https://www.linkedin.com/in/guilhermeggarcia/">Guilherme Gomes</a>. I also had great help from the UX Designer <a href="https://www.linkedin.com/in/alefernandesbranding/">Al√™ Fernandes</a>. Most of the knowledge presented here, I learned in practice with Al√™. This knowledge revolutionized the way I build my presentations, and for that I am immensely grateful to her ‚ù§Ô∏è.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>All data, charts and images shown in this article are merely illustrative. All numbers shown were randomly generated by a computer! Therefore, they do not represent the actual data of TakeBlip or the comercial banks involved in any way or dimension!</p>
</div>
</div>
</section>
<section id="summary-of-the-structure-of-this-article" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Summary of the structure of this article</h1>
<p>In Section&nbsp;3 I provide more context about these reports that I delivered to two of the largest comercial banks in the Brazilian market. What was the usual format of these reports ? What were their main problems and limitations ?</p>
<p>But from Section&nbsp;4 and on, I start to discuss about how I improved these reports. You will notice that most of these improvements are concentrated in two areas:</p>
<ol type="1">
<li>build a presentation that is simple and clear;</li>
<li>build a presentation that has a good structure, that is, a structure that helps you to tell a story through your data;</li>
</ol>
<p>Section&nbsp;4.1 provides two tips that help you bring simplicity and clarity to your presentation, in addition to discussing why long texts on slides are so perverse for your viewers‚Äô attention.</p>
<p>At Section&nbsp;4.2 I discuss some tips on how to form the content of the presentation, more specifically, content that helps you build a story in your presentation.</p>
<p>At Section&nbsp;5, we take the tips that we discussed so far in the article, and we try to apply them to the slide shown in Figure&nbsp;3, with the objective of demonstrating how these tips can improve your presentation.</p>
<p>Lastly, at Section&nbsp;6, we discuss structure a lot. More specifically, I discuss two examples of frameworks that can serve as guides. They provide a simple foundation that you can use to build your story.</p>
<p>Anyway, let‚Äôs move on‚Ä¶</p>
</section>
<section id="sec-como-era-antes" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> How was this report before ?</h1>
<p>At the time, we were building a monthly report containing several indicators and graphs that showed the current status and recent evolution of the banks services and products offered within the WhatsApp channel.</p>
<p>However, the format of this presentation was problematic. We brought a <strong>monumental amount</strong> of information to the bank. The presentation usually had around 40 different slides, with approximately 36 charts and 70 different indicators. Furthermore, we tried to present all this volume of information in a meeting of just 1 hour.</p>
<p>The end result was a presentation that brought a monumental volume of information, however, which also brought a <strong>very small volume of insights and new business ideas for managers</strong>.</p>
<p>In Figure&nbsp;1 we have a representation of one of the several slides of this presentation<sup>1</sup>. Imagine that this presentation had around 40 slides similar to this one:</p>
<div id="fig-print-report1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-print-report1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/print-report1-en.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-print-report1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: A single slide from the old version of the report
</figcaption>
</figure>
</div>
<p>Note that this slide looks more like a dashboard page than a report showing the latest trends in the products and services of the bank, or, on the financial market as a whole.</p>
<p><strong>This is very important!</strong> If your presentation has a lot of different indicators scattered around the page, without contextualizing them, without relating them to each other, without bringing out what they mean together, this presentation will likely look very similar to the dashboards you already produce for your client.</p>
<p>With that in mind, what is your customer‚Äôs incentive/motive/reason for attending your presentation? In other words, if your presentation shows the same graphs/indicators that your dashboards show, your client has no incentive/reason to watch your presentation. Because <strong>there is nothing in your presentation that is new</strong>, or any information that your client does not already have direct access to.</p>
</section>
<section id="sec-como-melhorar" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> How can we improve?</h1>
<p>Now that you have a sense of the size of the problem that the previous versions of these reports represented, over the next sections of this article, I will discuss some essential tips that demonstrate how we can improve the presentation model shown in Figure&nbsp;1.</p>
<p>In my understanding, a good part of the success in <strong>data storytelling</strong> can be summarized in two actions, or two main objectives:</p>
<ol type="1">
<li>Avoid items that distract our viewers‚Äô attention;</li>
<li>Build a captivating story for your presentation;</li>
</ol>
<p>The first item above is more related to the <strong>clarity and simplicity</strong> of the presentation, while the second item is more related to the <strong>content and structure</strong> of the presentation.</p>
<p>Let‚Äôs start with the first item‚Ä¶</p>
<section id="sec-guerra-atencao" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="sec-guerra-atencao"><span class="header-section-number">4.1</span> A constant war for attention</h2>
<p>When we‚Äôre presenting something, we‚Äôre constantly battling for our viewers attention. This is a hard battle, not only because we can (unintentionally) attract attention to the wrong places, but also, because there are so many sources of distraction in the modern world (e.g.&nbsp;cell phones, emails, etc.)!</p>
<p>A good <strong>data storytelling</strong> depends on telling a captivating story that manages to capture the attention of your viewers. Therefore, the next sections will focus a lot on tips that contribute to this capture, or that help you not to dissipate, reduce or disturb the attention of these spectators.</p>
<section id="sec-long-text" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="sec-long-text"><span class="header-section-number">4.1.1</span> Why you should avoid long text on your slides?</h3>
<p>Try to be parsimonious in your slides! That is, try to include as little information as possible within it. If you need to convey a lot of information on a single slide, then try to incorporate most of this content into your speech, and as little of it as possible in written form on this slide. In general, avoid including very long texts in your slides as much as possible.</p>
<p>It‚Äôs weird to think about, but generally, managers will jump in and watch your presentation because they‚Äôre interested in what <strong>you</strong> have to say about their business. Therefore, your slides are only support material, they must be secondary, a supporting element of your presentation. Because the main piece of the presentation should always be your speech and the story you want to tell through it.</p>
<p>See the slide at Figure&nbsp;2 as an example. The main problem with this slide is that it <strong>divides the viewer‚Äôs attention a lot</strong>.</p>
<div id="fig-texto-longo" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-texto-longo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/texto-longo-en.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-texto-longo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Slide with a long paragraph
</figcaption>
</figure>
</div>
<p>When presenting a slide, your viewers have to pay attention to your speech. That is, what you are verbally communicating during the presentation. And at the same time, they also need to pay attention to the slide content. However, that long paragraph in the left corner of the slide shown in Figure&nbsp;2 is problematic. <strong>Because he draws too much attention!</strong></p>
<p>The long paragraph element arouses our curiosity so much that, when you saw the above slide, you (the reader of this article) probably tried to read that long paragraph, even before reading what I am describing right now in this paragraph. The same will happen with the viewers of your presentation. Meaning your viewers will immediately try to read that long paragraph.</p>
<p>However, reading and interpreting a long text requires some effort and a lot of attention. As a result, while your viewers are trying to read that text, they won‚Äôt be able to pay attention to other elements of your presentation. For example, in your speech.</p>
<p>This can be crucial, as you may bring extra information, or an extremely important connection in your speech, and they may end up missing it while they are trying to read this text. Therefore, avoid as much as possible including very long texts in your slides.</p>
</section>
<section id="deliver-your-story-in-small-pieces" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="deliver-your-story-in-small-pieces"><span class="header-section-number">4.1.2</span> Deliver your story in small pieces</h3>
<p>The human brain can process a limited amount of information at once. As a result, if you try to explain a lot of information to your viewers, in a single slide, they will end up hitting that limit ü§Ø, and they simply won‚Äôt be able to reason, understand or assimilate what you‚Äôre explaining.</p>
<p>So <strong>deliver your story in small pieces</strong>. Avoid condensing a lot of information into a single slide! Divide the content into parts, and explain one part at a time!</p>
<p>This helps make the content simpler, and as a result, it helps your viewers better understand what you‚Äôre talking about.</p>
<p>Think about this for a while. When you‚Äôre looking to learn about a complex subject (e.g.&nbsp;linear regression), you‚Äôre likely to divide the content into many small pieces, and learn one piece at a time. Isn‚Äôt that how you do it? So bring that strategy into your presentations as well.</p>
</section>
</section>
<section id="sec-historia-conteudo" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="sec-historia-conteudo"><span class="header-section-number">4.2</span> Discussing stories and content</h2>
<p>Now that we‚Äôve seen two basic rules about keeping your viewers attention (i.e.&nbsp;avoid long texts and deliver your story at small pieces), let‚Äôs discuss some tips about the content of your presentation, and how to build stories with data.</p>
<section id="data-storytelling-is-not-about-choosing-the-best-chart" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="data-storytelling-is-not-about-choosing-the-best-chart"><span class="header-section-number">4.2.1</span> <em>Data Storytelling</em> is not about choosing ‚Äúthe best chart‚Äù</h3>
<p>A few analysts understand ‚Äú<em>data storytelling</em>‚Äù as a visualization problem, or, as the science of ‚Äúchoosing the best chart‚Äù for your presentation, or how to design innovative, beautiful, and complex graphic designs.</p>
<p>However, <em>data storytelling</em> is about <strong>telling stories with data</strong>. Not about building charts/graphics. Choosing the right visualization to present your data, making it better, prettier and cleaner is only part of the process. A very important part, as this will help you tell your story more clearly and effectively, and thus reach a larger audience.</p>
</section>
<section id="sec-relacoes" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="sec-relacoes"><span class="header-section-number">4.2.2</span> Trace relationships between indicators</h3>
<p>Now, let‚Äôs analyze the slide shown in Figure&nbsp;3. Notice that this slide, again, is very reminiscent of a dashboard page. The slide doesn‚Äôt look so captivating at first glance, as it only shows the indicators, it doesn‚Äôt build a relationship, or <strong>a story</strong>, between them.</p>
<div id="fig-divisao2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-divisao2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/divisao2-en.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-divisao2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Lack of relationship between indicators
</figcaption>
</figure>
</div>
<p>If we pay attention to these indicators, we can identify some effects that are happening along them. And if we think about these effects a little more, we will realize that these effects are relatable! And that together, they can tell a story.</p>
<p>For example, notice that there is a significant increase in sales. Both in the number of proposals sold and in the total value that these proposals generated. However, notice that this growth in sales did not occur in the ‚ÄúPayroll Loan‚Äù product, but in the ‚ÄúVehicle secured loan‚Äù product. In other words, the product ‚ÄúLoan Payroll‚Äù had a drop in sales at that month, however, the product ‚ÄúLoan with vehicle guarantee‚Äù obtained a big result that surpassed this drop by a lot, and in the end, managed to increase the bank sales as a whole.</p>
<p>In addition, we can also see other effects like the increases in both conversion rate and in the API (<em>Application Programming Interface</em>) success rate. These are also factors that contributed to the increase in sales. Because an increase in the conversion rate means that a larger portion of our customers are purchasing our products. And an increase in the success rate in the API means that we have fewer errors in the registration of sales on the platform, and this is obviously positive, as we have a smaller loss of sales due to crashes and errors in this registration system.</p>
<p>Note that all these relationships together help us to <strong>build a story</strong> about how sales increased at this specific month, and that‚Äôs exactly what we want to achieve. So always try to build relationships between your metrics to form a story about a key result that you perceived.</p>
</section>
<section id="sec-key-message" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="sec-key-message"><span class="header-section-number">4.2.3</span> Build your story around a key message</h3>
<p>Just to make this idea clear, when we identify the various effects that we described at Section&nbsp;4.2.2, on the slide shown in Figure&nbsp;3, it is interesting to ask ourselves: which of these various effects is the main result? In other words, which one of these effects is of most interest to the bank managers who are watching your presentation?</p>
<p>Certainly the increase in sales is the <strong>main effect</strong>. It is the <strong>key result</strong>. It‚Äôs the effect that most interests managers watching your presentation. So try to build your story around this result, or this main message. Use the other indicators to explain how this key result came about.</p>
<p>This is also very important! Every manager is very fond of hearing the word ‚Äúincrease in sales‚Äù. However, he is also always interested in knowing the <strong>‚Äúhow was this increase generated?‚Äù</strong>. That is, he needs to know what actions were taken that generated this positive impact.</p>
<p>Because by identifying these actions, this manager has the ability to apply these actions to other parts of his business, and, hopefully, he can end up spreading this positive effect that you described to other areas, and, as a result, he can end up further increasing the company‚Äôs sales.</p>
</section>
</section>
</section>
<section id="sec-pratica" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Putting some tips into practice</h1>
<p>So far, we‚Äôve discussed the following tips:</p>
<ol type="1">
<li>Avoid long texts on your slides;</li>
<li>Trace relationships between the indicators;</li>
<li>Build your story around a main message;</li>
<li>Deliver your story slowly, at small pieces;</li>
</ol>
<p>Let‚Äôs put these tips into practice, and redesign the slide shown in Figure&nbsp;3. Do you remember the relationships we described in Section&nbsp;4.2.2? Remember how these relationships tell a story about increased sales? Let‚Äôs take advantage of this story to apply the tips above.</p>
<p>First, we established that our story should always be built around a core message. So let‚Äôs start our presentation by focusing on a single slide that makes this main message clear.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/mensagem-principal-en.png" class="img-fluid figure-img"></p>
<figcaption>The main message of the presentation</figcaption>
</figure>
</div>
<p>Now that we know what the main subject of the presentation is, we can start to dig deeper, and describe that subject in more detail. As a next step, we can answer the question ‚Äúwhere did this increase in sales came from?‚Äù.</p>
<p>This question can be very relevant for your presentation, especially if: 1) you are presenting to several managers from different areas at the same time; 2) or also, if you are presenting to a manager higher in the hierarchy, who oversees several areas/products at the same time. Because in these cases, these managers will logically wonder where this increase in sales occurred. Was it in product x? Or was it in product y? Or area z? Etc.</p>
<p>Anyway, let‚Äôs answer this question on a new slide. With this slide, we make it clear to viewers that a new bank product (car loan with guarantee on vehicles) was the big star of the month, generating around $12 thousand in sales in the first month, even surpassing the sales value of the already consolidated product (payroll loan).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/onde-vendemos-en.png" class="img-fluid figure-img"></p>
<figcaption>Where did we sell more?</figcaption>
</figure>
</div>
<p>The next question we need to answer is ‚Äúhow?‚Äù. How was this super result in sales generated? We discussed this in Section&nbsp;4.2.3 that after discovering such an important result, managers will certainly be interested in understanding how this result was generated, so that they can spread this positive effect to other areas of the business.</p>
<p>Remember that we have two main effects discussed in Section&nbsp;4.2.2 that explain how this improvement in sales occurred. Let‚Äôs list them clearly and succintly on a new slide:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/porque-vendemos-en.png" class="img-fluid figure-img"></p>
<figcaption>Why did we sell more?</figcaption>
</figure>
</div>
<p>Please, try to use your speech to elaborate the two effects above (‚ÄúWhat was the problem with the API, and how did we overcome it?‚Äù, ‚ÄúHow is this an improvement?‚Äù, ‚ÄúWhat is a conversion rate? And how does it affect the process of sale?‚Äù). Remember, try to avoid putting long texts in your presentations as much as possible, and try to give more details or answer your viewers questions through speech.</p>
<p>With these three slides we have a much more interesting structure and content for our presentation as we are telling a story about how we sold more in a given month.</p>
<p>Note that the structure of the presentation (1: main message, 2: where? , 3: how?) helps us to cohesively create the content and this story. In the next sections of this article, I‚Äôll discuss two other frameworks that can help you structure and cohesively tell your stories.</p>
</section>
<section id="sec-historias-tem-estrutura" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Stories have structure, use these structures to your advantage</h1>
<p>Over the next sections, I‚Äôll show you two examples of structures that are quite common in stories. These structures serve as a guide as you build your story. They will help you a lot to organize your ideas in a clear and effective format.</p>
<section id="the-four-cs-model" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="the-four-cs-model"><span class="header-section-number">6.1</span> The four C‚Äôs model</h2>
<p>The four C‚Äôs model refers to these four words in Portuguese:</p>
<blockquote class="blockquote">
<p>Contexto, Conflito, Consequ√™ncia, Conselho.</p>
</blockquote>
<p>These four words can be translated into <em>Context, Conflict, Consequence, Advice</em>, and they help you bring a consistent structure to your story. In addition, these words also help you to stir up your viewers‚Äô emotions a little, and, with that, capture their attention more.</p>
<p>By following this model, your story will always break down into four parts: context, conflict, consequence, and advice. Precisely in this order. This framework revolves around a major problem or conflict that you have identified in your client‚Äôs business.</p>
<p>The interesting thing about this structure is that you can stake several problems in sequence. As a result, you have a block of 4 C‚Äôs (context, conflict, consequence and advice), followed by another block with 4 more C‚Äôs (context, conflict, consequence and advice). Or, you can start the presentation with a context, and then two blocks of 3 C‚Äôs (conflict, consequence and advice) in sequence.</p>
<p>Anyway, enough talking, and let‚Äôs describe in more detail each one of these four parts of this structure.</p>
<section id="start-with-a-context" class="level3" data-number="6.1.1">
<h3 data-number="6.1.1" class="anchored" data-anchor-id="start-with-a-context"><span class="header-section-number">6.1.1</span> Start with a context</h3>
<p>Therefore, when following this model, your story will always start with a context. Something just to contextualize the viewer on what the current state of the business is.</p>
<p>Remember, the 4 C‚Äôs model is built around a conflict, or a core problem. Bearing this in mind, if, for example, the conflict that you are going to discuss in your story is a problem that affects the service for selling card machines, it is important that you focus on giving an <em>overview</em> about the service for selling card machines.</p>
<p>In other words, avoid bringing contexts in this part that are not related to the problem/conflict that you will talk in the next section. Because this conflict is the central part of the story.</p>
</section>
<section id="present-a-conflictproblemchallenge-to-be-overcome" class="level3" data-number="6.1.2">
<h3 data-number="6.1.2" class="anchored" data-anchor-id="present-a-conflictproblemchallenge-to-be-overcome"><span class="header-section-number">6.1.2</span> Present a conflict/problem/challenge to be overcome</h3>
<p>Then you must show a conflict. That is, a problem, challenge or barrier that you have identified in the product/service you are looking at. This is where we‚Äôre going to play with the viewer‚Äôs emotions a bit, and use that to our advantage to capture their attention.</p>
<p>Let‚Äôs reflect on this a little. By putting words like ‚Äúproblem‚Äù, ‚Äúcare‚Äù, ‚Äúchallenge‚Äù, ‚Äúalert‚Äù, especially in bold letters, in addition to including emojis that convey this purpose, such as ‚ö†Ô∏è and ‚õî. This quickly draws anyone‚Äôs attention, as it gives you a sense of danger, and you enter a state of alert.</p>
<p>If you think about it a little more, you‚Äôll probably realize that you have that same instinct when you‚Äôre watching a movie, or a series, and the hero of that story suddenly gets into a dangerous situation. You quickly pay more attention to what is happening, because you want to see how the hero is going to get out of this hole, or you are really rooting for him to survive and overcome this problem.</p>
<p>When we present an issue about the product/service you are reviewing, we want to cause the same effect on our viewers. When we say that we have a challenge/problem that is affecting the company‚Äôs sales, managers quickly start to pay more attention to what you are saying, as they want to know how they can get out of this hole!</p>
</section>
<section id="hiding-the-problems-is-a-bad-idea" class="level3" data-number="6.1.3">
<h3 data-number="6.1.3" class="anchored" data-anchor-id="hiding-the-problems-is-a-bad-idea"><span class="header-section-number">6.1.3</span> Hiding the problems is a bad idea</h3>
<p>This is very important! Some analysts are afraid or apprehensive of shedding light on existing problems, and therefore, end up hiding them or omitting them from their presentations. However, you are not delivering any value to your customer that way! You are not helping your customer to solve their problems and to grow their business!</p>
<p>And if the problems are not solved, if they continue to exist, they will grow, and grow, until they explode, thus generating generalized chaos. The sooner you identify the problem, notify managers about it, and present possible solutions for it, the better for managers, who already leave with an action plan to solve this problem, and it is better for you too, because you are delivering value and solutions to your customer.</p>
<p>Therefore, a good presentation, or a good data report, is one that delivers value to your customer! By showing new business opportunities (e.g.&nbsp;reaching a new portion of the public with a product), and also by presenting solutions to current problems that are limiting or preventing business growth.</p>
<p>However, a presentation that only comments on positive points, that says that everything is fine‚Ä¶ does not bring any value to managers. Managers didn‚Äôt hire you to tell you everything is fine. They hired you to help them discover and solve problems in their business through data analysis.</p>
</section>
<section id="present-the-consequences-of-the-conflictproblemchallenge-you-have-identified" class="level3" data-number="6.1.4">
<h3 data-number="6.1.4" class="anchored" data-anchor-id="present-the-consequences-of-the-conflictproblemchallenge-you-have-identified"><span class="header-section-number">6.1.4</span> Present the consequences of the conflict/problem/challenge you have identified</h3>
<p>Therefore, after presenting a conflict/problem/challenge that is affecting the business, it is important that you present the consequence of this problem right away. This helps managers to have a dimension of the size that this problem represents for their business.</p>
<p>It‚Äôs okay if you can‚Äôt measure in numbers the size of the impact that this conflict had on the business. Try to measure that impact as best you can. An approximate value of the impact can already bring enough clarity about the size of the danger that this conflict represents for the business.</p>
<p>You can also provide a <em>range</em>, or a possible range of the impact if you can (e.g.&nbsp;the estimated impact is between $20 thousand and $340 thousand). This is also a valid way of exposing the size of the problem.</p>
<p>If it is really impossible to measure this impact in numbers, then explain in this part, which are the points of the product/service sales process that are affected by this problem. In other words, present which are the places in the business that are being, in theory, affected by this conflict.</p>
</section>
<section id="advise-your-customer-present-possible-solutions-to-the-problem" class="level3" data-number="6.1.5">
<h3 data-number="6.1.5" class="anchored" data-anchor-id="advise-your-customer-present-possible-solutions-to-the-problem"><span class="header-section-number">6.1.5</span> Advise your customer, present possible solutions to the problem</h3>
<p>Okay, we present a problem, or a conflict for our viewers. We also discussed the impacts of this conflict on our client‚Äôs business. Now, we need to present possible solutions to this problem.</p>
<p>Therefore, understand the problem/conflict you are presenting, and try to list what would be the main solutions for this problem, and include these solutions in this part of your presentation. It‚Äôs worth explaining and discussing this issue with other co-workers as well, as they might also come up with interesting solutions that were off your radar.</p>
<p>It is also interesting to include a list of <em>trade-offs</em> for each solution, especially in terms of complexity and effort for each solution. Managers are constantly interested in this relationship, and always want to choose the solution that is simpler and faster to implement.</p>
</section>
</section>
<section id="character-evolution-as-another-alternative" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="character-evolution-as-another-alternative"><span class="header-section-number">6.2</span> Character evolution as another alternative</h2>
<p>Character evolution (or the ‚Äúhero‚Äôs journey‚Äù) is a popular story structure. You start with a character, or a hero for the story, which in our case here, could be our client‚Äôs business, or a specific product of this business.</p>
<p>Our mission is to show how this character/hero has evolved in recent months. Therefore, this evolution structure is very suitable for year-end reports. Because these reports are interesting to show the evolution of the business (or the evolution of the character) over the last year.</p>
<section id="the-beginning-and-end-of-the-journey" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="the-beginning-and-end-of-the-journey"><span class="header-section-number">6.2.1</span> The beginning and end of the journey</h3>
<p>If you prefer, you can start your presentation by showing how your character was at the beginning of the journey, and end this presentation by showing how that character ended that journey.</p>
<p>This is an option, however, I prefer to start the presentation by showing the start and end at the same time. In this way, viewers begin the presentation with an idea of how much the business has evolved during the year. Therefore, I start by showing how the character (or the business/product) started the year, and then how he ended the year.</p>
</section>
<section id="presenting-the-challenges-and-pitfalls" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="presenting-the-challenges-and-pitfalls"><span class="header-section-number">6.2.2</span> Presenting the challenges and pitfalls</h3>
<p>In every business/product, whatever it may be, we always face major challenges that can threaten the success, or limit the evolution of this business/product.</p>
<p>Therefore, along any journey, we always face challenges and setbacks, and we apply actions to try to overcome these challenges. By overcoming these challenges, we can hopefully generate the evolution and improvement of this business/product. That is, reaching the end of this journey with a better, more robust and more profitable business/product.</p>
<p>All of this means that ‚Äúhow we get through the middle of the journey‚Äù can be much more important/interesting than the beginning or end of that journey. Therefore, reserve a part of your presentation to present the main challenges we faced during this journey, and how we overcame them.</p>
</section>
<section id="if-possible-take-the-opportunity-to-value-your-teams-work" class="level3" data-number="6.2.3">
<h3 data-number="6.2.3" class="anchored" data-anchor-id="if-possible-take-the-opportunity-to-value-your-teams-work"><span class="header-section-number">6.2.3</span> If possible, take the opportunity to value your team‚Äôs work</h3>
<p>At this particular point in the presentation, you usually have a very interesting opportunity! Because you can deliver value to your customer and, at the same time, also value the work of your team, especially if this was the team that discovered the challenges, and applied the actions that overcame the challenges you are describing.</p>
<p>This is a golden opportunity! Therefore, if you have this opportunity in your hands, take advantage of it! Remember that you don‚Äôt work alone. You‚Äôre almost always working within a team of people, and it‚Äôs always important to know how to value your colleagues‚Äô work.</p>
<p>However, this opportunity will not always appear for you. Perhaps the challenges you are presenting were overcome in another way, by another team that you do not know, or that you do not have a direct connection with.</p>
</section>
<section id="reinforce-the-results-achieved" class="level3" data-number="6.2.4">
<h3 data-number="6.2.4" class="anchored" data-anchor-id="reinforce-the-results-achieved"><span class="header-section-number">6.2.4</span> Reinforce the results achieved</h3>
<p>It is also useful to end your presentation by showing a summary of the results achieved during the year. This could be a simple <em>bulletpoint</em> summarizing the main results. This helps to jog your viewers‚Äô memory, showing them not only how we ended last year‚Äôs journey, but also, how we begin next year‚Äôs journey üòâ.</p>
</section>
<section id="a-summary-of-the-structure" class="level3" data-number="6.2.5">
<h3 data-number="6.2.5" class="anchored" data-anchor-id="a-summary-of-the-structure"><span class="header-section-number">6.2.5</span> A summary of the structure</h3>
<p>Therefore, over the previous sections we discussed an idea of structure that would be similar to a ‚Äúcharacter evolution‚Äù. In the end, we have a story that follows the sequence below:</p>
<ul>
<li>quickly present how we started and how we ended the journey;</li>
<li>present the main challenges we faced during the year;</li>
<li>what were the solutions we applied to solve the problems;</li>
<li>reinforce the evolution of the character, by showing again the results achieved with the solutions above;</li>
</ul>


</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>It is worth remembering that the numbers and graphs presented in this image are merely illustrative, and were defined in a completely random way.‚Ü©Ô∏é</p></li>
</ol>
</section></div> ]]></description>
  <category>Storytelling</category>
  <category>Data Storytelling</category>
  <category>Data Science</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/en/</guid>
  <pubDate>Mon, 22 May 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/mapa-featured.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Um estudo de caso sobre Data Storytelling em alguns dos maiores bancos brasileiros</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/pt/</link>
  <description><![CDATA[ 





<section id="introdu√ß√£o" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introdu√ß√£o</h1>
<p>Este artigo discute como eu melhorei o meu processo de <em>Data Storytelling</em> dentro das minhas apresenta√ß√µes e relat√≥rios entregues para dois dos maiores bancos comerciais do mercado brasileiro. Busco compartilhar o que aprendi nesse processo, e dou algumas dicas que possivelmente v√£o ajud√°-lo a construir relat√≥rios de dados mais intuitivos, cativantes, claros e efetivos.</p>
<p>Em resumo, vamos discutir neste artigo as seguintes dicas:</p>
<ul>
<li><em>Data Storytelling</em> √© sobre contar hist√≥rias atrav√©s de dados;</li>
<li>Hist√≥rias tem estrutura, use essas estruturas ao seu favor;</li>
<li>Evite dividir muito a aten√ß√£o com textos longos em seus slides;</li>
<li>Trace rela√ß√µes entre os seus dados;</li>
<li>Construa sua hist√≥ria em torno de uma mensagem principal;</li>
<li>Entregue sua hist√≥ria aos poucos;</li>
</ul>
<p>A maior parte desses conhecimentos foram constru√≠dos atrav√©s de intensa pesquisa, reflex√£o e planejamento sobre as minhas apresenta√ß√µes, e, posteriormente, adquirindo feedbacks, e realizando pequenos ajustes aqui e ali.</p>
<p>Como voc√™ pode esperar de todo grande trabalho como este, ele tamb√©m envolveu outras pessoas. Durante esse processo, eu recebi ajuda e feedbacks de meus colegas de trabalho, <a href="https://www.linkedin.com/in/andressa-de-souza-freitas-697195177/">Andressa de Souza Freitas</a> e <a href="https://www.linkedin.com/in/guilhermeggarcia/">Guilherme Gomes</a>. Eu tamb√©m tive uma grande ajuda da UX Designer <a href="https://www.linkedin.com/in/alefernandesbranding/">Al√™ Fernandes</a>. V√°rios dos conhecimentos apresentados aqui, eu aprendi na pr√°tica com a Al√™. Esses conhecimentos revolucionaram a maneira como eu construo minhas apresenta√ß√µes, e, por isso, eu sou imensamente grato a ela ‚ù§Ô∏è.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Todos os dados, gr√°ficos e imagens mostrados neste artigo s√£o meramente ilustrativos. Todos os n√∫meros apresentados foram gerados de forma aleat√≥ria por um computador! Portanto, eles n√£o representam os dados reais de TakeBlip ou dos bancos comerciais brasileiros envolvidos de nenhuma forma ou dimens√£o!</p>
</div>
</div>
</section>
<section id="resumo-da-estrutura-deste-artigo" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Resumo da estrutura deste artigo</h1>
<p>Na Se√ß√£o&nbsp;3, eu forne√ßo contexto sobre esses relat√≥rios que eu apresentava para dois dos maiores bancos comerciais brasileiros, qual era o formato desses relat√≥rios e quais eram os seus principais problemas e limita√ß√µes.</p>
<p>Mas a partir da Se√ß√£o&nbsp;4, n√≥s come√ßamos a discutir sobre como melhorei esses relat√≥rios. Voc√™ vai perceber que boa parte dessas melhorias est√£o concentradas em dois pontos:</p>
<ol type="1">
<li>construir uma apresenta√ß√£o que seja simples e clara;</li>
<li>construir uma apresenta√ß√£o que tenha uma boa estrutura, isto √©, uma estrutura que te ajude a contar uma hist√≥ria atrav√©s de seus dados;</li>
</ol>
<p>A Se√ß√£o&nbsp;4.1 fornece duas dicas que te ajudam a trazer simplicidade e clareza para sua apresenta√ß√£o, al√©m de discutir o porqu√™ de textos longos em slides serem t√£o perversos para a aten√ß√£o de seus espectadores.</p>
<p>Na Se√ß√£o&nbsp;4.2 discuto algumas dicas sobre como formar o conte√∫do da apresenta√ß√£o, mais especificamente, um conte√∫do que te ajude a construir uma hist√≥ria em sua apresenta√ß√£o.</p>
<p>J√° na Se√ß√£o&nbsp;5, n√≥s pegamos as dicas que discutimos at√© ent√£o no artigo, e tentamos aplicar elas sobre o slide mostrado em Figura&nbsp;3, com o objetivo de demonstrar como essas dicas podem melhorar sua apresenta√ß√£o.</p>
<p>Por √∫ltimo, na Se√ß√£o&nbsp;6, n√≥s discutimos bastante sobre estrutura. Mais especificamente, eu discuto dois exemplos de estruturas que podem servir como um guia, ao fornecer uma base simples que voc√™ pode utilizar para construir a sua hist√≥ria.</p>
<p>Enfim, vamos prosseguir‚Ä¶</p>
</section>
<section id="sec-como-era-antes" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Como era esse relat√≥rio antes ?</h1>
<p>Na √©poca, est√°vamos construindo um relat√≥rio mensal contendo v√°rios indicadores e gr√°ficos que mostravam o estado atual e a evolu√ß√£o recente dos servi√ßos e produtos dos bancos ofertados dentro do canal do WhatsApp.</p>
<p>Contudo, o formato dessa apresenta√ß√£o era problem√°tico. N√≥s traz√≠amos uma <strong>quantidade monumental</strong> de informa√ß√µes para o banco. A apresenta√ß√£o usualmente trazia em torno de 40 slides diferentes, com aproximadamente 36 gr√°ficos e 70 indicadores diferentes. Para mais, n√≥s tent√°vamos apresentar todo esse volume de informa√ß√µes em uma reuni√£o de apenas 1 hora.</p>
<p>O resultado final disso tudo era uma apresenta√ß√£o que trazia um volume monumental de informa√ß√µes, por√©m, que tamb√©m trazia um <strong>volume muito pequeno de insights e novas ideias de neg√≥cio para os gestores</strong>.</p>
<p>Em Figura&nbsp;1 temos uma representa√ß√£o de um dos v√°rios slides dessa apresenta√ß√£o<sup>1</sup>. Imagine que essa apresenta√ß√£o trazia em torno de 40 slides semelhantes a esse:</p>
<div id="fig-print-report1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-print-report1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/print-report1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-print-report1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;1: Representa√ß√£o de um slide da vers√£o antiga do relat√≥rio
</figcaption>
</figure>
</div>
<p>Perceba que esse slide se parece mais com uma p√°gina de um dashboard, do que de um relat√≥rio apresentando as √∫ltimas tend√™ncias do mercado ou do neg√≥cio do banco.</p>
<p><strong>Isso √© muito importante!</strong> Se a sua apresenta√ß√£o traz v√°rios indicadores diferentes espalhados pela p√°gina, sem contextualiz√°-los, sem relacion√°-los uns com os outros, sem trazer o que eles significam em conjunto, essa apresenta√ß√£o vai muito provavelmente se parecer com os dashboards que voc√™ j√° produz para o seu cliente.</p>
<p>Tendo isso em mente, qual √© o incentivo/motivo/raz√£o que o seu cliente tem para assistir √† sua apresenta√ß√£o? Em outras palavras, se a sua apresenta√ß√£o mostra os mesmos gr√°ficos/indicadores que os seus dashboards apresentam, o seu cliente n√£o tem incentivo/motivo nenhum para assistir √† sua apresenta√ß√£o. Pois <strong>n√£o h√° nada na sua apresenta√ß√£o que seja novo</strong>, ou nenhuma informa√ß√£o da qual o seu cliente n√£o tenha j√° acesso diretamente.</p>
</section>
<section id="sec-como-melhorar" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Como podemos melhorar ?</h1>
<p>Agora que voc√™ possui uma no√ß√£o do tamanho do problema que as vers√µes anteriores desses relat√≥rios representavam, nas pr√≥ximas se√ß√µes deste artigo, vou discutir algumas dicas essenciais que demonstram como n√≥s podemos melhorar o modelo de apresenta√ß√£o mostrado em Figura&nbsp;1.</p>
<p>No meu entendimento, boa parte do sucesso em <strong>data storytelling</strong> pode ser resumido em duas a√ß√µes, ou dois objetivos principais:</p>
<ol type="1">
<li>Evitar itens que dispersam a aten√ß√£o dos nossos espectadores;</li>
<li>Construir uma hist√≥ria cativante para a nossa apresenta√ß√£o;</li>
</ol>
<p>O primeiro item acima est√° mais relacionado √† <strong>clareza e simplicidade</strong> da apresenta√ß√£o, enquanto o segundo item est√° mais relacionado ao <strong>conte√∫do e estrutura</strong> da apresenta√ß√£o.</p>
<p>Vamos come√ßar pelo primeiro item‚Ä¶</p>
<section id="sec-guerra-atencao" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="sec-guerra-atencao"><span class="header-section-number">4.1</span> Uma guerra constante pela aten√ß√£o</h2>
<p>Quando estamos apresentando algo, estamos constantemente batalhando pela aten√ß√£o dos nossos espectadores. Essa √© uma batalha dif√≠cil, n√£o apenas porque n√≥s podemos (sem querer) atrair a aten√ß√£o para os lugares errados, mas tamb√©m porque existem muitas fontes de distra√ß√£o no mundo moderno (e.g.&nbsp;celulares, emails, etc.)!</p>
<p>Um bom <strong>data storytelling</strong> depende de voc√™ contar uma hist√≥ria cativante, que consiga capturar a aten√ß√£o de seus espectadores. Por isso, as pr√≥ximas se√ß√µes v√£o focar bastante em dicas que contribuam para essa captura, ou que te ajudam a n√£o dissipar, reduzir ou atrapalhar a aten√ß√£o desses espectadores.</p>
<section id="sec-texto-longo" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="sec-texto-longo"><span class="header-section-number">4.1.1</span> Por que evitar textos longos em seus slides?</h3>
<p>Tente ser parsimonioso nos seus slides! Isto √©, tente incluir o m√≠nimo poss√≠vel de informa√ß√£o dentro dele. Se voc√™ precisa repassar v√°rias informa√ß√µes em um slide, tente incorporar o m√°ximo poss√≠vel desse conte√∫do em sua fala, e o m√≠nino poss√≠vel dele em forma escrita neste slide. Em geral, evite ao m√°ximo incluir textos muito longos em seus slides.</p>
<p>√â estranho pensar nisso, mas geralmente, os gestores v√£o participar e assistir √† sua apresenta√ß√£o porque eles est√£o interessados no que <strong>voc√™</strong> tem a dizer sobre o neg√≥cio deles. Portanto, os seus slides s√£o apenas um material de suporte, eles devem ser secund√°rios, um coadjuvante de sua apresenta√ß√£o. Pois a pe√ßa principal da apresenta√ß√£o deve ser sempre a sua fala e a hist√≥ria que voc√™ quer contar atrav√©s dela.</p>
<p>Veja o slide em Figura&nbsp;2 como exemplo. O problema principal desse slide, √© que ele <strong>divide muito a aten√ß√£o de seu espectador</strong>.</p>
<div id="fig-texto-longo" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-texto-longo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/texto-longo.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-texto-longo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;2: Slide com um par√°grafo longo
</figcaption>
</figure>
</div>
<p>Ao apresentar um slide, os seus espectadores tem que prestar aten√ß√£o na sua fala. Isto √©, no que voc√™ est√° comunicando verbalmente durante a apresenta√ß√£o. E ao mesmo tempo, eles tamb√©m precisam prestar aten√ß√£o no conte√∫do do slide. Contudo, esse longo par√°grafo no canto esquerdo do slide mostrado em Figura&nbsp;2 √© problem√°tico. <strong>Pois ele chama aten√ß√£o demais!</strong></p>
<p>Esse elemento desperta tanto a nossa curiosidade, que ao ver esse slide, voc√™ (leitor deste artigo) provavelmente tentou ler esse texto longo antes mesmo de ler o que estou descrevendo agora neste par√°grafo. O mesmo vai acontecer com os espectadores de sua apresenta√ß√£o. Ou seja, os seus espectadores v√£o imediatamente tentar ler esse par√°grafo longo.</p>
<p>Contudo, ler e interpretar um texto longo, exige certo esfor√ßo e muita aten√ß√£o. Como resultado, enquanto os seus espectadores le√™m esse texto, eles n√£o v√£o conseguir prestar aten√ß√£o em outros elementos de sua apresenta√ß√£o. Por exemplo, na sua fala.</p>
<p>Isso pode ser crucial, pois talvez voc√™ traga uma informa√ß√£o a mais, ou uma conex√£o extremamente importante na sua fala, e eles podem acabar perdendo isso enquanto est√£o tentando ler esse texto. Portanto, evite ao m√°ximo incluir textos muito longos em seus slides.</p>
</section>
<section id="entregue-sua-hist√≥ria-aos-poucos" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="entregue-sua-hist√≥ria-aos-poucos"><span class="header-section-number">4.1.2</span> Entregue sua hist√≥ria aos poucos</h3>
<p>O c√©rebro humano consegue processar uma quantidade limitada de informa√ß√µes de uma vez s√≥. Como resultado, se voc√™ tentar explicar v√°rias informa√ß√µes para os seus espectadores, em um √∫nico slide, eles v√£o acabar atingindo esse limite ü§Ø, e simplesmente n√£o v√£o conseguir raciocinar, compreender ou assimilar o que voc√™ est√° explicando.</p>
<p>Portanto, <strong>entregue a sua hist√≥ria aos poucos</strong>. Evite condensar v√°rias informa√ß√µes em um √∫nico slide! Divida o conte√∫do em partes, e explique uma parte de cada vez!</p>
<p>Isso ajuda a tornar o conte√∫do mais simples, e, como resultado, isso ajuda os seus espectadores a entenderem melhor sobre o que voc√™ est√° falando.</p>
<p>Pense um pouco sobre isso. Quando voc√™ busca aprender sobre um assunto complexo (e.g.&nbsp;regress√£o linear), voc√™ provavelmente divide o conte√∫do em v√°rias partes pequenas, e, vai aprendendo uma parte de cada vez. N√£o √© assim que voc√™ faz? Ent√£o traga essa experi√™ncia tamb√©m para as suas apresenta√ß√µes.</p>
</section>
</section>
<section id="sec-historia-conteudo" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="sec-historia-conteudo"><span class="header-section-number">4.2</span> Discutindo hist√≥rias e conte√∫do</h2>
<p>Agora que vimos duas regras b√°sicas sobre a aten√ß√£o de seus espectadores (i.e.&nbsp;evite textos longos e entregue sua hist√≥ria aos poucos), vamos discutir algumas dicas sobre o conte√∫do de sua apresenta√ß√£o, e, sobre como construir hist√≥rias com dados.</p>
<section id="data-storytelling-n√£o-√©-sobre-escolher-o-melhor-gr√°fico" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="data-storytelling-n√£o-√©-sobre-escolher-o-melhor-gr√°fico"><span class="header-section-number">4.2.1</span> <em>Data Storytelling</em> n√£o √© sobre escolher ‚Äúo melhor gr√°fico‚Äù</h3>
<p>Alguns poucos analistas entendem ‚Äú<em>data storytelling</em>‚Äù como um problema de visualiza√ß√£o, ou, como a ci√™ncia de ‚Äúescolher os melhores gr√°ficos‚Äù para sua apresenta√ß√£o, ou como projetar gr√°ficos inovadores, bonitos e complexos.</p>
<p>Contudo, <em>data storytelling</em> √© sobre <strong>contar hist√≥rias com dados</strong>. N√£o sobre como construir visualiza√ß√µes. Escolher a visualiza√ß√£o certa para apresentar os seus dados, torn√°-la melhor, mais bonita e mais limpa, √© apenas uma parte do processo. Uma parte muito importante, pois isso vai te ajudar a contar sua hist√≥ria de uma maneira mais clara e eficaz, e, com isso, atingir um p√∫blico maior.</p>
</section>
<section id="sec-relacoes" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="sec-relacoes"><span class="header-section-number">4.2.2</span> Trace rela√ß√µes entre os indicadores</h3>
<p>Agora, vamos analisar o slide mostrado em Figura&nbsp;3. Perceba que esse slide, novamente, lembra muito uma p√°gina de um dashboard. O slide n√£o parece t√£o cativante √† primeira vista, pois ele s√≥ mostra os indicadores, ele n√£o constr√≥i uma rela√ß√£o, ou <strong>uma hist√≥ria</strong> entre eles.</p>
<div id="fig-divisao2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-divisao2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/divisao2.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-divisao2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;3: Falta de rela√ß√£o entre os indicadores
</figcaption>
</figure>
</div>
<p>Se prestarmos aten√ß√£o nesses indicadores, podemos identificar alguns efeitos que est√£o acontecendo ao longo deles. E se refletirmos um pouco mais sobre esses efeitos, vamos perceber que esses efeitos s√£o relacion√°veis! E que em conjunto, eles podem contar uma hist√≥ria.</p>
<p>Por exemplo, perceba que h√° um aumento significativo nas vendas. Tanto no n√∫mero de propostas vendidas quanto no valor total em si que essas propostas geraram. Por√©m, perceba que esse crescimento nas vendas n√£o ocorreu no produto ‚ÄúEmpr√©stimo Consignado‚Äù, e sim, no produto ‚ÄúEmpr√©stimo com garantia de ve√≠culos‚Äù. Ou seja, o produto ‚ÄúEmpr√©stimo Consignado‚Äù teve uma queda de vendas nesse m√™s, por√©m, o produto ‚ÄúEmpr√©stimo com garantia de ve√≠culos‚Äù obteve um super resultado que conseguiu cobrir e muito essa queda, e no fim, conseguiu aumentar as vendas como um todo do banco.</p>
<p>Al√©m disso, outros efeitos que podemos perceber s√£o os aumentos na taxa de convers√£o e na taxa de sucesso de API. Esses tamb√©m s√£o fatores que contribu√≠ram para o aumento nas vendas. Pois um aumento na taxa de convers√£o significa que uma parcela maior dos nossos clientes est√° adquirindo os nossos produtos. J√° um aumento na taxa de sucesso na API, significa que temos menos erros nos registros das vendas na plataforma, e isso √© obviamente positivo, pois n√≥s temos uma perda de vendas menor por causa de travamentos e erros nesse sistema de registro.</p>
<p>Perceba que todas essas rela√ß√µes nos ajudam a <strong>construir uma hist√≥ria</strong> sobre como as vendas aumentaram nesse m√™s, e √© justamente isso que queremos atingir. Portanto, tente sempre construir rela√ß√µes entre os seus indicadores, de modo a formar uma hist√≥ria sobre um resultado principal.</p>
</section>
<section id="sec-mensagem-principal" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="sec-mensagem-principal"><span class="header-section-number">4.2.3</span> Construa sua hist√≥ria em torno de uma mensagem principal</h3>
<p>Apenas para deixar claro essa ideia, ao identificar os v√°rios efeitos que descrevemos em Se√ß√£o&nbsp;4.2.2, sobre o slide mostrado em Figura&nbsp;3, √© interessante nos questionarmos: qual desses v√°rios efeitos √© o principal resultado? Em outras palavras, qual desses efeitos √© o que mais interessa os gerentes do banco que est√£o assistindo √† sua apresenta√ß√£o?</p>
<p>Certamente o aumento sobre as vendas √© o <strong>efeito principal</strong>. √â o efeito que mais interessa os gerentes que est√£o assistindo √† sua apresenta√ß√£o. Portanto, tente construir a sua hist√≥ria em torno desse resultado, ou dessa mensagem principal. Use os outros indicadores para explicar como esse resultado principal aconteceu.</p>
<p>Isso tamb√©m √© muito importante! Todo gerente gosta muito de ouvir a palavra ‚Äúaumento nas vendas‚Äù. Por√©m, ele tamb√©m est√° sempre interessado em saber o <strong>‚Äúcomo esse aumento foi gerado?‚Äù</strong>. Ou seja, ele precisa saber quais foram as a√ß√µes realizadas que geraram esse impacto positivo.</p>
<p>Pois ao identificar essas a√ß√µes, esse gerente tem a capacidade de aplicar essas a√ß√µes em outras partes de seu neg√≥cio, e, com certa esperan√ßa, ele pode acabar disseminando esse efeito positivo que voc√™ descreveu para outras √°reas, e, como resultado, ele pode acabar aumentando ainda mais as vendas da empresa.</p>
</section>
</section>
</section>
<section id="sec-pratica" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Colocando algumas dicas em pr√°tica</h1>
<p>At√© aqui, n√≥s discutimos as seguintes dicas:</p>
<ol type="1">
<li>Evite textos longos em seus slides;</li>
<li>Trace rela√ß√µes entre os indicadores;</li>
<li>Construa sua hist√≥ria em torno de uma mensagem principal;</li>
<li>Entregue sua hist√≥ria aos poucos;</li>
</ol>
<p>Vamos botar essas dicas em pr√°tica, e reformular o slide mostrado em Figura&nbsp;3. Voc√™ lembra das rela√ß√µes que descrevemos em Se√ß√£o&nbsp;4.2.2? Lembra que essas rela√ß√µes tra√ßam uma hist√≥ria sobre o aumento de vendas? Vamos aproveitar essa hist√≥ria para aplicarmos as dicas acima.</p>
<p>Primeiro, estabelecemos que nossa hist√≥ria deve sempre ser constru√≠da em torno de uma mensagem principal. Portanto, vamos come√ßar a nossa apresenta√ß√£o nos concentrando em um √∫nico slide que mostra essa mensagem principal de forma clara.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/mensagem-principal.png" class="img-fluid figure-img"></p>
<figcaption>A mensagem principal da apresenta√ß√£o</figcaption>
</figure>
</div>
<p>Agora que sabemos qual √© o assunto principal da apresenta√ß√£o, podemos come√ßar a cavar mais fundo, e descrever esse assunto em mais detalhes. Como um pr√≥ximo passo, podemos responder √† pergunta ‚Äúonde esse aumento de vendas ocorreu?‚Äù.</p>
<p>Essa pergunta pode ser bastante relevante para sua apresenta√ß√£o, especialmente se: 1) voc√™ est√° apresentando para v√°rios gerentes de diferentes √°reas ao mesmo tempo; 2) ou tamb√©m, se voc√™ estiver apresentando para um gerente mais alto na hierarquia, que supervisiona v√°rias √°reas/produtos ao mesmo tempo. Pois nestes casos, esses gerentes v√£o logicamente se perguntar onde esse aumento de vendas ocorreu. Ser√° que foi no produto x? Ou foi no produto y? Etc.</p>
<p>Enfim, vamos responder essa pergunta em um novo slide. Com esse slide, deixamos claro para os espectadores, que um novo produto do banco (empr√©stimo com garantia sobre ve√≠culos) foi a grande estrela do m√™s, ao gerar R$ 12 Mil em vendas logo no primeiro m√™s, superando inclusive o valor de vendas do produto j√° consolidado (empr√©stimo consignado).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/onde-vendemos.png" class="img-fluid figure-img"></p>
<figcaption>Onde vendemos mais?</figcaption>
</figure>
</div>
<p>A pr√≥xima pergunta que precisamos responder √© ‚Äúcomo?‚Äù. Como esse super resultado nas vendas foi gerado? N√≥s discutimos isso na Se√ß√£o&nbsp;4.2.3, que ap√≥s descobrirem um resultado t√£o importante, os gerentes v√£o certamente estar interessados em entender como esse resultado foi gerado, para que eles possam difundir esse efeito positivo para outras √°reas do neg√≥cio.</p>
<p>Lembre-se que temos dois efeitos principais discutidos em Se√ß√£o&nbsp;4.2.2 que explicam como essa melhoria nas vendas ocorreu. Vamos list√°-los de maneira clara e curta em um novo slide:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/porque-vendemos.png" class="img-fluid figure-img"></p>
<figcaption>Por que vendemos mais?</figcaption>
</figure>
</div>
<p>Deixe os detalhes mais espec√≠ficos dos dois efeitos acima (‚Äúqual era o problema na API, e como superamos ele?‚Äù, ‚Äúcomo isso √© uma melhoria?‚Äù, ‚Äúo que √© uma taxa de convers√£o? E como isso afeta o processo de venda?‚Äù) para a sua fala. Lembre-se, tente evitar ao m√°ximo colocar textos longos em suas apresenta√ß√µes, e tente dar mais detalhes ou responder √†s perguntas dos seus espectadores atrav√©s da fala.</p>
<p>Portanto, com esses tr√™s slides n√≥s temos uma estrutura e um conte√∫do muito mais interessantes para a nossa apresenta√ß√£o, pois estamos contando uma hist√≥ria sobre como vendemos mais em um determinado m√™s.</p>
<p>Perceba que a estrutura da apresenta√ß√£o (1: mensagem principal, 2: onde? , 3: como?) nos ajuda a criar o conte√∫do e essa hist√≥ria de forma coesa. Nas pr√≥ximas se√ß√µes deste artigo, vou discutir duas outras estruturas que podem te ajudar a estruturar e a contar sua hist√≥rias de maneira coesa.</p>
</section>
<section id="sec-historias-tem-estrutura" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Hist√≥rias tem estrutura, use essas estruturas ao seu favor</h1>
<p>Nas pr√≥ximas se√ß√µes, vou mostrar dois exemplos de estruturas bastante comuns em hist√≥rias. Essas estruturas servem como um guia durante a constru√ß√£o de sua hist√≥ria. Elas te ajudam muito a organizar as suas ideias em um formato claro e efetivo.</p>
<section id="o-modelo-dos-quatro-cs" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="o-modelo-dos-quatro-cs"><span class="header-section-number">6.1</span> O modelo dos quatro C‚Äôs</h2>
<p>O modelo dos quatro C‚Äôs se refere a estas quatro palavras:</p>
<blockquote class="blockquote">
<p>Contexto, Conflito, Consequ√™ncia, Conselho.</p>
</blockquote>
<p>Estas quatro palavras, te ajudam a trazer uma estrutura consistente para a sua hist√≥ria. Al√©m disso, essas palavras tamb√©m te ajudam a mexer um pouco com as emo√ß√µes de seus espectadores, e, com isso, capturar mais a aten√ß√£o deles.</p>
<p>Ao seguir esse modelo, sua hist√≥ria vai sempre se dividir em quatro partes: contexto, conflito, consequ√™ncia e conselho. Precisamente nesta ordem. Esse estrutura gira em torno de um problema, ou um conflito principal que voc√™ identificou no neg√≥cio de seu cliente.</p>
<p>O interessante dessa estrutura, √© que voc√™ pode estacar v√°rios problemas em sequ√™ncia. Como resultado, voc√™ tem um bloco de 4 C‚Äôs (contexto, conflito, consequ√™ncia e conselho), seguido de um outro bloco com mais 4 C‚Äôs (contexto, conflito, consequ√™ncia e conselho). Ou tamb√©m, voc√™ pode come√ßar a apresenta√ß√£o por um contexto, e, em seguida, dois blocos de 3 C‚Äôs (conflito, consequ√™ncia e conselho) em sequ√™ncia.</p>
<p>Enfim, chega de papo, e vamos descrever em mais detalhes cada uma das partes dessa estrutura.</p>
<section id="come√ße-por-um-contexto-geral" class="level3" data-number="6.1.1">
<h3 data-number="6.1.1" class="anchored" data-anchor-id="come√ße-por-um-contexto-geral"><span class="header-section-number">6.1.1</span> Come√ße por um contexto geral</h3>
<p>Portanto, ao seguir esse modelo, a sua hist√≥ria vai sempre se iniciar por um contexto geral. Algo apenas para contextualizar o espectador sobre qual √© o estado atual do neg√≥cio.</p>
<p>Lembre-se que, o modelo dos 4 C‚Äôs √© constru√≠do em torno de um conflito, ou de um problema central. Tendo isso em mente, se, por exemplo, o conflito que voc√™ for discutir na sua hist√≥ria, for um problema que afeta o servi√ßo de venda de maquininhas de cart√£o, √© importante que voc√™ foque nessa parte do contexto, em dar um <em>overview</em> sobre o produto ‚Äúmaquininhas de cart√£o‚Äù.</p>
<p>Em outras palavras, evite trazer contextos nesta parte que n√£o est√£o relacionados ao problema/conflito que voc√™ vai apresentar na se√ß√£o seguinte. Pois esse conflito √© a parte central de sua hist√≥ria.</p>
</section>
<section id="apresente-um-conflitoproblemadesafio-a-ser-superado" class="level3" data-number="6.1.2">
<h3 data-number="6.1.2" class="anchored" data-anchor-id="apresente-um-conflitoproblemadesafio-a-ser-superado"><span class="header-section-number">6.1.2</span> Apresente um conflito/problema/desafio a ser superado</h3>
<p>Em seguida, voc√™ deve apresentar um conflito. Isto √©, um problema, um desafio ou uma barreira que voc√™ tenha identificado no produto/servi√ßo que voc√™ est√° analisando. √â aqui que vamos mexer um pouco com a emo√ß√£o do espectador, e usar isso ao nosso favor para capturar a sua aten√ß√£o.</p>
<p>Vamos refletir um pouco sobre isso. Ao colocarmos palavras como ‚Äúproblema‚Äù, ‚Äúcuidado‚Äù, ‚Äúdesafio‚Äù, ‚Äúalerta‚Äù, especialmente em letras garrafais, al√©m de incluir emojis que transmitem esse intuito, como ‚ö†Ô∏è e ‚õî. Isso rapidamente chama a aten√ß√£o de qualquer pessoa, pois te d√° uma sensa√ß√£o de perigo, e voc√™ entra em um estado de alerta.</p>
<p>Se voc√™ refletir mais um pouco sobre isso, voc√™ provavelmente vai perceber que voc√™ tem esse mesmo instinto quando voc√™ est√° assistindo a um filme, ou a uma s√©rie, e o her√≥i dessa hist√≥ria de repente entra em uma situa√ß√£o de perigo. Voc√™ rapidamente presta mais aten√ß√£o no que est√° acontecendo, pois voc√™ quer ver como o her√≥i vai sair dessa enrascada, ou voc√™ est√° torcendo muito para que ele sobreviva e supere esse problema.</p>
<p>Ao apresentarmos um problema sobre o produto/servi√ßo que voc√™ est√° analisando, estamos querendo causar esse mesmo efeito em nossos espectadores. Ao dizermos que temos um desafio/problema que est√° afetando as vendas da empresa, os gerentes rapidamente come√ßam a prestar mais aten√ß√£o no que voc√™ est√° dizendo, pois eles querem saber como eles podem sair dessa enrascada!</p>
</section>
<section id="esconder-os-problemas-√©-uma-p√©ssima-ideia" class="level3" data-number="6.1.3">
<h3 data-number="6.1.3" class="anchored" data-anchor-id="esconder-os-problemas-√©-uma-p√©ssima-ideia"><span class="header-section-number">6.1.3</span> Esconder os problemas √© uma p√©ssima ideia</h3>
<p>Isso √© muito importante! Alguns analistas tem medo ou receio de jogar luz sobre os problemas existentes, e, por isso, acabam escodendo eles ou omitindo de suas apresenta√ß√µes. Por√©m, voc√™ n√£o est√° entregando valor nenhum para o seu cliente dessa forma! Voc√™ n√£o est√° ajudando o seu cliente a resolver os problemas e a crescer o neg√≥cio dele!</p>
<p>E se os problemas n√£o s√£o solucionados, se eles continuam existindo, eles v√£o crescer, e crescer, at√© que eles explodirem, gerando assim um caos generalizado. Em vista disso, quanto mais cedo voc√™ identificar esse problema, avisar os gerentes sobre ele, e apresentar poss√≠veis solu√ß√µes para ele, melhor para os gerentes, que j√° saem com um plano de a√ß√£o para resolver esse problema, e √© melhor para voc√™ tamb√©m, pois estamos entregando valor e solu√ß√µes para o cliente.</p>
<p>Portanto, uma boa apresenta√ß√£o, ou um bom relat√≥rio de dados, √© aquele que entrega valor para o seu cliente! Ao mostrar novas oportunidades de neg√≥cio (e.g.&nbsp;atingir uma nova parcela do p√∫blico com um produto), e tamb√©m, apresentar solu√ß√µes para problemas atuais que est√£o limitando ou impedindo o crescimento do neg√≥cio.</p>
<p>Por√©m, uma apresenta√ß√£o que apenas comenta pontos positivos, que fala que est√° tudo bem‚Ä¶ n√£o traz valor nenhum para os gerentes. Os gerentes n√£o te contrataram para falar que est√° tudo bem. Eles te contrataram para que voc√™ ajude eles a descobrir e solucionar problemas no neg√≥cio deles, atrav√©s da an√°lise de dados.</p>
</section>
<section id="apresente-as-consequ√™ncias-do-conflitoproblemadesafio-que-voc√™-identificou" class="level3" data-number="6.1.4">
<h3 data-number="6.1.4" class="anchored" data-anchor-id="apresente-as-consequ√™ncias-do-conflitoproblemadesafio-que-voc√™-identificou"><span class="header-section-number">6.1.4</span> Apresente as consequ√™ncias do conflito/problema/desafio que voc√™ identificou</h3>
<p>Portanto, ap√≥s apresentar um conflito/problema/desafio que est√° afetando o neg√≥cio para o seu espectador, √© importante que voc√™ apresente logo em seguida a consequ√™ncia desse problema. Isso ajuda os gerentes a terem uma dimens√£o do tamanho que esse problema representa para o neg√≥cio deles.</p>
<p>Tudo bem se voc√™ n√£o conseguir mensurar em n√∫meros o tamanho do impacto que esse conflito gerou no neg√≥cio. Tente medir esse impacto da melhor forma que voc√™ puder. Um valor aproximado do impacto j√° pode trazer bastante clareza sobre o tamanho do perigo que esse conflito representa para o neg√≥cio de seus espectadores.</p>
<p>Voc√™ tamb√©m pode fornecer um <em>range</em>, ou um intervalo poss√≠vel do impacto se voc√™ puder (e.g.&nbsp;o impacto estimado est√° entre R$ 20 mil e R$ 340 mil). Essa tamb√©m √© uma forma v√°lida de expor o tamanho do problema.</p>
<p>Caso for realmente imposs√≠vel de mensurar esse impacto em n√∫meros, ent√£o, explique nesta parte, quais s√£o os pontos do processo de venda do produto/servi√ßo que s√£o afetados por esse problema. Em outras palavras, apresente quais s√£o os lugares do neg√≥cio que est√£o sendo, em teoria, afetados por esse conflito.</p>
</section>
<section id="aconselhe-o-seu-cliente-apresente-poss√≠veis-solu√ß√µes-para-o-problema" class="level3" data-number="6.1.5">
<h3 data-number="6.1.5" class="anchored" data-anchor-id="aconselhe-o-seu-cliente-apresente-poss√≠veis-solu√ß√µes-para-o-problema"><span class="header-section-number">6.1.5</span> Aconselhe o seu cliente, apresente poss√≠veis solu√ß√µes para o problema</h3>
<p>Ok, apresentamos um problema, ou um conflito para os nossos espectadores. Tamb√©m discutimos os impactos desse conflito sobre o neg√≥cio de nosso cliente. Agora, precisamos apresentar poss√≠veis solu√ß√µes para esse problema.</p>
<p>Portanto, entenda o problema/conflito que voc√™ est√° apresentando, e tente listar quais seriam as principais solu√ß√µes para esse problema, e inclua essas solu√ß√µes nesta parte de sua apresenta√ß√£o. Vale a pena explicar e discutir esse problema com outros colegas de trabalho tamb√©m, pois eles tamb√©m podem sugerir solu√ß√µes interessantes que estavam fora de seu radar.</p>
<p>√â interessante tamb√©m incluir uma rela√ß√£o dos <em>trade-offs</em> de cada solu√ß√£o, principalmente em quest√£o de complexidade e esfor√ßo de cada solu√ß√£o. Gerentes est√£o constantemente interessados nessa rela√ß√£o, e querem sempre escolher a solu√ß√£o que seja mais simples e mais r√°pida de ser implementada.</p>
</section>
</section>
<section id="evolu√ß√£o-do-personagem-como-uma-outra-alternativa" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="evolu√ß√£o-do-personagem-como-uma-outra-alternativa"><span class="header-section-number">6.2</span> Evolu√ß√£o do personagem como uma outra alternativa</h2>
<p>A evolu√ß√£o do personagem (ou a ‚Äújornada do her√≥i‚Äù) √© uma estrutura de hist√≥ria bem popular. Voc√™ come√ßa por um personagem, ou, um her√≥i para a hist√≥ria, que no nosso caso aqui, pode ser o neg√≥cio do nosso cliente, ou um produto espec√≠fico dele.</p>
<p>Nossa miss√£o √© mostrar como esse personagem/her√≥i evoluiu nos √∫ltimos meses. Por isso, essa estrutura de evolu√ß√£o √© bastante apropriada para relat√≥rios no final do ano. Pois esses relat√≥rios s√£o interessantes para mostrarmos a evolu√ß√£o do neg√≥cio (ou a evolu√ß√£o do personagem) no √∫ltimo ano.</p>
<section id="o-in√≠cio-e-o-fim-da-jornada" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="o-in√≠cio-e-o-fim-da-jornada"><span class="header-section-number">6.2.1</span> O in√≠cio e o fim da jornada</h3>
<p>Se voc√™ preferir, voc√™ pode come√ßar a sua apresenta√ß√£o apresentando como o seu personagem estava no in√≠cio da jornada, e, terminar essa apresenta√ß√£o mostrando como esse personagem terminou essa jornada.</p>
<p>Essa √© uma op√ß√£o, por√©m, eu prefiro come√ßar a apresenta√ß√£o mostrando o in√≠cio e o fim ao mesmo tempo. Desse modo, os espectadores j√° come√ßam a apresenta√ß√£o tendo uma no√ß√£o do quanto o neg√≥cio evoluiu durante o ano. Portanto, eu come√ßo apresentando como o personagem (ou o neg√≥cio/produto) come√ßou o ano, e, logo em seguida, como ele terminou o ano.</p>
</section>
<section id="apresentando-os-desafios-e-percal√ßos" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="apresentando-os-desafios-e-percal√ßos"><span class="header-section-number">6.2.2</span> Apresentando os desafios e percal√ßos</h3>
<p>Em todo neg√≥cio/produto, qualquer que ele seja, n√≥s sempre enfrentamos grandes desafios que podem amea√ßar o sucesso, ou, limitar a evolu√ß√£o deste neg√≥cio/produto.</p>
<p>Portanto, ao longo de qualquer jornada, n√≥s sempre enfrentamos desafios e percal√ßos, e aplicamos a√ß√µes para tentar superar esses desafios. Ao superar esses desafios, n√≥s podemos com certa esperan√ßa gerar a evolu√ß√£o e melhoria desse neg√≥cio/produto. Isto √©, chegar ao final dessa jornada com um neg√≥cio/produto melhor, mais robusto e mais rent√°vel.</p>
<p>Tudo isso significa que o ‚Äúcomo percorremos o meio da jornada‚Äù pode ser muito mais importante/interessante que o in√≠cio ou o final dessa jornada. Sendo assim, reserve uma parte de sua apresenta√ß√£o para apresentar os principais desafios que enfrentamos durante essa travessia, e como superamos eles.</p>
</section>
<section id="se-poss√≠vel-aproveite-para-valorizar-o-trabalho-de-sua-equipe" class="level3" data-number="6.2.3">
<h3 data-number="6.2.3" class="anchored" data-anchor-id="se-poss√≠vel-aproveite-para-valorizar-o-trabalho-de-sua-equipe"><span class="header-section-number">6.2.3</span> Se poss√≠vel, aproveite para valorizar o trabalho de sua equipe</h3>
<p>Nesse ponto espec√≠fico da apresenta√ß√£o, voc√™ geralmente tem uma oportunidade muito interessante! Pois voc√™ pode, entregar valor ao seu cliente, e, ao mesmo tempo, tamb√©m valorizar o trabalho de sua equipe, especialmente se foi essa a equipe que descobriu os desafios, e, aplicou as a√ß√µes que superaram esses desafios que voc√™ est√° descrevendo.</p>
<p>Isso √© uma oportunidade de ouro! Portanto, se voc√™ tiver essa oportunidade em suas m√£os, aproveite ela! Lembre-se que voc√™ n√£o trabalha sozinho. Voc√™ quase sempre est√° trabalhando dentro de uma equipe de pessoas, e √© sempre importante saber como valorizar o trabalho de seus colegas.</p>
<p>Contudo, essa oportunidade nem sempre vai aparecer para voc√™. Talvez os desafios que voc√™ est√° apresentando, foram superados de outra forma, por uma outra equipe que voc√™ n√£o conhece, ou que n√£o possui conex√£o direta.</p>
</section>
<section id="reforce-os-resultados-alcan√ßados" class="level3" data-number="6.2.4">
<h3 data-number="6.2.4" class="anchored" data-anchor-id="reforce-os-resultados-alcan√ßados"><span class="header-section-number">6.2.4</span> Reforce os resultados alcan√ßados</h3>
<p>Tamb√©m √© √∫til terminar a sua apresenta√ß√£o, mostrando um resumo dos resultados alcan√ßados ao longo do ano. Isto pode ser um <em>bulletpoint</em> simples, resumindo os principais resultados. Isso ajuda a refrescar a mem√≥ria de seus espectadores, mostrando a eles n√£o apenas sobre como terminamos a jornada do ano passado, mas tamb√©m, sobre como n√≥s come√ßamos a jornada do pr√≥ximo ano üòâ.</p>
</section>
<section id="um-resumo-da-estrutura" class="level3" data-number="6.2.5">
<h3 data-number="6.2.5" class="anchored" data-anchor-id="um-resumo-da-estrutura"><span class="header-section-number">6.2.5</span> Um resumo da estrutura</h3>
<p>Portanto, nas se√ß√µes anteriores discutimos uma ideia de estrutura que seria similar √† uma ‚Äúevolu√ß√£o do personagem‚Äù. No final, temos uma hist√≥ria que segue a seguinte sequ√™ncia:</p>
<ul>
<li>apresente rapidamente como come√ßamos e como terminamos a jornada;</li>
<li>apresente os principais desafios que enfrentamos durante o ano;</li>
<li>quais foram as solu√ß√µes que aplicamos para solucionar os problemas;</li>
<li>reforce a evolu√ß√£o do personagem, ao mostrar novamente os resultados atingidos com as solu√ß√µes acima;</li>
</ul>


</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Vale relembrar que os n√∫meros e gr√°ficos apresentados nessa imagem s√£o meramente ilustrativos, e, foram definidos de forma completamente aleat√≥ria.‚Ü©Ô∏é</p></li>
</ol>
</section></div> ]]></description>
  <category>Storytelling</category>
  <category>Data Storytelling</category>
  <category>Data Science</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/pt/</guid>
  <pubDate>Mon, 06 Mar 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-03-06-storytelling/mapa-featured.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Introducing the {ggfunnel} R package</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-02-11-funnel-pkg-v010/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>At my work, I use a lot of funnel charts. Because they are a very effective visualization to see losses trough a sequence of steps in a sales process (or a ‚Äúsales path‚Äù). I usually build these funnel charts in a very popular Microsoft tool called Power BI.</p>
<p>This tool is very popular to build interactive dashboards, and it offers many different native visuals and type of charts to build your visualizations. One visual in particular, is the native funnel chart visual which you can use to visualize your data in a funnel chart, like in the example below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-02-11-funnel-pkg-v010/power-bi.png" class="img-fluid figure-img"></p>
<figcaption>A funnel chart at Power BI</figcaption>
</figure>
</div>
<p>But after working a lot with these charts in Power BI, I tought to myself: ‚Äúcould I make a funnel chart in R?‚Äù. The answer is obviously yes! You could definitely drawn a funnel chart with frameworks such as the <code>ggplot2</code> package. However, there was no packages in the community that could build such visualization out of the box.</p>
<p>So I decided to develop a small and experimental R package that could drawn this type of chart. This is how <code>{ggfunnel}</code> was born. In essence, with <code>{ggfunnel}</code>, you can build Power BI like funnel charts in R. The <code>{ggfunnel}</code> package uses the <code>{ggplot2}</code> package (or, more specifically, the <code>ggplot2::geom_tile()</code> geom) to build the funnel chart.</p>
<p><a href="https://github.com/pedropark99/ggfunnel"> <button type="button" class="btn btn-primary">Official repository</button></a> <a href="https://pedropark99.github.io/ggfunnel/"> <button type="button" class="btn btn-primary">Package website</button></a></p>
</section>
<section id="how-to-get-it" class="level1">
<h1>How to get it ?</h1>
<p>For now, <code>{ggfunnel}</code> is available only at GitHub. You can download and install the package with the <code>devtools::install_github()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">devtools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pedropark99/ggfunnel"</span>)</span></code></pre></div>
</div>
</section>
<section id="a-small-example-of-use" class="level1">
<h1>A small example of use</h1>
<p>The main functionality of the package is at a function called <code>ggfunnel::funnel()</code>, which is responsible for producing the plot. You usually define 3 arguments in this function, which are:</p>
<ul>
<li><code>data</code>: the data.frame with the data you want to use in the plot;</li>
<li><code>values</code>: the column name where are the values you want to display in your funnel chart. In other words, the numerical data that you want to visualize in the chart;</li>
<li><code>levels</code>: the column name with the ‚Äúlevels‚Äù (or the ‚Äúgroups‚Äù) you want to display in your funnel chart. In other words, the categorical data that identifies each level in the funnel;</li>
</ul>
<p>In the example below, we are using the <code>ggfunnel::aggregates</code> data.frame to build a basic funnel chart:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggfunnel)</span>
<span id="cb2-2">ggfunnel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>aggregates</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 √ó 2
  Step  N_users
  &lt;chr&gt;   &lt;dbl&gt;
1 A        4389
2 B        3100
3 C        2005
4 D         500
5 E         120</code></pre>
</div>
</div>
<p>The <code>N_users</code> column is the column with numerical data, so I give it to the <code>values</code> argument of the function. This way, these values will be used to determine the widths of each rectangle in the funnel chart.</p>
<p>In contrast, the <code>Step</code> column contains the categorical data of the dataset. That is why I gave this column to the <code>levels</code> argument of the function. As a result, the values of this column will be used to determine the ‚Äúlevels‚Äù of the funnel chart.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ggfunnel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">funnel</span>(</span>
<span id="cb4-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ggfunnel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>aggregates,</span>
<span id="cb4-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> N_users, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> Step</span>
<span id="cb4-4">  )</span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(plot)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-02-11-funnel-pkg-v010/en/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above plot is very simple. However, since the output of <code>ggfunnel::funnel()</code> is a native <code>ggplot</code> object, you can customize and extend the plot greatly with the <code>{ggplot2}</code> package. I give examples and details on how you can customize this output at the main vignette (<code>vignette("funnel")</code>) of the package, which you can <a href="https://pedropark99.github.io/ggfunnel/articles/funnel.html">read at the website of the package</a>.</p>
<p>Just as a small demonstration, I can add titles to the plot, adjust the theme, and add some notes and arrows to emphasize some parts of the plot. I can also use other packages which extends <code>{ggplot2}</code> to add more custom outputs to the plot, such as the <code>{ggtext}</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ggfunnel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>aggregates <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-2">  ggfunnel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">funnel</span>(</span>
<span id="cb5-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> N_users, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> Step,</span>
<span id="cb5-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text_specs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb5-5">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nudge_x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span>
<span id="cb5-6">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)</span>
<span id="cb5-7">    )</span>
<span id="cb5-8">  )</span>
<span id="cb5-9"></span>
<span id="cb5-10">note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"We lost **75% of the users**&lt;br&gt;from step </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> to step </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">D</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-11"></span>
<span id="cb5-12">plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-13">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb5-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Funnel of users in each step of the sales path"</span>,</span>
<span id="cb5-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The biggest loss of users is at the </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">D</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> step"</span>,</span>
<span id="cb5-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb5-17">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-18">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb5-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>),</span>
<span id="cb5-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plot"</span></span>
<span id="cb5-21">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-22">  ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_richtext</span>(</span>
<span id="cb5-23">    ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>,</span>
<span id="cb5-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> note),</span>
<span id="cb5-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label.color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb5-26">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-27">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(</span>
<span id="cb5-28">    ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.17</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.07</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>), </span>
<span id="cb5-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(</span>
<span id="cb5-30">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)</span>
<span id="cb5-31">    )</span>
<span id="cb5-32">  )</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pedro-faria.netlify.app/posts/2023/2023-02-11-funnel-pkg-v010/en/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="a-simple-but-far-from-perfect-approach" class="level1">
<h1>A simple (but far from perfect) approach</h1>
<p><code>{ggfunnel}</code> is a very simple (and kind of experimental) package, and it is far from perfect. This means that, currently, <code>{ggfunnel}</code> gives you the minimal code necessary to produce a decent funnel chart. But it does not give you much more functionality than that.</p>
<p>It also makes some assumptions about your data that might not hold, and it does not contain some features that you might find at Power BI (e.g.&nbsp;percentage labels).</p>
<p>But, even being a very simple package, <code>ggfunnel::funnel()</code> always returns the raw <code>ggplot</code> object that describes the funnel chart. This means that the package gives you a lot of freedom to customize (or to complement) the output in the way you might need. See <a href="https://pedropark99.github.io/ggfunnel/articles/funnel.html"><code>vignette("funnel")</code></a> for more details on how to customize/complement the <code>ggfunnel::funnel()</code> output.</p>
<p>However, the package needs some work to be a more robust and complete piece of code, for sure. If you think you can make <code>{ggfunnel}</code> better I would be happy to review a PR from you!</p>


</section>

 ]]></description>
  <category>R</category>
  <category>Package</category>
  <category>Power BI</category>
  <category>Funnel charts</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-02-11-funnel-pkg-v010/en/</guid>
  <pubDate>Sat, 11 Feb 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-02-11-funnel-pkg-v010/background-ggfunnel.png" medium="image" type="image/png" height="84" width="144"/>
</item>
<item>
  <title>What I learned from developing my first Python package</title>
  <dc:creator>Pedro Duarte Faria</dc:creator>
  <link>https://pedro-faria.netlify.app/posts/2023/2023-02-06-python-pckg/en/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>In 2022, I developed my first Python package called <a href="https://github.com/pedropark99/spark_map"><code>spark_map</code></a>, and published it at PyPI. If you want to know more about this package üòâ, you can check <a href="https://pedro-faria.netlify.app/posts/2022/2022-12-21-spark-map-v0.2.3/en/">a previous post here</a>, where I introduced the package, and described it‚Äôs main features, and showed a small use case.</p>
<p>Now, although <code>spark_map</code> is a small Python package, I had a hard time developing it. More specifically, the Python code was not hard at all to develop. But packaging it into a proper package üì¶ was hard. In this post, I want to share a few things that I learned about Python package development in this process.</p>
<p>I hope these tips help you in some way üòâ. In summary, the main tips discussed here are:</p>
<ul>
<li><p>Do not change the <code>sys.path</code> or <code>PYTHONPATH</code> variable inside your package ‚ö†Ô∏è;</p></li>
<li><p>Differences between a package and a module;</p></li>
<li><p>Nailing the structure üèõÔ∏è of your package can be one the hardest parts;</p></li>
<li><p>If you use <code>setuptools</code> to build your package, avoid <code>setup.py</code> and use <code>pyproject.toml</code> instead;</p></li>
<li><p>Check if your Python modules are included on the built versions of your package;</p></li>
</ul>
</section>
<section id="before-i-say-anything-some-references" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Before I say anything, some references</h1>
<p>The development of this package involved reading several articles üìì, and doing some practical tests üß™. Here I share some of the best resources I discovered along the way.</p>
<p>First, a great article to start your project is the <a href="https://packaging.python.org/en/latest/tutorials/packaging-projects/">Packaging Python Projects</a> tutorial. This tutorial is written by PyPA, or, the <a href="https://www.pypa.io/en/latest/">Python Packaging Authority</a> team<sup>1</sup>, and it seems to be ‚ÄúThe Place‚Äù to search for best practices on Python package projects.</p>
<p>The PyPA team also have a very detailed documentation about <a href="https://packaging.python.org/en/latest/guides/distributing-packages-using-setuptools/">Packaging and distributing projects</a> with <code>setuptools</code>. This is a more technical, detailed documentation, but, it can be a great resource too.</p>
<p>Another very useful article to learn about the structure of a Python package, and the import process of Python, is the article entitled <a href="https://dev.to/codemouse92/dead-simple-python-project-structure-and-imports-38c6">Dead Simple Python: Project Structure and Imports</a> from Jason C. McDonald.</p>
</section>
<section id="now-lets-dive-in" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Now, let‚Äôs dive in</h1>
<section id="the-search-path-of-python" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="the-search-path-of-python"><span class="header-section-number">3.1</span> The search path of Python</h2>
<p>We usually import a package in Python, by including a <code>import</code> statement at the beginning of our script. For example, to import the <code>pandas</code> package to my Python session, I could do this:</p>
<div id="951ca647" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas</span></code></pre></div>
</div>
<p>When you import a package in Python, the Python interpreter starts a search process üîç through your computer, to find the specific package you called in your script. Every Python package you use must be installed in your machine. Otherwise, Python will never find it, and, as a consequence, you can not use it.</p>
<p>The Python interpreter will always look for the packages you import, inside a set of pre-defined locations of your computer. This pre-defined list is stored inside the <code>sys.path</code> variable <span class="citation" data-cites="pymodule">(Foundation 2023c)</span>. In other words, when you import a package, Python looks for this package inside each one of the directories listed at <code>sys.path</code> variable.</p>
<div id="403756fb" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb2-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(sys.path)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['/usr/lib/python310.zip', '/usr/lib/python3.10', '/usr/lib/python3.10/lib-dynload', '', '/home/pedro-dev/.local/lib/python3.10/site-packages', '/usr/local/lib/python3.10/dist-packages', '/usr/lib/python3/dist-packages']</code></pre>
</div>
</div>
<p>You might also find contents about the <code>PYTHONPATH</code> variable when searching for this subject on the internet. In essence, <code>PYTHONPATH</code> is a environment variable that can contain a complementary list of directories to be added to <code>sys.path</code> <span class="citation" data-cites="pypathvar">(Foundation 2023a)</span>.</p>
<p>As you can imagine, the Python interpreter look into these directories in a sequential manner. That is, Python looks for the package at the first folder. If it does not find the package you called, then, it looks at the second folder. If it does not find the package again, it looks at the third folder. And goes on and on, until it hits the last folder of the list.</p>
<p>If does not find the package you called at this last folder, Python will automatically raise a <code>ModuleNotFoundError</code> error. As you expect, this error means that Python could not find the package you called at any of the directories listed at <code>sys.path</code>.</p>
</section>
<section id="do-not-change-the-sys.path-or-pythonpath-variable" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="do-not-change-the-sys.path-or-pythonpath-variable"><span class="header-section-number">3.2</span> Do not change the <code>sys.path</code> or <code>PYTHONPATH</code> variable ‚ö†Ô∏è</h2>
<p>The <code>sys.path</code> variable is a standard Python list, and, as any other list, can be altered to include other directories that are not currently there. The same goes for the <code>PYTHONPATH</code> variable, which is an environment variable, and can be altered too.</p>
<p>As an example, when you try to import your package, which is stored at folder <code>A</code>, and, you face a <code>ModuleNotFoundError</code> error, you might be tempted to alter <code>PYTHONPATH</code> or <code>sys.path</code>, to add the folder <code>A</code> to this search path of Python. DO NOT DO IT! YOU SHOULD NEVER alter <code>PYTHONPATH</code> or <code>sys.path</code> ‚ö†Ô∏è ! I mean, at least not inside a Python package.</p>
<p>In other words, if at some point inside the source code of your Python package, you execute a code like this:</p>
<div id="c504ad50" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb4-2">sys.path.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./../weird-unknow-folder'</span>)</span></code></pre></div>
</div>
<p>just erase this code! Python packages are made to be used by other peoples, and with a code like this above, you will change the search path of this user. Changing the search path of a user is a bad idea. Because you can accidentaly produce bad and confusing side effects to the user‚Äôs session, which can be hard to debug and solve.</p>
<p>Besides, in the majority of times when you alter the <code>sys.path</code>, you are trying to overcome a bad structure of your files. In other words, you can always avoid altering the <code>sys.path</code> variable by changing the structure of your source files inside your project.</p>
<p>Just to be clear, is a bad idea to alter the <code>sys.path</code> inside the source code of your package. However, it is ok to alter these variables outside of your package.</p>
<p>As a practical example, Apache Spark is written in Scala. But it have a Python API available through the <code>pyspark</code> package. If you look closely into the source code of the project, or, more specifically at the <a href="https://github.com/apache/spark/blob/master/python/run-tests.py"><code>run-tests.py</code></a> file, you can see that new paths (or new directories) are appended to <code>sys.path</code> in this file.</p>
<p>However, this <code>run-tests.py</code> file IS NOT A PART of the <code>pyspark</code> package itself. It is just an auxiliary script (outside of the package) used to support the testing processes of <code>pyspark</code>. This means that <code>run-tests.py</code> contains code that is not intended to be executed by the users of the package, but by the developers of <code>pyspark</code> instead.</p>
</section>
<section id="differences-between-a-package-and-a-module" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="differences-between-a-package-and-a-module"><span class="header-section-number">3.3</span> Differences between a package and a module</h2>
<p>This is a very basic knowledge for a Python developer. However, until recently, I did not know the meaning of these two concepts. So, I will give it to you now, in case you do not have it yet.</p>
<p>A Python module is a single Python file (i.e.&nbsp;a file with extension <code>.py</code>). Every Python script you write, is a Python module. In contrast, a Python package is a set of Python modules gathered together inside a folder. This folder must contain a particular Python module named as <code>__init__.py</code>. This <code>__init__.py</code> is the file that ‚Äúinitialize‚Äù, or, ‚Äúidentifies‚Äù this folder as a Python package <span class="citation" data-cites="pypackages">(Foundation 2023b)</span>.</p>
<p>You can have multiple Python packages inside a Python package. That is, inside the directory of your package, you can have multiple sub-directories with more Python modules and <code>__init__.py</code> files. In this case, these sub-directories become submodules of the package. You can interpret them as sub-packages, if you prefer.</p>
</section>
<section id="structuring-the-package-was-one-of-the-hardest-parts" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="structuring-the-package-was-one-of-the-hardest-parts"><span class="header-section-number">3.4</span> Structuring the package was one of the hardest parts</h2>
<p>Every Python package follows the same basic file/directory structure üèõÔ∏è. In other words, the files that compose a Python package are always structured in a standard way. But, understanding and using this structure effectively was one of the hardest parts for me. At this section, I want to explain this structure for you.</p>
<p>In a Python package project, you usually have these <strong>files</strong>:</p>
<ul>
<li><p><code>LICENSE.md</code> or <code>LICENSE.rst</code> (or both): a text file with the license of your package. It can be a Markdown file (<code>.md</code>), or, a reStructuredText markup file (<code>.rst</code>);</p></li>
<li><p><code>README.md</code>: a Markdown file introducing your package. That is, a file that describes succintly the objective of the package, its main features, and showing a small example of use of the package;</p></li>
<li><p><code>setup.py</code> or <code>pyproject.toml</code> or <code>setup.cfg</code>: these are files used by the build system you choose to build (or compile) your Python package into a compact and shareable format;</p></li>
</ul>
<p>Also, a Python package project usually contains these <strong>folders (or directories)</strong>:</p>
<ul>
<li><code>src/&lt;package-name&gt;/</code> or <code>&lt;package-name&gt;/</code>: inside this directory you store all Python modules of your package, that is, the source code of your package;</li>
<li><code>tests/</code>: inside this directory you store all unit tests of your package. In other words, the scripts and automated workflow used to test your package.</li>
</ul>
<!--
- `doc/` or `docs/`: inside this directory you store all documentation files. That is, files that document your package, describe its contents, functionality and concepts;
-->
<p>You must store the source code (or the python modules) of your package inside a folder with the same name as the package itself (i.e.&nbsp;the <code>&lt;package-name&gt;/</code> folder). So, for a package named <code>spark_map</code> we should keep the source files (i.e.&nbsp;the <code>.py</code> files) of this package inside a folder called <code>spark_map</code>. As a practical example, if you <a href="https://github.com/pandas-dev/pandas/tree/main/pandas">look at the source code</a> of the famous <code>pandas</code> package, you will see that all source code of the package is stored inside a folder called <code>pandas</code>.</p>
<p>In contrast, this <code>&lt;package-name&gt;/</code> folder might be (or might be not) inside another folder called <code>src/</code>, that is, the path to the source code might be <code>src/&lt;package-name&gt;/</code> instead of <code>&lt;package-name&gt;/</code>. The <code>pandas</code> package for example, do not uses the <code>src/</code> folder, so the source code is stored inside the <code>pandas/</code> folder. In contrast, the famous <code>flask</code> package uses the <code>flask/</code> folder inside a <code>src/</code> folder, so the path to the source code becomes <code>src/flask</code>. <a href="https://github.com/pallets/flask/tree/main/src/flask">You can check this by looking at the source code of the package.</a>.</p>
<p>So the folder structure to store the source code of the package might change very slightly from package to package. There is no consensus about which one of these two structures is the best. But in general, the source is always stored inside a folder with the same name as the package (i.e.&nbsp;the <code>&lt;package-name&gt;/</code> folder). And this folder might be stored inside a <code>src/</code> folder.</p>
<p>Furthermore, every project of a Python package usually have one, two, or more files that <strong>control the build process of the package</strong> (like <code>setup.py</code>, <code>pyproject.toml</code> or <code>setup.cfg</code>). In other words, these files are not part of the package itself. But they are used by the <strong>build system</strong> to build (or compile) your package into a compact and shareable format. I talk more about these files at Section&nbsp;3.5.</p>
<p>Having in mind all these files that we described until here, we can build a example of file structure for a package. For example, a possible file strucuture for a package named <code>haven</code> could be:</p>
<pre><code>.
‚îú‚îÄ‚îÄ LICENSE.md
‚îú‚îÄ‚îÄ LICENSE.rst
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ pyproject.toml
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îî‚îÄ‚îÄ haven
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ functions.py
‚îÇ       ‚îú‚îÄ‚îÄ utils.py 
‚îÇ       ‚îî‚îÄ‚îÄ haven.py
‚îÇ
‚îî‚îÄ‚îÄ tests
    ‚îú‚îÄ‚îÄ test_functions.py
    ‚îî‚îÄ‚îÄ test_haven.py</code></pre>
</section>
<section id="sec-build-systems" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="sec-build-systems"><span class="header-section-number">3.5</span> Introducing build systems</h2>
<p>When you are developing a package, you write multiple Python modules that perform all necessary tasks to solve the specific problem you want to solve with your package. However, in order to distribute this package to other peoples, that is, to make it available to the wide public, you need to compile (or build) your package into a compact and shareable format.</p>
<p>This is what a build system does. It compiles all archives of your package into a single and compact file that you can publish at PyPI, and distribute to other peoples. This means that, when a user downloads your package (through <code>pip</code> for example), it downloads this compact and shareable version of your package.</p>
<p>On the day of writing this article, there are four main build systems available on the market for Python packages, which are <code>hatchling</code>, <code>setuptools</code>, <code>flit</code> and <code>PDM</code>. No matter which one you use, just choose one, anyone. Because they do the same thing, and work in a very similar way.</p>
<p>Most of them use various metadata stored at the <code>pyproject.toml</code> file to build your project. The <code>setuptools</code> build system is probably a exception to this rule, because this build system supports other kinds of files to store this metadata, which are <code>setup.py</code> and <code>setup.cfg</code>.</p>
<section id="the-pyproject.toml-file-as-the-commom-ground" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="the-pyproject.toml-file-as-the-commom-ground"><span class="header-section-number">3.5.1</span> The <code>pyproject.toml</code> file as the commom ground</h3>
<p>The <a href="https://peps.python.org/pep-0517/">PEP517</a> and <a href="https://peps.python.org/pep-0518/">PEP518</a> were lauched to stablish the <code>pyproject.toml</code> file as the commom ground to every build system. Basically, the <code>pyproject.toml</code> is a file included at the root level of your project, and contains metadata about your package (e.g.&nbsp;it‚Äôs name, version, license, description, author, dependencies, etc.).</p>
<p>It represents a ‚Äúcommom ground‚Äù because all build systems available can read and use this file to build (or compile) your package. As a consequence, with this file, you can change very easily the build system you use in your package, without having to change various configurantions and files. All you have to do is to change the options under the <code>build-system</code> table.</p>
<p>This <code>build-system</code> table is the part of <code>pyproject.toml</code> file where you can specify options and configurations for the build system. As an example, to use the <code>setuptools</code> build system, you would add these lines to <code>pyproject.toml</code>:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[build-system]</span></span>
<span id="cb6-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"setuptools"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">build-backend</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"setuptools.build_meta"</span></span></code></pre></div>
<p>In the other hand, if you want to use the <code>hatchling</code> build system instead, you would change the above lines to:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[build-system]</span></span>
<span id="cb7-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hatchling"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb7-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">build-backend</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hatchling.build"</span></span></code></pre></div>
<p>Or, maybe you prefer <code>flit</code>:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[build-system]</span></span>
<span id="cb8-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flit_core"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb8-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">build-backend</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flit_core.buildapi"</span></span></code></pre></div>
<p>Anyway, you get it. You use the options <code>requires</code> and <code>build-backend</code> under the <code>build-system</code> table to specificy which system you want to use in the building process of your package. All of these different systems will use <code>pyproject.toml</code> to collect other very important metadata about your package, like these metadata below:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[project]</span></span>
<span id="cb9-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spark_map"</span></span>
<span id="cb9-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">version</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.2.77"</span></span>
<span id="cb9-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">authors</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb9-5">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pedro Faria"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">email</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pedropark99@gmail.com"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> }</span></span>
<span id="cb9-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb9-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">description</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pyspark implementation of `map()` function for spark DataFrames"</span></span>
<span id="cb9-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">readme</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"README.md"</span></span>
<span id="cb9-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires-python</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;=3.7"</span></span>
<span id="cb9-10"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">license</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">file</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LICENSE.txt"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> }</span></span>
<span id="cb9-11"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">classifiers</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb9-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Programming Language :: Python :: 3"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"License :: OSI Approved :: MIT License"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-14">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Operating System :: OS Independent"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb9-16"></span>
<span id="cb9-17"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">dependencies</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb9-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pyspark"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-19">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"setuptools"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-20">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"toml"</span></span>
<span id="cb9-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
</section>
<section id="the-setuptools-build-system" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="the-setuptools-build-system"><span class="header-section-number">3.5.2</span> The <code>setuptools</code> build system</h3>
<p>The <code>setuptools</code> build system is the system that I use to build <code>spark_map</code>. It is kind of a more ‚Äúversatile‚Äù<sup>2</sup> system than the others, only because it supports other kinds of files besides <code>pyproject.toml</code>.</p>
<p>The <code>setup.py</code> file is probably the most ‚Äúfamous‚Äù file, or, the most associable to <code>setuptools</code>. Although this is changing in recent years (more about this at the next section), the <code>setup.py</code> is still considered the traditional way of using the system, as the documentation itself says:</p>
<blockquote class="blockquote">
<p>The traditional <code>setuptools</code> way of packaging Python modules uses a <code>setup()</code> function within the <code>setup.py</code> script. <span class="citation" data-cites="setuptools">(Authority 2023)</span></p>
</blockquote>
<p>In summary, you can replace <code>pyproject.toml</code> with the <code>setup.py</code> file. Just as an example, I could replace the <code>pyproject.toml</code> file for <code>spark_map</code> with a <code>setup.py</code> file similar to the file below. The whole <code>setup.py</code> file is usually composed of just a single call to the <code>setuptools.setup()</code> function, and nothing more. All of the various metadata about the package stored at <code>pyproject.toml</code> are translated to named arguments to this <code>setup()</code> function.</p>
<div id="91ff760d" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># setup.py placed at root directory</span></span>
<span id="cb10-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> setuptools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> setup</span>
<span id="cb10-3">setup(</span>
<span id="cb10-4">    name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'spark_map'</span></span>
<span id="cb10-5">    version <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0.2.77'</span>,</span>
<span id="cb10-6">    author <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pedro Faria'</span>,</span>
<span id="cb10-7">    description <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pyspark implementation of `map()` function for spark DataFrames'</span>,</span>
<span id="cb10-8">    long_description <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'README.md'</span>,</span>
<span id="cb10-9">    license <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> { <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LICENSE.txt"</span> }</span>
<span id="cb10-10">    classifiers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Programming Language :: Python :: 3"</span>,</span>
<span id="cb10-12">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"License :: OSI Approved :: MIT License"</span>,</span>
<span id="cb10-13">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Operating System :: OS Independent"</span>,</span>
<span id="cb10-14">    ],</span>
<span id="cb10-15">    python_requires <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&gt;=3.7'</span>,</span>
<span id="cb10-16">    install_requires <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pyspark'</span>],</span>
<span id="cb10-17">    extras_require <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'setuptools'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'toml'</span>]</span>
<span id="cb10-18">)</span></code></pre></div>
</div>
<p>However, if you use a <code>setup.py</code> file you become kind of locked into the <code>setuptools</code> framework. This one the reasons why many developers prefer to use the <code>pyproject.toml</code> file instead. Because it becomes so much more easy to change between build systems if you want to.</p>
<p>Another ‚Äúclash point‚Äù about the <code>setup.py</code> file is that it changes the way, or the steps (or the worflow) to build the package. The standard or the most supported strategy to build a package, is to use the <code>build</code> module command of Python at the terminal. This command will build your package, no matter which build system you use:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If you are on Windows:</span></span>
<span id="cb11-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">py</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> build</span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If you are on Linux:</span></span>
<span id="cb11-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python3</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> build</span></code></pre></div>
<p>In contrast, when you use the <code>setup.py</code> file, you have to execute directly the script with some additional options, like <code>sdist</code>:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If you are on Windows:</span></span>
<span id="cb12-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">py</span> setup.py sdist</span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If you are on Linux:</span></span>
<span id="cb12-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python3</span> setup.py sdist</span></code></pre></div>
<p>Again, this is bad, because it forces you into a certain framework, or, a certain workflow that is different than the standard way of building a package.</p>
</section>
<section id="avoid-setup.py-and-use-pyproject.toml-instead" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="avoid-setup.py-and-use-pyproject.toml-instead"><span class="header-section-number">3.5.3</span> Avoid <code>setup.py</code> and use <code>pyproject.toml</code> instead</h3>
<p>The Python community understood this problem, and now, executing the <code>setup.py</code> script directly is heavily discouraged <span class="citation" data-cites="ganssle">(Ganssle 2021)</span>. Actually, the <code>setuptools</code> project itself started a movement to migrate it‚Äôs functionality to <code>pyproject.toml</code> and <code>setup.cfg</code> files.</p>
<p>This concern is clearly documented at <a href="https://setuptools.pypa.io/en/latest/userguide/quickstart.html#basic-use">the ‚ÄúQuick Start‚Äù section</a> of the official documentation for the project:</p>
<blockquote class="blockquote">
<p>Setuptools offers first class support for <code>setup.py</code> files as a configuration mechanism ‚Ä¶ It is important to remember, however, that running this file as a script (e.g.&nbsp;<code>python setup.py sdist</code>) is strongly discouraged, and that the majority of the command line interfaces <strong>are (or will be) deprecated</strong> (e.g.&nbsp;<code>python setup.py install</code>, <code>python setup.py bdist_wininst</code>, ‚Ä¶) ‚Ä¶ We also recommend users to expose as much as possible configuration in a more declarative way via the <code>pyproject.toml</code> or <code>setup.cfg</code>, and keep the <code>setup.py</code> minimal with only the dynamic parts (<strong>or even omit it completely if applicable</strong>).</p>
</blockquote>
<p>In resume, avoid using <code>setup.py</code> in your project, and use <code>pyproject.toml</code> instead with the <code>python -m build</code> command. This a much more recommended workflow for building your package.</p>
</section>
</section>
</section>
<section id="one-of-the-hardest-bugs-i-ever-faced-in-my-life" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> One of the hardest bugs I ever faced in my life</h1>
<p>While developing <code>spark_map</code> I encoutered one of the hardest and weirdest bugs I ever faced in my life. Since it was really hard to find this bug, I want to reveal it here to you, and describe how it happens.</p>
<p>First, a little bit of context. This bug was present at the version 0.2.7 of the package, and, you can look at the exact source of this version, by searching for the <a href="https://github.com/pedropark99/spark_map/tree/v0.2.7">git tag <code>v0.2.7</code> at the source code history</a>. At this point, the package was ready to be shipped to PyPI.</p>
<p>I had no problems at building the package. When I executed the command <code>python -m build</code>, the package was built successfully, without any error or warning messages. The source and wheel distributions of the package were there.</p>
<p>I had no problemas at importing the package. I could start a new Python session, and use a <code>import</code> statement to import the package, and that statement would execute flawlessly.</p>
<p>I had no problems at the unit tests of the package. When I executed the command <code>pytest</code> to initiate the unit tests runs, I was passing in all tests. Again, I had no error or warning messages appearing.</p>
<p>Everything seemed to work perfectly. As a consequence, I was ready to publish the package at PyPI, and that is what I did. I published at PyPI. Than, I started to test the package at PyPI.</p>
<p>First, I tried to install the package with <code>pip install spark_map</code>, and everything worked fine at the installation process. The package version was right, and, after the installation process, when I executed the <code>pip list</code> command, I could clearly see <code>spark_map</code> on the list of installed packages.</p>
<p>However, I SIMPLY COULD NOT IMPORT THE PACKAGE! The package was installed succesfully, and with that in mind, I expected to import it succesfully in any Python module, at any location of my computer. However, when I started a new Python session at a random location of my computer, and tried to import the package, the Python interpreter always raised a <code>ModuleNotFoundError</code> error.</p>
<section id="sec-weird-problem" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="sec-weird-problem"><span class="header-section-number">4.1</span> How did this problem occur</h2>
<p>There was no error or warning messages at the building stage of the package, neither in the installation process as well. But something was definitely wrong with the package.</p>
<p>In essence, the source of this weird and confusing problem was at the building stage of the package. Basically, the build system (in that case, the <code>setuptools</code>) was not able to automatically find all source files (i.e.&nbsp;the <code>.py</code> files) of the package. As a result, the build system was building the package, but, not including the source files inside this built version of the package. Very weird! Isn‚Äôt it?</p>
<p>I mean, if the build system did not find any source files‚Ä¶ it should definitely raise a warning or error during the build process. Because this is definitely an error in the process. How or why can you share a Python package, which have no Python source code? If the package does not contain any Python code in it, it is probably not a Python package. Right?</p>
<p>That is why I could not import the package after I installed it on my machine, trough <code>pip</code>. Because the version of the package that was being installed on my machine, was a version of the package that had no Python source code that could be imported. That is why the <code>ModuleNotFoundError</code> error was being raised by the Python interpreter when I tried to import the package.</p>
</section>
<section id="how-to-identify-this-problem" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="how-to-identify-this-problem"><span class="header-section-number">4.2</span> How to identify this problem</h2>
<p>First, when you build your package, usually two main files are created, which are: 1) the <em>wheel</em> distribution of your package; 2) the <em>source</em> distribution of your package. These are just two different formats in which you can ship and share your package with another human.</p>
<p>The source distribution is a TAR file (with <code>.tar</code> or <code>.tar.gz</code> extension). Is just a compressed file (like ZIP files) with all of the essential files that compose your package (i.e.&nbsp;the metadata of the package, the source files - <code>.py</code> files, README and LICENSE files, etc.).</p>
<p>On the other hand, the wheel distribution (files with <code>.whl</code> extension), is ‚Äúpre-compiled‚Äù version of your package. This means that a wheel version of your package comes in a ready-to-install format, and, as a consequence, is much faster to install this version of your package, in comparison to source distributions, which must be compiled before being installed on your system.</p>
<p>To identify if the problem I described at Section&nbsp;4.1 is happening inside your package project, I recommend you to focus your attention on the source distribution of your package (i.e.&nbsp;the TAR file - <code>.tar</code> or <code>.tar.gz</code>). Because you can easily open this kind of file with decompressing tools, like <code>WinRar</code> or <code>7-zip</code>, and it is much more easy to analyze than the wheel distribution.</p>
<p>In resume, if you open the TAR file, and, you do not find any Python modules (i.e.&nbsp;<code>.py</code> files) in it, this means that the problem I described at Section&nbsp;4.1 is unfortunately happening inside your package. In contrast, if you do find all Python modules of your package inside this TAR file, than, you are safe and good to go forward.</p>
<p>To fix this problem inside my package project, I had to add the lines below to my <code>pyproject.toml</code> file. These lines tell <code>setuptools</code> which are the packages available inside the project, and, which is the folder inside the project where all the source code of the package was stored.</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.setuptools]</span></span>
<span id="cb13-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">packages</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spark_map"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb13-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">package-dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"src"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>It was so hard to find this bug, yet, it was quite simple and straightforward to fix it üòë (poker face). With these options, <code>setuptools</code> could finally find all the Python modules of my package, and, as a consequence, include them in the built versions of the package (in the source and in the wheel distributions).</p>
<p>Therefore, if you face a <code>ModuleNotFoundError</code> error when you try to import your package, after you installed it in your computer with <code>pip</code>, I recommend you to check if your Python modules are being included on the built versions of your package.</p>



</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-setuptools" class="csl-entry">
Authority, Python Packaging. 2023. <span>‚ÄúSetuptools Documentation.‚Äù</span> <a href="https://setuptools.pypa.io/en/latest/index.html">https://setuptools.pypa.io/en/latest/index.html</a>.
</div>
<div id="ref-pypathvar" class="csl-entry">
Foundation, Python Software. 2023a. <span>‚ÄúEnvironment Variables.‚Äù</span> <em>Python 3.11.1 Documentation</em>. <a href="https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPATH">https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPATH</a>.
</div>
<div id="ref-pypackages" class="csl-entry">
‚Äî‚Äî‚Äî. 2023b. <span>‚ÄúPackages.‚Äù</span> <em>Python 3.11.1 Documentation</em>. <a href="https://docs.python.org/3/tutorial/modules.html#packages">https://docs.python.org/3/tutorial/modules.html#packages</a>.
</div>
<div id="ref-pymodule" class="csl-entry">
‚Äî‚Äî‚Äî. 2023c. <span>‚ÄúThe Module Search Path.‚Äù</span> <em>Python 3.11.1 Documentation</em>. <a href="https://docs.python.org/3/tutorial/modules.html#the-module-search-path">https://docs.python.org/3/tutorial/modules.html#the-module-search-path</a>.
</div>
<div id="ref-ganssle" class="csl-entry">
Ganssle, Paul. 2021. <span>‚ÄúWhy You Shouldn‚Äôt Invoke Setup.py Directly.‚Äù</span> <a href="https://blog.ganssle.io/articles/2021/10/setup-py-deprecated.html">https://blog.ganssle.io/articles/2021/10/setup-py-deprecated.html</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Probably a bad name for a team. But, that is just my opinion.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>And I mean these quotation marks, because I am not sure to call a system which can be out of the standard as ‚Äúbeing more versatile‚Äù, or not.‚Ü©Ô∏é</p></li>
</ol>
</section></div> ]]></description>
  <category>Python</category>
  <category>Package</category>
  <category>Development workflow</category>
  <guid>https://pedro-faria.netlify.app/posts/2023/2023-02-06-python-pckg/en/</guid>
  <pubDate>Mon, 06 Feb 2023 03:00:00 GMT</pubDate>
  <media:content url="https://pedro-faria.netlify.app/posts/2023/2023-02-06-python-pckg/package.jpg" medium="image" type="image/jpeg"/>
</item>
</channel>
</rss>
