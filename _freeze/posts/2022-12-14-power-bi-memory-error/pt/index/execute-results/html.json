{
  "hash": "ba512c5f69d404292074827e1f2b4ae8",
  "result": {
    "markdown": "---\ntitle: \"Erro de mem√≥ria no Power BI Online? Hora de repensar o seu dashboard\"\ndescription: \"Um erro de mem√≥ria no Power BI Online √© um forte sinal de que voc√™ precisa repensar o design de seu dashboard. Neste post explico que estrat√©gias voc√™ pode adotar para enfrentar esse problema, e quais perguntas s√£o interessantes de serem respondidas\"\ndate: 2022-12-14\ncategories: [\"Power BI\", \"Power BI Online\"]\nimage: './../featured.png'\n---\n\n\n\n# Introdu√ß√£o\n\nEm um dia recente, eu descobri que um dos dashboards que estavam publicados em nosso ambiente de produ√ß√£o do Power BI Online havia sofrido um erro de atualiza√ß√£o. Logo, eu prontamente parei o que estava fazendo e comecei a investigar o motivo do erro, at√© porque: 1) o nosso cliente depende dos dados desse dashboard ; e 2) erros em produ√ß√£o n√£o s√£o legais!\n\nNesse post, eu quero mostrar como esse tipo de erro de atualiza√ß√£o pode ser um forte sinal de que voc√™ precisa repensar o design de seu dashboard. Em outras palavras, vou descrever como voc√™ pode evitar esse tipo erro, ao pensar muito bem em como o design de seu dashboard atende as necessidades de seu cliente.\n\n# Contexto\n\nBem, voc√™ j√° sabe que tudo come√ßou por um erro durante a atualiza√ß√£o de um dashboard publicado no Power BI Online. Por√©m, este n√£o era qualquer erro, e sim, um erro de falta de mem√≥ria:\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Mensagem de erro da atualiza√ß√£o no Power BI Online](../image.png){width=70%}\n:::\n:::\n\n\nPerceba pela mensagem acima, que o motivo do erro foi uma falta de mem√≥ria (*insufficient memory*) nos clusters respons√°veis por executar a atualiza√ß√£o. O que isso significa? Significa que este dashboard estava pedindo por um volume t√£o grande, mas t√£o grande de dados durante a atualiza√ß√£o, que os clusters que estavam executando essa atualiza√ß√£o n√£o tinham mais espa√ßo para alocar esse volume t√£o grande de dados. Por isso, o Power BI decidiu simplesmente parar a atualiza√ß√£o antes que algum computador explodisse üòÖ;\n\n\n## Hora de explorar o terreno desconhecido\n\nNesse dia, eu estava em minha primeira semana em uma nova equipe, e, eu n√£o conhecia esse dashboard. Em outras palavras, eu havia herdado esse dashboard, que foi criado pelos analistas anteriores dessa equipe. Logo, eu precisava abrir o `.pbix` desse dashboard e come√ßar a investigar, tentando descobrir que mist√©rios e perigos est√£o escondidos dentro dele.\n\nInicialmente, percebi oito tabelas associadas ao dashboard que foram puxadas diretamente dos nossos databases SQL (`campanhas`, `cartoes_selecionados`, `usuarios_por_dia`, `formatos`, `inputs`, `usuarios_por_mes`, `perfis` e `tracks`), as quais est√£o expostas na imagem abaixo^[Vale destacar que essas tabelas foram renomeadas com o objetivo de manter o anonimato do cliente e dos dados associados a elas.]. Al√©m delas, temos outras duas tabelas calculadas no pr√≥prio `.pbix`, atrav√©s de DAX (`dCalendario` e `Medidas`).\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Tabelas associadas ao arquivo `.pbix`](../tabelas.png){width=50%}\n:::\n:::\n\n\nDecidi simplesmente clicar no bot√£o de `Atualizar`. J√° que o erro ocorreu durante a atualiza√ß√£o, imaginei que seria mais simples descobrir a fonte do problema dessa forma.\n\nA maioria das tabelas atualizaram rapidamente. Por√©m, a tabela `input` ainda estava atualizando. Em resumo, essa tabela continha todas as mensagens digitadas por todos os usu√°rios que acessaram o nosso sistema. \n\nO tempo foi passando, e ap√≥s 3 horas com a atualiza√ß√£o rodando em meu computador, o Power BI j√° havia puxado mais de 80 milh√µes de linhas para essa √∫nica tabela. Decidi verificar se o recurso de [Atualiza√ß√£o incremental](<https://learn.microsoft.com/pt-br/power-bi/connect-data/incremental-refresh-overview>) estava ligado para essa tabela `input`, e, percebi que ele estava desligado.\n\n\n## Conclus√£o\n\nPortanto, a fonte do problema estava claro. Como o recurso de \"Atualiza√ß√£o incremental\" estava desligado para essa tabela `input`, a cada atualiza√ß√£o, o Power BI Online estava recalculando toda a tabela `input` de uma vez s√≥.\n\nIsso significa que, todos os dias, o Power BI estava coletava todas as **80 milh√µes de linhas** dessa tabela `input`. Devido a este alto volume de dados, o servi√ßo do Power BI decidiu interromper a atualiza√ß√£o.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](../conversa.png){width=70%}\n:::\n:::\n\n\n\n# A solu√ß√£o simples e suja (o famoso *quick and dirty*)\n\nUm jeito simples de resolver esse erro de falta de mem√≥ria, seria simplesmente n√£o carregar todas as 80 milh√µes de linhas de uma vez s√≥! E sim, carregar essas linhas aos poucos. \n\nPara isso, poder√≠amos ligar a atualiza√ß√£o incremental nessa tabela `input`. Desse modo, cada atualiza√ß√£o vai atualizar apenas os dados dos √∫ltimos dias (ao inv√©s de atualizar a tabela inteira), e em seguida, come√ßamos a carregar os dados aos poucos para o dashboard.\n\nPor exemplo, na primeira atualiza√ß√£o, tentamos puxar os dados do primeiro m√™s, depois, na pr√≥xima atualiza√ß√£o, puxamos os dados do segundo m√™s, e assim por diante, at√© puxarmos todas as 80 mih√µes de linhas. Contudo, isso n√£o √© uma solu√ß√£o de fato!\n\n# Antes de tudo, pare um pouco e pense\n\nPrimeiro de tudo, pare! E pense... tente entender o porqu√™ voc√™ est√° puxando milh√µes e milh√µes de linhas. Voc√™ realmente precisa desse volume t√£o grande de dados em seu dashboard? √â muito prov√°vel que n√£o!\n\n> **Insight 1:** Se voc√™ est√° puxando milh√µes e milh√µes de linhas para um dashboard, √© prov√°vel que voc√™ n√£o tenha entendido o que √© um dashboard e qual o seu prop√≥sito.\n\n## Manuten√ß√£o se torna um peso grande\n\nAtualizar 80 milh√µes de linhas **n√£o √© pr√°tico, n√£o √© r√°pido, e √© dif√≠cil de manter e testar**. Se por algum motivo, voc√™ precisar atualizar todos os dados de seu dashboard^[Como exemplo, talvez a fonte dos dados sofreu uma atualiza√ß√£o, e voc√™ quer trazer essa atualiza√ß√£o para o seu dashboard, ou ent√£o, porque houve uma perda de dados no Power BI Online e voc√™ deseja recuperar esses dados perdidos.], voc√™ vai muito provavelmente perder uma tarde, talvez um dia inteiro de trabalho s√≥ para completar a atualiza√ß√£o.\n\n> **Insight 2:** Manter e testar um volume grande de dados em um dashboard √© trabalhoso demais\n\n## Vamos pensar um pouco sobre *user experience*\n\nPor um momento, vamos adotar o papel de um UX, e refletir sobre a experi√™ncia dos usu√°rios que consomem o nosso dashboard. √â esquisito pensar dessa forma, entretanto, √†s vezes, n√≥s nos esquecemos que pessoas de verdade usam o nosso produto (nesse caso, o dashboard) e se baseiam nele diariamente para desempenhar trabalhos e planejamentos importantes. Portanto, √© muito importante que eles tenham uma experi√™ncia agrad√°vel utilizando o nosso dashboard.\n\n- **Definindo o p√∫blico-alvo:** Primeiro, quem utiliza o nosso dashboard?\n\nNa maioria das vezes, quem est√° consumindo os nossos dashboards s√£o **gerentes de alguma √°rea**. Gente importante, que tem pouco tempo no dia, e que lidam com v√°rias tarefas e responsabilidades ao mesmo tempo.\n\n√â justamente por essa escassez de tempo e aten√ß√£o que, em geral, gerentes gostam muito de dashboards. Eles gostam de entrar num dashboard, e rapidamente visualizar todos os indicadores que eles precisam acompanhar. Com isso, este gerente n√£o precisa gastar horas e horas ca√ßando n√∫meros em diferentes lugares, e com diferentes pessoas.\n\nPor isso, um dashboard tem que ser **r√°pido**. Todo gerente tem pressa, ent√£o, a p√°gina inicial do dashboard precisa carregar r√°pido, e navegar pelas diferentes p√°ginas e vis√µes do dashboard tamb√©m precisa ser uma experi√™ncia r√°pida e fl√∫ida. Ningu√©m gosta de uma p√°gina que demora 5 minutos para carregar, muito menos um gerente.\n\n√â por esse mesmo motivo, que cada p√°gina de um dashboard precisa ser focada em um tema central, e manter o m√≠nimo poss√≠vel de informa√ß√£o que o gerente precisa, da forma mais clara poss√≠vel.\n\nSe uma mesma p√°gina mistura diferentes temas, o leitor pode ter dificuldade em navegar pelos indicadores e encontrar o que ele est√° procurando (ou seja, misturar temas = confus√£o mental!).\n\n> Ah! Achei a p√°gina com os indicadores de vendas. Ok. Espera! Por que os indicadores de atendimento est√£o nessa p√°gina? Onde est√° o n√∫mero de vendas de maquininhas nesse m√™s? Ahhh achei! N√£o, espera... Esse √© o n√∫mero de maquininhas vendidas somente no setor de atendimento, mas eu quero os n√∫meros de venda em TODOS os setores...\n\nPortanto, dashboards precisam ser r√°pidos, claros e bem dividos! E se voc√™ est√° puxando um volume muito grande de dados para dentro dele, voc√™ com certeza vai impactar negativamente a rapidez desse dashboard. Al√©m disso, √© poss√≠vel que voc√™ esteja preenchendo esse dashboard com informa√ß√£o que √© irrelevante para o gerente.\n\n> **Insight 3:** Dashboards precisam ser r√°pidos, claros e bem dividos! \n\n\n## Gerentes querem indicadores e agregados! N√£o dados brutos...\n\nGerentes querem acompanhar indicadores e agregados que descrevam de maneira r√°pida a situa√ß√£o atual do neg√≥cio que eles gerem, e das pessoas que est√£o envolvidas nele.\n\nLogo, porque trazer dados brutos para o dashboard? Porque trazer para o dashboard uma tabela com a lista completa de todos os usu√°rios que visitaram o nosso servi√ßo em todos os dias do ano? Se eu posso simplesmente trazer uma tabela j√° agregada, com o n√∫mero de usu√°rios que visitaram o servi√ßo dentro de cada dia.\n\n> **Insight 4:** Gerentes est√£o interessados em acompanhar indicadores e agregados, ao inv√©s de dados brutos. Portanto, importe os seus dados j√° agregados para dentro do dashboard.\n\n\n## Isso significa que dados brutos geralmente n√£o devem estar em um dashboard\n\nIsso tudo n√£o significa que gerentes n√£o consomem dados brutos em momento algum. Mas isso significa que um dashboard √© geralmente o lugar errado para esses dados brutos.\n\n√â at√© comum em certos momentos um gerente pedir para n√≥s coletarmos um conjunto espec√≠fico de dados brutos para ele. Mas se voc√™ refletir sobre todas as ocasi√µes onde isso ocorreu, voc√™ talvez consiga perceber que essas ocasi√µes caem em duas categorias diferentes:\n\n1. o gerente queria investigar um problema bem espec√≠fico, e √© bem prov√°vel que esse problema n√£o se repita, logo, ele nunca mais vai precisar desses dados brutos espec√≠ficos novamente (i.e. foi uma entrega pontual);\n\n2. o gerente precisa desses dados brutos com certa frequ√™ncia para alimentar algum fluxo de trabalho que voc√™ n√£o conhece, ou est√° em uma equipe/setor diferente do seu;\n\nEssas duas categorias n√£o justificam incluir dados brutos em um dashboard. \n\nPortanto, na maior parte do tempo, os gerentes em si n√£o precisam do n√≠vel elevado de detalhes que dados brutos trazem para gerir o seu neg√≥cio. Se eles est√£o pedindo por dados brutos com frequ√™ncia, √© porque algum analista ou membro mais especializado de sua equipe precisa desses dados brutos para desempenhar o seu trabalho. Portanto, porqu√™ n√£o criar rotinas para enviar esses dados brutos para esse membro mais especializado?\n\n\n\n## Dashboards s√£o ferramentas de uso di√°rio\n\n\n> **Insight 5:** Se o usu√°rio de seu dashboard n√£o precisa puxar ou consultar uma informa√ß√£o x com certa frequ√™ncia, √© bem prov√°vel que essa informa√ß√£o x n√£o deveria estar no dashboard.\n\n> **Insight 6:** Dashboards precisam ser est√°veis! Quanto menos erros ele gerar, melhor para voc√™ e tamb√©m para o gerente que utiliza esse dash.\n\n\n## As vezes n√£o existe maneira simples de contornar o problema\n\nEm certas ocasi√µes, os usu√°rios de um dashboard realmente precisam ver algum tipo de dado bruto dentro dele. Nesses casos, voc√™ tra√ßar algumas outras estrat√©gias e perguntas para melhorar a sua situa√ß√£o. Por exemplo:\n\n1. eu posso trazer para dentro dashboard uma parte bastante filtrada dos dados brutos? \n\nOu seja, ao inv√©s de trazer as 80 milh√µes de linhas, ser√° que eu consigo aplicar v√°rios filtros sobre esses dados brutos, antes de import√°-los para dentro do dashboard. Esses filtros podem te ajudar a reduzir drasticamente o n√∫mero de linhas carregadas.\n\n2. ao inv√©s de trazer todos os dados, por que n√£o trazer uma amostra aleat√≥ria da popula√ß√£o?\n\n√â √∫til entender o porqu√™ exatamente o seu usu√°rio precisa ver algum dado bruto em seu dashboard. Ao entender o que esse usu√°rio est√° perseguindo, voc√™ talvez chegue a conclus√£o de que o seu usu√°rio j√° ficaria satisfeito ao ver pelo menos uma parte dos dados brutos (n√£o precisa trazer literalmente tudo). Portanto, selecione uma amostra aleat√≥ria dos dados, e importe apenas essa amostra para dentro do dashboard.\n\n3. ser√° que eu preciso manter o hist√≥rico desses dados brutos dentro do dash? \n\nSer√° que o seu cliente precisa frequentemente visualizar os dados brutos de 6 meses atr√°s? √â muito prov√°vel que n√£o. Ent√£o, por que n√£o manter apenas os dados brutos dos √∫ltimos 30 dias? Em outras palavras, os dados hist√≥ricos s√£o sempre limpos, e apenas os dados brutos mais recentes s√£o mantidos.\n\n\n\n<!-- O que voc√™ trouxe parece que foi uma constru√ß√£o antiga, modelada pra necessidade X, e ela n√£o √© mais a mesma hoje em dia -->\n\n<!-- √â interessante pensar no processo de evolu√ß√£o/revis√£o dos nossos dashs, adequando eles pros usos atuais (coisa que nem sempre a gente consegue üòÖ) -->\n<!-- Viajando um pouco aqui, um dash de atendimento humano pra acompanhar a m√©trica X (abandono, sei l√°).. faz sentido acompanhar essa m√©trica pro resto da vida? Ou vai chegar uma hora que o abandono √© normalizado, e vamos ter alguma outra dor pra investigar, analisar, melhorar, medir? -->\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}